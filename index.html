<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournées Incendie - Gestion des Inspections</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .hotspot {
            position: absolute;
            min-width: 12px;
            min-height: 12px;
            max-width: 50px;
            max-height: 50px;
            /* carré avec coins légèrement arrondis */
            border-radius: 4px;
            border: 2px solid white;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: all 0.2s;
            z-index: 10;
            pointer-events: auto;
        }
        
        .hotspot:hover {
            transform: translate(-50%, -50%) scale(1.15);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        /* couleurs */
        .hotspot.extincteur { background-color: #ef4444; } /* rouge */
        .hotspot.dm { background-color: #f59e0b; } /* jaune */
        .hotspot.sortie { background-color: #10b981; } /* vert */
        
        /* élément complété : bordure verte plus visible */
        .hotspot.completed {
            border-color: #16a34a;
            border-width: 3px;
            box-shadow: 0 0 6px rgba(22,163,74,0.6);
        }
        
        .plan-container {
            position: relative;
            max-width: 100%;
            height: 100%;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
        }
        
        .plan-container.admin-mode {
            max-height: 75vh;
            min-height: 600px;
        }
        
        .plan-image {
            display: block;
            max-width: 100%;
            max-height: 100%;
            height: auto;
            width: auto;
            object-fit: contain;
            /* Force stable dimensions */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        .criteria-grid {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 8px;
            align-items: center;
        }
        
        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem;
            border-radius: 4px;
            text-align: center;
        }
        
        /* Ajout d'un style spécifique pour l'indicateur Bâtiment */
        .kpi-card.batiment {
            background: linear-gradient(135deg, #3b82f6 0%, #4f46e5 100%);
            border: 2px solid #2563eb;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
        }
        
        .admin-element {
            position: absolute;
            min-width: 10px;
            min-height: 10px;
            max-width: 50px;
            max-height: 50px;
            border: 2px solid #fff;
            border-radius: 4px; /* square-ish */
            cursor: move;
            transform: translate(-50%, -50%);
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .admin-element.completed {
            border-color: #16a34a;
            box-shadow: 0 0 6px rgba(22,163,74,0.6);
        }

        /* Resize-by-mouse removed: resizing now only via the element edit dialog */
        .admin-element.resizing { transition: none; opacity: 0.95; }
        
        .admin-element:hover {
            transform: translate(-50%, -50%) scale(1.15);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .admin-element:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.05);
        }
        
        .admin-element.extincteur { background: #ef4444; }
        .admin-element.dm { background: #f59e0b; }
        .admin-element.sortie { background: #10b981; }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Collapsible left panel */
        .left-panel {
            transition: width 0.25s ease;
            min-width: 56px; /* allow compact collapsed state */
            position: relative;
        }
        .left-panel.collapsed {
            width: 56px !important; /* collapsed width */
            overflow: visible;
        }
        .left-panel .panel-details {
            transition: opacity 0.2s ease, visibility 0.2s;
        }
        .left-panel.collapsed .panel-details {
            opacity: 0;
            visibility: hidden;
            height: 0;
            pointer-events: none;
        }
        .left-panel .collapse-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: transparent;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .left-panel .collapse-strip {
            display: none;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            font-weight: 600;
            font-size: 12px;
            color: #374151;
            position: absolute;
            left: 8px;
            top: 50%;
            transform-origin: left center;
            transform: translateY(-50%) rotate(-90deg);
        }
        .left-panel.collapsed .collapse-strip {
            display: block;
        }
    </style>
</head>
<body class="h-full bg-gray-50">
    <div id="app" class="h-full flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b px-6 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Tournées Incendie</h1>
                <div class="flex gap-4">
                    <select id="campaignSelect" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="2025Q1">2025 Q1</option>
                        <option value="2025Q2">2025 Q2</option>
                        <option value="2025Q3">2025 Q3</option>
                        <option value="2025Q4" selected>2025 Q4</option>
                    </select>
                    <button id="adminModeBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                        Mode Admin
                    </button>
                    <button id="nonConformitesBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        Non-Conformités
                    </button>
                    <button id="exportBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Exporter
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Left Panel: KPIs only (modified to be collapsible) -->
            <div id="leftPanel" class="left-panel w-72 bg-white border-r flex flex-col">
                <div class="p-3 border-b flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="leftPanelToggleBtn" class="collapse-toggle" title="Réduire / Développer">
                            <svg id="leftPanelIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M6 4a1 1 0 011 1v10a1 1 0 11-2 0V5a1 1 0 011-1zM10 4a1 1 0 011 1v10a1 1 0 11-2 0V5a1 1 0 011-1zM14 4a1 1 0 011 1v10a1 1 0 11-2 0V5a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div class="collapse-strip" id="leftPanelStrip">Zone</div>
                    </div>
                    <div class="text-sm font-semibold text-gray-700" id="leftPanelZoneLabel">Zone Sélectionnée</div>
                </div>
                <div class="panel-details flex flex-col flex-1">
                    <!-- Zone Selection Dropdown -->
                    <div class="p-4 border-b">
                        <h2 class="text-lg font-semibold mb-3">Zone Sélectionnée</h2>
                        <select id="zoneSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Sélectionnez une zone...</option>
                            <!-- Options will be populated here -->
                        </select>
                        <div class="mt-3 text-sm">
                            <div class="font-medium mb-1">Filtrer par catégorie</div>
                            <div id="categoryFilter" class="flex gap-2 flex-wrap">
                                <label class="inline-flex items-center"><input type="checkbox" value="MR" onchange="renderZoneList()" class="mr-1">MR</label>
                                <label class="inline-flex items-center"><input type="checkbox" value="PRM" onchange="renderZoneList()" class="mr-1">PRM</label>
                                <label class="inline-flex items-center"><input type="checkbox" value="SC" onchange="renderZoneList()" class="mr-1">SC</label>
                                <label class="inline-flex items-center"><input type="checkbox" value="Administratif" onchange="renderZoneList()" class="mr-1">Administratif</label>
                            </div>
                        </div>

                        <!-- Sort UI removed as requested; zones are displayed sorted by name A→Z -->
                        <label class="flex items-center mt-2">
                            <input type="checkbox" id="filterNonCompliant" onchange="renderZoneList(); if (currentZone) addHotspots();" class="mr-2">
                            <span class="text-sm">Afficher seulement les zones non conformes</span>
                        </label>
                    </div>

                    <!-- KPIs -->
                    <div class="p-1 flex-1">
                        <h2 class="text-base font-semibold mb-2">Indicateurs</h2>
                        <div class="space-y-1">
                            <div class="kpi-card">
                                <div class="text-lg font-bold" id="kpiExtincteurs">0%</div>
                                <div class="text-xs opacity-90">Extincteurs</div>
                            </div>
                            <div class="kpi-card">
                                <div class="text-lg font-bold" id="kpiDM">0%</div>
                                <div class="text-xs opacity-90">Déclencheurs Manuels</div>
                            </div>
                            <div class="kpi-card">
                                <div class="text-lg font-bold" id="kpiSorties">0%</div>
                                <div class="text-xs opacity-90">Sorties de Secours</div>
                            </div>
                            <!-- Indicateur Bâtiment pour la checklist zone -->
                            <div class="kpi-card batiment">
                                <div class="text-lg font-bold" id="kpiBatiment">0%</div>
                                <div class="text-xs opacity-90">Bâtiment</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Panel: Plan -->
            <div class="flex-1 p-4 flex flex-col min-w-0">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg font-semibold" id="currentZoneName">Sélectionnez une zone</h2>
                        <select id="floorSelect" class="px-2 py-1 border border-gray-300 rounded-md text-sm hidden"></select>
                    </div>
                    <button id="zoneChecklistBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 hidden">
                        Checklist Zone
                    </button>
                </div>
                <div class="flex-1 flex items-center justify-center min-h-0">
                    <div id="planContainer" class="plan-container hidden w-full">
                        <img id="planImage" class="plan-image w-full h-auto" alt="Plan de la zone">
                        <!-- Hotspots will be added here -->
                    </div>
                    <div id="noZoneMessage" class="text-gray-500 text-center">
                        <div class="text-6xl mb-4">🏢</div>
                        <p>Sélectionnez une zone pour afficher son plan</p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Notation -->
            <div class="w-96 bg-white border-l p-4 hidden" id="notationPanel">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">Notation</h2>
                    <button id="notationCloseBtn" class="text-sm text-gray-600 px-2 py-1 rounded hover:bg-gray-100">Fermer</button>
                </div>
                <div id="notationContent" class="text-gray-500 text-center">
                    <div class="text-4xl mb-2">📝</div>
                    <p>Cliquez sur un élément du plan pour le noter</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Mode -->
    <div id="adminMode" class="hidden h-full bg-gray-50">
        <header class="bg-white shadow-sm border-b px-6 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Mode Administration</h1>
                <button id="exitAdminBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                    Retour
                </button>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <!-- Admin Left Panel -->
            <div class="w-80 bg-white border-r p-4">
                <div class="space-y-4">
                    <button id="createZoneBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Créer une Zone
                    </button>
                    <button id="importZoneBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Importer Zone
                    </button>
                    <button id="exportLibraryBtn" class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                        Exporter Librairie
                    </button>
                </div>

                <div class="mt-6">
                    <h3 class="font-semibold mb-3">Zones Existantes</h3>
                    <div id="adminZoneList" class="space-y-2">
                        <!-- Admin zone list -->
                    </div>
                </div>
            </div>

            <!-- Admin Center Panel -->
            <div class="flex-1 p-4">
                <div id="adminContent" class="text-center text-gray-500">
        <!-- Modals will be inserted here -->

        <script>
            // Application State
            let currentCampaign = '2025Q4';
            let currentZone = null;
            let currentFloor = null; // newly selected floor within currentZone
            let currentElement = null;
            let zones = [];
            let inspections = [];
            let isAdminMode = false;

            // Criteria definitions
            const CRITERIA = {
                extincteur: {
                    'acces_degage': 'Accès dégagé',
                    'etat': 'État',
                    'fixation': 'Fixation',
                    'goupille': 'Goupille',
                    'entretien': 'Entretien',
                    'cinq_s': '5S'
                },
                sortie: {
                    'acces_degage': 'Accès dégagé',
                    'signaletique': 'Signalétique',
                    'barre_antipanique': 'Barre antipanique'
                },
                dm: {
                    'etat': 'État',
                    'accessibilite': 'Accessibilité'
                }
            };

            const ZONE_CRITERIA = {
                'ria': {
                    'acces': 'Accès',
                    'etat': 'État',
                    'entretien_annuel': 'Entretien annuel'
                },
                'poteaux': {
                    'acces': 'Accès',
                    'etat': 'État'
                },
                'desenfumage': {
                    'acces': 'Accès',
                    'etat': 'État',
                    'entretien_annuel': 'Entretien annuel'
                },
                'circulation_issues': {
                    'acces': 'Accès',
                    'barre_antipanique': 'Barre antipanique'
                },
                'eclairage': {
                    'veilleuse': 'Veilleuse',
                    'sati_voyant': 'SATI (voyant)',
                    'voyant_test_vert': 'Voyant test vert'
                },
                'consignes_plans': {
                    'affichage': 'Affichage',
                    'maj': 'MAJ',
                    'lisible': 'Lisible'
                },
                'gf_sf': {
                    'brassards': 'Brassards',
                    'liste_agents': 'Liste agents'
                },
                'chargeurs': {
                    'plomb': 'Plomb',
                    'lithium': 'Lithium',
                    'affichage_prevention': 'Affichage prévention',
                    'extincteur_adapte': 'Extincteur adapté'
                },
                'agent_sait': {
                    'q1_appuyer_dm': 'Q1 Appuyer DM',
                    'q2_appeler_poste': 'Q2 Appeler poste',
                    'q3_attaquer_si_possible': 'Q3 Attaquer si possible',
                    'q4_evacuer': 'Q4 Évacuer'
                }
            };

            // Add updateKPIs function
            function updateKPIs() {
                // si pas de zone sélectionnée, remettre tout à zéro
                if (!currentZone) {
                    const reset = id => { const el = document.getElementById(id); if (el) el.textContent = '0%'; };
                    reset('kpiExtincteurs');
                    reset('kpiDM');
                    reset('kpiSorties');
                    reset('kpiBatiment');
                    return;
                }

                // KPI par type d'éléments
                // use current floor elements when available
                const floorElements = currentFloor?.elements || { extincteurs: [], dm: [], sorties: [] };
                const criteriaTypes = {
                    'extincteur': floorElements.extincteurs || [],
                    'dm': floorElements.dm || [],
                    'sortie': floorElements.sorties || []
                };

                Object.entries(criteriaTypes).forEach(([type, elements]) => {
                    const total = elements.length;
                    const elementId = `kpi${type === 'sortie' ? 'Sorties' : type === 'extincteur' ? 'Extincteurs' : 'DM'}`;
                    const el = document.getElementById(elementId);
                    if (!el) return;

                    if (total === 0) {
                        el.textContent = 'N/A';
                        return;
                    }

                    let completed = 0;
                    elements.forEach(item => {
                        const insp = getElementInspection(type, item);
                        if (insp && isElementCompleted(insp)) completed++;
                    });

                    el.textContent = `${Math.round((completed / total) * 100)}%`;
                });

                // KPI Bâtiment -> basé sur la checklist zone
                const batimentEl = document.getElementById('kpiBatiment');
                if (!batimentEl) return;

                const zoneInspection = getZoneInspection(); // peut être undefined
                // rassembler toutes les clés activées (format section_key)
                const enabledZoneKeys = [];
                Object.entries(ZONE_CRITERIA).forEach(([section]) => {
                    const enabled = currentZone.enabledCriteria?.zone?.[section] || [];
                    enabled.forEach(key => enabledZoneKeys.push(`${section}_${key}`));
                });

                const totalZoneCriteria = enabledZoneKeys.length;
                if (totalZoneCriteria === 0) {
                    batimentEl.textContent = 'N/A';
                    return;
                }

                let completedZoneCriteria = 0;
                if (zoneInspection && zoneInspection.criteria) {
                    enabledZoneKeys.forEach(fullKey => {
                        if (zoneInspection.criteria[fullKey] && zoneInspection.criteria[fullKey] !== '') {
                            completedZoneCriteria++;
                        }
                    });
                }

                const pct = Math.round((completedZoneCriteria / totalZoneCriteria) * 100);
                batimentEl.textContent = `${pct}%`;
            }

            // Clean up event listeners setup and remove duplicate toggleLeftPanel
            function setupEventListeners() {
                // Campaign select
                const campaignSelect = document.getElementById('campaignSelect');
                if (campaignSelect) campaignSelect.addEventListener('change', e => {
                    currentCampaign = e.target.value;
                    // Update KPIs and visual state for the selected campaign
                    updateKPIs();
                    // Recreate hotspots so their 'completed' (green) state reflects the new campaign's inspections
                    try { addHotspots(); } catch (err) { console.debug('addHotspots error on campaign change', err); }
                    // Update admin elements completion state if admin UI is visible
                    try { renderAdminElements(); } catch (err) { console.debug('renderAdminElements error on campaign change', err); }
                    // Update non-conformities view if open
                    try { updateNonConformitiesView(); } catch (err) { /* ignore if modal not open */ }
                });

                // Zone select
                const zoneSelect = document.getElementById('zoneSelect');
                if (zoneSelect) zoneSelect.addEventListener('change', e => {
                    if (e.target.value) {
                        selectZone(e.target.value);
                    } else {
                        currentZone = null;
                        document.getElementById('currentZoneName').textContent = 'Sélectionnez une zone';
                        document.getElementById('zoneChecklistBtn').classList.add('hidden');
                        document.getElementById('planContainer').classList.add('hidden');
                        document.getElementById('noZoneMessage').classList.remove('hidden');
                        updateKPIs();
                    }
                });

                // Admin mode toggle
                const adminModeBtn = document.getElementById('adminModeBtn');
                if (adminModeBtn) adminModeBtn.addEventListener('click', () => toggleAdminMode(true));

                // Export button
                const exportBtn = document.getElementById('exportBtn');
                if (exportBtn) exportBtn.addEventListener('click', showExportModal);

                // Non-Conformités button
                const nonConformitesBtn = document.getElementById('nonConformitesBtn');
                if (nonConformitesBtn) nonConformitesBtn.addEventListener('click', showNonConformitiesModal);

                // Zone checklist button
                const zoneChecklistBtn = document.getElementById('zoneChecklistBtn');
                if (zoneChecklistBtn) zoneChecklistBtn.addEventListener('click', showZoneChecklist);

                // Notation panel close button
                const notationCloseBtn = document.getElementById('notationCloseBtn');
                if (notationCloseBtn) notationCloseBtn.addEventListener('click', closeNotationPanel);

                // Left panel toggle
                const leftPanelToggleBtn = document.getElementById('leftPanelToggleBtn');
                if (leftPanelToggleBtn) leftPanelToggleBtn.addEventListener('click', toggleLeftPanel);
            }

            // Initialize application
            async function init() {
                await loadData();
                setupEventListeners();
                setupRepositionObserver(); // Configurer l'observateur de repositionnement
                renderZoneList();
                updateKPIs();
                applyLeftPanelState(); // apply saved collapsed state
                // Force un repositionnement initial après un court délai
                setTimeout(() => scheduleReposition(200), 500);
            }

            // Load data from localStorage. When the app is served over HTTP(S) (for example
            // via GitHub Pages) try to load `TICP.json` from the repository by default so
            // every user sees the pre-created zones.
            async function loadData() {
                const savedZones = localStorage.getItem('fireInspection_zones');
                const savedInspections = localStorage.getItem('fireInspection_inspections');

                if (savedZones) {
                    try {
                        zones = JSON.parse(savedZones);
                    } catch (e) {
                        console.error('Erreur parsing savedZones from localStorage, ignoring savedZones', e);
                        zones = [];
                    }
                }

                // Data migration: convert legacy zone.plan + zone.elements into zone.floors
                if (Array.isArray(zones) && zones.length > 0) {
                    zones = zones.map(z => {
                        if (!z.floors && (z.plan || z.elements)) {
                            const floor = {
                                id: z.defaultFloorId || 'RDC',
                                name: z.defaultFloorName || 'Rez-de-chaussée',
                                plan: z.plan || { imageUrl: '', naturalWidth: z.plan?.naturalWidth || 800, naturalHeight: z.plan?.naturalHeight || 600 },
                                elements: z.elements || { extincteurs: [], dm: [], sorties: [] }
                            };
                            z.floors = [floor];
                            // keep legacy fields for backward inspection if needed, but remove to avoid confusion
                            delete z.plan;
                            delete z.elements;
                        }
                        return z;
                    });
                    // persist migration result
                    saveZones();
                }

                // If no saved zones, and we're served over HTTP(S), try to fetch TICP.json
                if ((!zones || zones.length === 0) && window.location && /^https?:/.test(window.location.protocol)) {
                    const candidates = [
                        'TICP.json',
                        './TICP.json',
                        './data/TICP.json'
                    ];

                    for (const path of candidates) {
                        try {
                            console.info('Attempting to fetch zones from', path);
                            const resp = await fetch(path);
                            if (!resp.ok) {
                                console.debug('Fetch returned non-ok for', path, resp.status);
                                continue;
                            }
                            const json = await resp.json();

                            if (Array.isArray(json)) {
                                zones = json;
                            } else if (json && Array.isArray(json.zones)) {
                                zones = json.zones;
                            } else if (json && (json.id || json.name)) {
                                zones = [json];
                            } else {
                                console.debug('Fetched JSON from', path, 'did not match expected shape');
                                continue;
                            }

                            console.info('Zones loaded from', path);
                            // persist to localStorage so users get the same view locally
                            saveZones();
                            break;
                        } catch (err) {
                            console.debug('Failed to fetch', path, err);
                        }
                    }
                }

                // If still empty, fall back to the embedded default
                if (!zones || zones.length === 0) {
                    zones = [{
                        id: 'AT14',
                        name: 'AT14',
                        floors: [
                            {
                                id: 'RDC',
                                name: 'Rez-de-chaussée',
                                plan: {
                                    imageUrl: 'data:image/svg+xml;base64,' + btoa(`
                                        <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                                            <rect width="800" height="600" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2"/>
                                            <rect x="50" y="50" width="700" height="500" fill="#e9ecef" stroke="#6c757d" stroke-width="1"/>
                                            <text x="400" y="300" text-anchor="middle" font-family="Arial" font-size="24" fill="#495057">Plan d'exemple - AT14 (RDC)</text>
                                        </svg>
                                    `),
                                    naturalWidth: 800,
                                    naturalHeight: 600
                                },
                                elements: {
                                    extincteurs: [
                                        { id: 'EXT-001', type: 'Poudre', x: 0.2, y: 0.3, size: 0.03 },
                                        { id: 'EXT-002', type: 'CO2', x: 0.8, y: 0.3, size: 0.03 }
                                    ],
                                    dm: [
                                        { id: 'DM-001', x: 0.1, y: 0.7, size: 0.025 },
                                        { id: 'DM-002', x: 0.9, y: 0.7, size: 0.025 }
                                    ],
                                    sorties: [
                                        { x: 0.5, y: 0.1, size: 0.035 },
                                        { x: 0.5, y: 0.9, size: 0.035 }
                                    ]
                                }
                            },
                            {
                                id: '1',
                                name: '1er étage',
                                plan: {
                                    imageUrl: 'data:image/svg+xml;base64,' + btoa(`
                                        <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                                            <rect width="800" height="600" fill="#fff7ed" stroke="#fde68a" stroke-width="2"/>
                                            <text x="400" y="300" text-anchor="middle" font-family="Arial" font-size="24" fill="#92400e">Plan d'exemple - AT14 (1er)</text>
                                        </svg>
                                    `),
                                    naturalWidth: 800,
                                    naturalHeight: 600
                                },
                                elements: {
                                    extincteurs: [
                                        { id: 'EXT-101', type: 'Eau', x: 0.4, y: 0.5, size: 0.03 }
                                    ],
                                    dm: [],
                                    sorties: []
                                }
                            }
                        ],
                        enabledCriteria: {
                            extincteur: Object.keys(CRITERIA.extincteur),
                            dm: Object.keys(CRITERIA.dm),
                            sortie: Object.keys(CRITERIA.sortie),
                            zone: Object.keys(ZONE_CRITERIA).reduce((acc, section) => {
                                acc[section] = Object.keys(ZONE_CRITERIA[section]);
                                return acc;
                            }, {})
                        }
                    }];
                    saveZones();
                }

                if (savedInspections) {
                    try {
                        inspections = JSON.parse(savedInspections);
                    } catch (e) {
                        console.error('Erreur parsing savedInspections from localStorage', e);
                        inspections = [];
                    }
                }
            }

            // Save data to localStorage (robuste face au quota)
            function isQuotaExceeded(e) {
                return e && (e.code === 22 || e.code === 1014 || e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED');
            }

            // Supprime toutes les photos d'inspections pour libérer de l'espace
            function removeAllInspectionPhotos() {
                let removed = 0;
                inspections.forEach(ins => {
                    if (ins.photos && ins.photos.length) {
                        removed += ins.photos.length;
                        ins.photos = [];
                    }
                });
                return removed;
            }

            // Tentatives de sauvegarde avec strategies si quota dépassé
            function saveZones() {
                try {
                    localStorage.setItem('fireInspection_zones', JSON.stringify(zones));
                } catch (err) {
                    if (isQuotaExceeded(err)) {
                        // 1) tenter de libérer en supprimant photos d'inspection
                        const removedPhotos = removeAllInspectionPhotos();
                        try {
                            localStorage.setItem('fireInspection_inspections', JSON.stringify(inspections));
                            localStorage.setItem('fireInspection_zones', JSON.stringify(zones));
                            alert(`Espace local saturé : ${removedPhotos} photo(s) d'inspection ont été supprimées pour libérer de l'espace.`);
                            return;
                        } catch (err2) {
                            // 2) retirer les plans volumineux (en dernier recours)
                            const threshold = 200 * 1024; // ~200KB
                            let removedPlans = 0;
                            zones.forEach(z => {
                                if (z.plan && z.plan.imageUrl && z.plan.imageUrl.length > threshold) {
                                    z.plan._backupImage = z.plan.imageUrl; // mémoire temporaire (non persistée)
                                    z.plan.imageUrl = '';
                                    removedPlans++;
                                }
                            });
                            try {
                                localStorage.setItem('fireInspection_inspections', JSON.stringify(inspections));
                                localStorage.setItem('fireInspection_zones', JSON.stringify(zones));
                                alert(`Espace local très limité : ${removedPlans} image(s) de plan ont été retirées pour permettre la sauvegarde.`);
                                return;
                            } catch (err3) {
                                console.error('saveZones failed after cleanup', err3);
                                alert('Impossible de sauvegarder les zones : espace de stockage local insuffisant.');
                            }
                        }
                    } else {
                        console.error('saveZones unexpected error', err);
                        throw err;
                    }
                }
            }

            function saveInspections() {
                try {
                    localStorage.setItem('fireInspection_inspections', JSON.stringify(inspections));
                } catch (err) {
                    if (isQuotaExceeded(err)) {
                        const removedPhotos = removeAllInspectionPhotos();
                        try {
                            localStorage.setItem('fireInspection_inspections', JSON.stringify(inspections));
                            alert(`Espace local saturé : ${removedPhotos} photo(s) d'inspection ont été supprimées pour libérer de l'espace.`);
                        } catch (err2) {
                            console.error('saveInspections failed after cleanup', err2);
                            alert('Impossible de sauvegarder les inspections : espace de stockage local insuffisant.');
                        }
                    } else {
                        console.error('saveInspections unexpected error', err);
                        throw err;
                    }
                }
            }

            // Compression / redimensionnement des images DataURL pour stocker dans localStorage
            function compressImage(dataUrl, maxWidth = 1600, quality = 0.75) {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Exporter en JPEG réduit la taille généralement
                        const compressed = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressed);
                    };
                    img.onerror = () => resolve(dataUrl);
                    img.src = dataUrl;
                });
            }

            // --- Ajout : utilitaires de positionnement et recalcul systématique ---
    
    function positionElement(el, xPercent, yPercent, isAdminMode = false) {
        const planImageId = isAdminMode ? 'adminPlanImage' : 'planImage';
        const planImage = document.getElementById(planImageId);
        
        if (!planImage) {
            return;
        }
        
        // Calcul des dimensions et position
        const imageRect = planImage.getBoundingClientRect();
        const imageParent = planImage.parentElement;
        
        // Si l'image n'a pas encore de dimensions, utiliser le positionnement de base
        if (imageRect.width === 0 || imageRect.height === 0 || !imageParent) {
            el.style.position = 'absolute';
            el.style.left = `${xPercent * 100}%`;
            el.style.top = `${yPercent * 100}%`;
            el.style.transform = 'translate(-50%, -50%)';
            return;
        }
        
        const parentRect = imageParent.getBoundingClientRect();
        
        // Position de l'image dans le parent
        const relLeft = imageRect.left - parentRect.left;
        const relTop = imageRect.top - parentRect.top;
        
        // Position absolue de l'élément en pixels
        const leftPx = relLeft + (xPercent * imageRect.width);
        const topPx = relTop + (yPercent * imageRect.height);

        el.style.position = 'absolute';
        el.style.left = `${leftPx}px`;
        el.style.top = `${topPx}px`;

        // NOUVELLE APPROCHE SIMPLE:
        // La taille est calculée UNE SEULE FOIS à la création de l'élément
        // et stockée en pixels dans dataset.calculatedSize
        // Elle n'est JAMAIS recalculée lors des repositionnements
        
        // Si la taille calculée n'existe pas, la calculer maintenant
        if (!el.dataset.calculatedSize) {
            const naturalWidth = planImage.naturalWidth || 800;
            const displayWidth = imageRect.width;
            const scale = displayWidth / naturalWidth;
            
            const size = parseFloat(el.dataset.size);
            let px;
            
            if (!isNaN(size) && size > 0) {
                // Calculer la taille en pixels basée sur la largeur naturelle
                const naturalSizePx = size * naturalWidth;
                const displaySizePx = naturalSizePx * scale;
                px = Math.max(10, Math.min(50, Math.round(displaySizePx)));
            } else {
                // Taille par défaut: 2.5% de la largeur naturelle
                const defaultNaturalPx = naturalWidth * 0.025;
                const defaultDisplayPx = defaultNaturalPx * scale;
                px = Math.max(14, Math.min(28, Math.round(defaultDisplayPx)));
            }
            
            // MÉMORISER la taille calculée
            el.dataset.calculatedSize = px;
        }
        
        // Appliquer la taille mémorisée (jamais recalculée)
        const px = parseInt(el.dataset.calculatedSize, 10);
        el.style.width = px + 'px';
        el.style.height = px + 'px';
        
        // Centrage
        el.style.transform = 'translate(-50%, -50%)';
    }

    function repositionHotspots() {
        // Reposition hotspots en mode normal (sans jamais recalculer la taille)
        document.querySelectorAll('#planContainer .hotspot').forEach(h => {
            const x = parseFloat(h.dataset.x);
            const y = parseFloat(h.dataset.y);
            if (!isNaN(x) && !isNaN(y)) {
                positionElement(h, x, y, false);
            }
        });
        
        // Reposition admin-elements en mode admin (sans jamais recalculer la taille)
        document.querySelectorAll('.plan-container.admin-mode .admin-element, #adminElements .admin-element').forEach(a => {
            const x = parseFloat(a.dataset.x);
            const y = parseFloat(a.dataset.y);
            if (!isNaN(x) && !isNaN(y)) {
                positionElement(a, x, y, true);
            }
        });
    }

    let _repositionTimer = null;
    function scheduleReposition(delay = 200) {
        if (_repositionTimer) clearTimeout(_repositionTimer);
        _repositionTimer = setTimeout(() => {
            repositionHotspots();
            _repositionTimer = null;
        }, delay);
    }

    function createHotspot(type, x, y, elementData) {
        const hotspot = document.createElement('div');
        hotspot.className = `hotspot ${type}`;
        hotspot.dataset.x = String(x);
        hotspot.dataset.y = String(y);
        hotspot.dataset.elementKey = getElementKey(type, elementData);
        
        // Toujours définir une taille, avec une valeur par défaut si non spécifiée
        if (elementData && elementData.size !== undefined && elementData.size > 0) {
            hotspot.dataset.size = String(elementData.size);
        } else {
            // Taille par défaut: 2.5% de la largeur de l'image
            hotspot.dataset.size = '0.025';
        }
        
        // Position initiale - la taille sera calculée automatiquement
        positionElement(hotspot, x, y, false);

        const inspection = getElementInspection(type, elementData);
        if (inspection && isElementCompleted(inspection)) {
            hotspot.classList.add('completed');
        }

        hotspot.addEventListener('click', () => {
            selectElement(type, elementData);
            // Repositionner après affichage du panneau
            scheduleReposition(150);
        });

        return hotspot;
    }

    function closeNotationPanel() {
        currentElement = null;
        const panel = document.getElementById('notationPanel');
        if (panel) {
            panel.classList.add('hidden');
            // Repositionner après fermeture
            setTimeout(() => scheduleReposition(100), 50);
        }
    }

    window.addEventListener('resize', () => scheduleReposition(150));
    window.addEventListener('orientationchange', () => scheduleReposition(150));

    // Observer pour surveiller les changements de DOM et repositionner
    const setupRepositionObserver = () => {
        const mainPlanImage = document.getElementById('planImage');
        if (mainPlanImage) {
            mainPlanImage.addEventListener('load', () => {
                scheduleReposition(80);
            });
            
            // Observer les changements de taille de l'image
            const resizeObserver = new ResizeObserver(() => {
                scheduleReposition(100);
            });
            resizeObserver.observe(mainPlanImage);
        }
    };

    function toggleLeftPanel() {
        const left = document.getElementById('leftPanel');
        if (!left) return;
        left.classList.toggle('collapsed');
        const isCollapsed = left.classList.contains('collapsed');
        localStorage.setItem('fireInspection_leftPanelCollapsed', isCollapsed ? '1' : '0');
        
        const label = document.getElementById('leftPanelZoneLabel');
        const strip = document.getElementById('leftPanelStrip');
        if (isCollapsed) {
            if (currentZone && strip) strip.textContent = currentZone.name;
            if (label) label.classList.add('hidden');
        } else {
            if (label) label.classList.remove('hidden');
        }
        // Repositionner après transition
        setTimeout(() => scheduleReposition(100), 300);
    }

    function applyLeftPanelState() {
        const left = document.getElementById('leftPanel');
        if (!left) return;
        const saved = localStorage.getItem('fireInspection_leftPanelCollapsed');
        if (saved === '1') {
            left.classList.add('collapsed');
            const label = document.getElementById('leftPanelZoneLabel');
            if (label) label.classList.add('hidden');
            const strip = document.getElementById('leftPanelStrip');
            if (strip && currentZone) strip.textContent = currentZone.name;
        }
    }

    function showZoneChecklist() {
        if (!currentZone) return;

        const zoneInspection = getZoneInspection() || createZoneInspection();

        const modal = document.createElement('div');
        modal.className = 'modal';
        
        // Calculer la complétude de la zone - affichage initial (la mise à jour en direct utilisera updateZoneChecklistModalProgress)
        const initialProgress = computeZoneProgress();
        modal.innerHTML = `
            <div class="modal-content w-full max-w-4xl">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">Checklist Zone - ${currentZone.name}</h2>
                        <div class="text-sm text-gray-600 mt-2">
                            Avancement: <span id="zoneChecklistProgress" class="font-bold text-blue-600">${initialProgress.percentage}%</span>
                            <span id="zoneChecklistCounts" class="text-gray-600">(${initialProgress.completed}/${initialProgress.total})</span>
                        </div>
                    </div>
                    <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div class="space-y-6 max-h-96 overflow-y-auto">
                    ${Object.entries(ZONE_CRITERIA).map(([section, criteria]) => `

                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-semibold text-lg mb-3 capitalize">${section.replace(/_/g, ' ')}</h3>
                            <div class="space-y-3">
                                ${Object.entries(criteria).map(([key, label]) => {
                                    const fullKey = `${section}_${key}`;
                                    return `
                                        <div class="criteria-grid">
                                            <label class="text-sm font-medium">${label}</label>
                                            <label class="flex items-center">
                                                <input type="radio" name="${fullKey}" value="oui" 
                                                    ${zoneInspection.criteria[fullKey] === 'oui' ? 'checked' : ''}

                                                    onchange="updateZoneCriteria('${fullKey}', 'oui')" class="mr-1">
                                                <span class="text-green-600">Oui</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="${fullKey}" value="non" 
                                                    ${zoneInspection.criteria[fullKey] === 'non' ? 'checked' : ''}

                                                    onchange="updateZoneCriteria('${fullKey}', 'non')" class="mr-1">
                                                <span class="text-red-600">Non</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="${fullKey}" value="so" 
                                                    ${zoneInspection.criteria[fullKey] === 'so' ? 'checked' : ''}

                                                    onchange="updateZoneCriteria('${fullKey}', 'so')" class="mr-1">
                                                <span class="text-gray-500">S.O.</span>
                                            </label>
                                        </div>
                                    `;
                                }).join('')}

                            </div>
                        </div>
                    `).join('')}

                </div>
                
                <div class="mt-6">
                    <label class="block text-sm font-medium mb-2">Commentaires Zone</label>
                    <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                            rows="3" placeholder="Commentaires généraux sur la zone..."
                            onchange="updateZoneComments(this.value)">${zoneInspection.comments || ''}</textarea>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button onclick="this.closest('.modal').remove()" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Fermer
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        // Mettre à jour les KPI après les modifications dans la checklist
        updateKPIs();
    }

    function isElementCompleted(inspection) {
        const criteria = CRITERIA[inspection.type] || {};
        const enabledCriteria = currentZone?.enabledCriteria?.[inspection.type] || Object.keys(criteria);

        return enabledCriteria.every(key =>
            inspection.criteria[key] && inspection.criteria[key] !== ''
        );
    }

    // Render floor selector UI when a zone is selected
    function renderFloorSelector() {
        const sel = document.getElementById('floorSelect');
        if (!sel || !currentZone) return;
        const floors = currentZone.floors || [];
        if (floors.length <= 1) {
            sel.classList.add('hidden');
            return;
        }
        sel.classList.remove('hidden');
        sel.innerHTML = floors.map(f => `<option value="${f.id}" ${currentFloor && currentFloor.id === f.id ? 'selected' : ''}>${f.name || f.id}</option>`).join('');
        sel.onchange = (e) => {
            const id = e.target.value;
            const floor = (currentZone.floors || []).find(fi => fi.id === id);
            if (floor) {
                currentFloor = floor;
                const planImage = document.getElementById('planImage');
                if (planImage) {
                    planImage.src = currentFloor.plan?.imageUrl || '';
                    planImage.onload = () => addHotspots();
                }
                updateKPIs();
            }
        };
    }

    function toggleAdminMode(enable) {
        isAdminMode = !!enable;
        const appEl = document.getElementById('app');
        const adminEl = document.getElementById('adminMode');
        if (appEl && adminEl) {
            appEl.classList.toggle('hidden', isAdminMode);
            adminEl.classList.toggle('hidden', !isAdminMode);
        }

        if (isAdminMode) {
            // render admin UI and reattach admin action buttons
            renderAdminZoneList();
            renderAdminContent();

            const createBtn = document.getElementById('createZoneBtn');
            if (createBtn) createBtn.onclick = createNewZone;
            const importBtn = document.getElementById('importZoneBtn');
            if (importBtn) importBtn.onclick = showImportModal;
            const exportLibraryBtn = document.getElementById('exportLibraryBtn');
            if (exportLibraryBtn) exportLibraryBtn.onclick = exportLibrary;
            const exitBtn = document.getElementById('exitAdminBtn');
            if (exitBtn) exitBtn.onclick = () => toggleAdminMode(false);
        } else {
            // leaving admin mode: refresh main view
            renderZoneList();
            if (currentZone) {
                const mainPlanImage = document.getElementById('planImage');
                const planUrl = currentFloor?.plan?.imageUrl || '';
                if (mainPlanImage && mainPlanImage.src !== planUrl) {
                    mainPlanImage.src = planUrl;
                    mainPlanImage.onload = () => addHotspots();
                } else {
                    addHotspots();
                }
                updateKPIs();
            }
        }
    }

    function hasNonConformities(zone) {
        return inspections.some(inspection => 
            inspection.campaign === currentCampaign && 
            inspection.zoneId === zone.id && 
            inspection.criteria && 
            Object.values(inspection.criteria).includes('non')
        );
    }

    function renderZoneList() {
        const container = document.getElementById('zoneSelect');
        const filterChecked = document.getElementById('filterNonCompliant')?.checked;

        // Category filters
        const categoryChecks = Array.from(document.querySelectorAll('#categoryFilter input[type=checkbox]:checked')).map(i => i.value);

        let filteredZones = zones.slice();

        if (filterChecked) {
            filteredZones = filteredZones.filter(hasNonConformities);
        }

        if (categoryChecks.length > 0) {
            filteredZones = filteredZones.filter(z => {
                const cat = z.category || '';
                // Treat legacy values like 'Administratif:Vestiaire' as 'Administratif'
                const normalized = cat.startsWith('Administratif') ? 'Administratif' : cat;
                return categoryChecks.includes(normalized);
            });
        }

        // Default sorting by name A→Z
        filteredZones.sort((a,b) => (a.name||'').localeCompare(b.name||''));

        container.innerHTML = '<option value="">Sélectionnez une zone...</option>' +
            filteredZones.map(zone => `
                <option value="${zone.id}" ${currentZone?.id === zone.id ? 'selected' : ''}>
                    ${zone.name} (${zone.id})${zone.category ? ' — ' + zone.category : ''}
                </option>
            `).join('');
        // Update left panel compact label when collapsed
        const left = document.getElementById('leftPanel');
        const strip = document.getElementById('leftPanelStrip');
        const leftLabel = document.getElementById('leftPanelZoneLabel');
        if (left && left.classList.contains('collapsed')) {
            if (currentZone && strip) strip.textContent = currentZone.name;
            if (leftLabel) leftLabel.classList.add('hidden');
        } else {
            if (leftLabel) leftLabel.textContent = currentZone ? `${currentZone.name}` : 'Zone Sélectionnée';
        }
    }

    function selectZone(zoneId) {
        currentZone = zones.find(z => z.id === zoneId);
        if (!currentZone) return;

        document.getElementById('currentZoneName').textContent = currentZone.name;
        // update small left label if present
        const leftLabel = document.getElementById('leftPanelZoneLabel');
        if (leftLabel) leftLabel.textContent = currentZone.name;
        const leftStrip = document.getElementById('leftPanelStrip');
        if (leftStrip && document.getElementById('leftPanel')?.classList.contains('collapsed')) {
            leftStrip.textContent = currentZone.name;
        }
        document.getElementById('zoneChecklistBtn').classList.remove('hidden');

        // Initialize currentFloor to first available floor
        currentFloor = (currentZone.floors && currentZone.floors[0]) || null;

        // Show plan
        const planContainer = document.getElementById('planContainer');
        const planImage = document.getElementById('planImage');
        const noZoneMessage = document.getElementById('noZoneMessage');

        if (currentFloor && currentFloor.plan && currentFloor.plan.imageUrl) {
            planImage.src = currentFloor.plan.imageUrl;
        } else {
            planImage.src = '';
        }
        planContainer.classList.remove('hidden');
        noZoneMessage.classList.add('hidden');

        // Populate floor selector
        renderFloorSelector();

        // Add hotspots
        planImage.onload = () => {
            addHotspots();
            renderZoneList(); // Refresh to show selection
            updateKPIs();
        };
    }

    function hasElementNonConformity(type, elementData) {
        const inspection = getElementInspection(type, elementData);
        return inspection && inspection.criteria && Object.values(inspection.criteria).includes('non');
    }

    function addHotspots() {
        const planContainer = document.getElementById('planContainer');
        const planImage = document.getElementById('planImage');
        
        // Remove existing hotspots
        planContainer.querySelectorAll('.hotspot').forEach(h => h.remove());
        
        if (!currentZone || !planImage || !currentFloor) return;
        
        const filterChecked = document.getElementById('filterNonCompliant')?.checked;
        
        // Wait for image to be fully loaded and positioned
        const addHotspotsWhenReady = () => {
            // Add extincteur hotspots (from currentFloor)
            currentFloor.elements.extincteurs?.forEach(ext => {
                if (!filterChecked || hasElementNonConformity('extincteur', ext)) {
                    const hotspot = createHotspot('extincteur', ext.x, ext.y, ext);
                    planContainer.appendChild(hotspot);
                }
            });
            
            // Add DM hotspots
            currentFloor.elements.dm?.forEach(dm => {
                if (!filterChecked || hasElementNonConformity('dm', dm)) {
                    const hotspot = createHotspot('dm', dm.x, dm.y, dm);
                    planContainer.appendChild(hotspot);
                }
            });
            
            // Add sortie hotspots
            currentFloor.elements.sorties?.forEach((sortie, index) => {
                if (!filterChecked || hasElementNonConformity('sortie', { ...sortie, index })) {
                    const hotspot = createHotspot('sortie', sortie.x, sortie.y, { ...sortie, index });
                    planContainer.appendChild(hotspot);
                }
            });
            
            // Reposition après ajout de tous les hotspots
            setTimeout(() => repositionHotspots(), 50);
        };
        
        if (planImage.complete && planImage.naturalHeight !== 0) {
            setTimeout(addHotspotsWhenReady, 10);
        } else {
            planImage.onload = addHotspotsWhenReady;
        }
    }

    function selectElement(type, elementData) {
        currentElement = { type, data: elementData };
        // show notation panel
        const panel = document.getElementById('notationPanel');
        if (panel) {
            panel.classList.remove('hidden');
            // Repositionner après affichage du panneau
            setTimeout(() => scheduleReposition(100), 100);
        }
        renderNotationPanel();
    }

    function renderNotationPanel() {
        const container = document.getElementById('notationContent');
        
        if (!currentElement) {
            container.innerHTML = `
                <div class="text-gray-500 text-center">
                    <div class="text-4xl mb-2">📝</div>
                    <p>Cliquez sur un élément du plan pour le noter</p>
                </div>
            `;
            return;
        }
        
        const { type, data } = currentElement;
        const criteria = CRITERIA[type] || {};
        const inspection = getElementInspection(type, data) || createElementInspection(type, data);
        
        let title = type.charAt(0).toUpperCase() + type.slice(1);
        if (data.id) title += ` - ${data.id}`;
        if (data.type) title += ` (${data.type})`;
        
        // Calculer la complétude de cet élément
        const enabledCriteria = currentZone?.enabledCriteria?.[type] || Object.keys(criteria);
        const completedCount = enabledCriteria.filter(key => inspection.criteria[key] && inspection.criteria[key] !== '').length;
        const percentage = Math.round((completedCount / enabledCriteria.length) * 100);
        
        container.innerHTML = `
            <div class="text-left">
                <div class="mb-4 pb-3 border-b">
                    <h3 class="font-semibold text-lg">${title}</h3>
                    <div class="text-sm text-gray-600 mt-2">
                        Avancement: <span class="font-bold text-blue-600">${percentage}%</span> (${completedCount}/${enabledCriteria.length})
                    </div>
                </div>
                
                <div class="space-y-4">
                    ${Object.entries(criteria).map(([key, label]) => `
                        <div class="criteria-grid">
                            <label class="text-sm font-medium">${label}</label>
                            <label class="flex items-center">
                                <input type="radio" name="${key}" value="oui" 
                                    ${inspection.criteria[key] === 'oui' ? 'checked' : ''}

                                    onchange="updateCriteria('${key}', 'oui')" class="mr-1">
                                <span class="text-green-600">Oui</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="${key}" value="non" 
                                    ${inspection.criteria[key] === 'non' ? 'checked' : ''}

                                    onchange="updateCriteria('${key}', 'non')" class="mr-1">
                                <span class="text-red-600">Non</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="${key}" value="so" 
                                    ${inspection.criteria[key] === 'so' ? 'checked' : ''}

                                    onchange="updateCriteria('${key}', 'so')" class="mr-1">
                                <span class="text-gray-500">S.O.</span>
                            </label>
                        </div>
                    `).join('')}

                </div>
                
                <div class="mt-6">
                    <label class="block text-sm font-medium mb-2">Commentaires</label>
                    <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                            rows="3" placeholder="Commentaires optionnels..."
                            onchange="updateComments(this.value)">${inspection.comments || ''}</textarea>
                </div>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium mb-2">Photos</label>
                    <input type="file" accept="image/*" multiple 
                        onchange="handlePhotoUpload(event)" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <div id="photoPreview" class="mt-2 grid grid-cols-2 gap-2">
                        ${(inspection.photos || []).map((photo, index) => `
                            <div class="relative">
                                <img src="${photo}" class="w-full h-20 object-cover rounded border">
                                <button onclick="removePhoto(${index})" 
                                        class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs">×</button>
                            </div>
                        `).join('')}

                    </div>
                </div>
            </div>
        `;
    }

    function updateZoneName(newName) {
        if (!currentZone) return;
        currentZone.name = newName.trim();
    }

    // Get element inspection
    function getElementInspection(type, elementData) {
        const key = getElementKey(type, elementData);
        return inspections.find(i => 
            i.campaign === currentCampaign && 
            i.zoneId === currentZone.id && 
            i.floorId === (currentFloor?.id || null) &&
            i.elementKey === key
        );
    }

    // Create element inspection
    function createElementInspection(type, elementData) {
        const key = getElementKey(type, elementData);
        const inspection = {
            timestamp: new Date().toISOString(),
            campaign: currentCampaign,
            zoneId: currentZone.id,
            floorId: currentFloor?.id || null,
            elementKey: key,
            type: type,
            elementData: elementData,
            criteria: {},
            comments: '',
            photos: []
        };
        
        inspections.push(inspection);
        saveInspections();
        return inspection;
    }

    // Get element key
    function getElementKey(type, elementData) {
        // include floor id in keys to disambiguate same element ids across floors
        const floorPart = currentFloor?.id ? `${currentFloor.id}_` : '';
        if (type === 'sortie') {
            return `${floorPart}${type}_${elementData.x}_${elementData.y}`;
        }
        return `${floorPart}${type}_${elementData.id || elementData.index}`;
    }

    // Update criteria
    function updateCriteria(criteriaKey, value) {
        if (!currentElement) return;
        
        const inspection = getElementInspection(currentElement.type, currentElement.data);
        if (inspection) {
            inspection.criteria[criteriaKey] = value;
            inspection.timestamp = new Date().toISOString();
            saveInspections();
            updateKPIs();
            // Refresh notation panel counts/percentage
            renderNotationPanel();
            // Update completed state on the matching hotspots and admin elements
            const elementKey = inspection.elementKey;
            // Hotspots
            document.querySelectorAll(`#planContainer .hotspot`).forEach(h => {
                if (h.dataset.elementKey === elementKey) {
                    if (isElementCompleted(inspection)) h.classList.add('completed'); else h.classList.remove('completed');
                }
            });
            // Admin elements
            document.querySelectorAll('.admin-element').forEach(a => {
                if (a.dataset.elementKey === elementKey) {
                    if (isElementCompleted(inspection)) a.classList.add('completed'); else a.classList.remove('completed');
                }
            });
            // Force reposition si nécessaire
            // Re-render hotspots and admin elements to ensure visual state is consistent
            addHotspots();
            renderAdminElements();
            scheduleReposition(100);
        }
    }

    // Update comments
    function updateComments(comments) {
        if (!currentElement) return;
        
        const inspection = getElementInspection(currentElement.type, currentElement.data);
        if (inspection) {
            inspection.comments = comments;
            inspection.timestamp = new Date().toISOString();
            saveInspections();
        }
    }

    // Handle photo upload (compress before storing)
    function handlePhotoUpload(event) {
        if (!currentElement) return;

        const files = Array.from(event.target.files);
        const inspection = getElementInspection(currentElement.type, currentElement.data);
        if (!inspection) return;

        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                // compress image before storing
                compressImage(e.target.result, 1600, 0.75).then(compressed => {
                    inspection.photos = inspection.photos || [];
                    inspection.photos.push(compressed);
                    inspection.timestamp = new Date().toISOString();
                    saveInspections();
                    renderNotationPanel(); // Refresh to show new photos
                });
            };
            reader.readAsDataURL(file);
        });
    }

    // Update zone plan (compress before storing, robust save)
    function updateZonePlan(event) {
        const file = event.target.files[0];
        if (!file || !currentZone || !currentFloor) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            compressImage(e.target.result, 1600, 0.8).then(compressedDataUrl => {
                const img = new Image();
                img.onload = () => {
                    currentFloor.plan = currentFloor.plan || {};
                    currentFloor.plan.imageUrl = compressedDataUrl;
                    currentFloor.plan.naturalWidth = img.width;
                    currentFloor.plan.naturalHeight = img.height;
                    // Save with quota handling
                    saveZones();

                    // Update admin view
                    const adminPlanImage = document.getElementById('adminPlanImage');
                    if (adminPlanImage) {
                        adminPlanImage.src = compressedDataUrl;
                        adminPlanImage.onload = () => renderAdminElements();
                    }
                    // Update main view
                    const mainPlanImage = document.getElementById('planImage');
                    if (mainPlanImage) {
                        mainPlanImage.src = compressedDataUrl;
                        mainPlanImage.onload = () => addHotspots();
                    }
                    alert('Plan de la zone mis à jour avec succès (image compressée pour stockage).');
                };
                img.onerror = () => alert('Erreur lors du traitement de l\'image.');
                img.src = compressedDataUrl;
            });
        };
        reader.readAsDataURL(file);
    }

    // Get zone inspection
    function getZoneInspection() {
        return inspections.find(i => 
            i.campaign === currentCampaign && 
            i.zoneId === currentZone.id && 
            i.type === 'zone'
        );
    }

    // Create zone inspection
    function createZoneInspection() {
        const inspection = {
            timestamp: new Date().toISOString(),
            campaign: currentCampaign,
            zoneId: currentZone.id,
            type: 'zone',
            criteria: {},
            comments: ''
        };
        
        inspections.push(inspection);
        saveInspections();
        return inspection;
    }

    // Update zone criteria
    function updateZoneCriteria(criteriaKey, value) {
        const inspection = getZoneInspection() || createZoneInspection();
        if (inspection) {
            inspection.criteria[criteriaKey] = value;
            inspection.timestamp = new Date().toISOString();
            saveInspections();
            updateKPIs();
            // If the checklist modal is open, update its progress display live
            updateZoneChecklistModalProgress();
        }
    }

    // Compute zone progress: returns { total, completed, percentage }
    function computeZoneProgress() {
        if (!currentZone) return { total: 0, completed: 0, percentage: 0 };
        const zoneInspection = getZoneInspection() || createZoneInspection();
        let allZoneCriteria = [];
        Object.entries(ZONE_CRITERIA).forEach(([section, criteria]) => {
            if (currentZone.enabledCriteria?.zone?.[section]) {
                currentZone.enabledCriteria.zone[section].forEach(key => {
                    allZoneCriteria.push(`${section}_${key}`);
                });
            }
        });

        const total = allZoneCriteria.length;
        const completed = allZoneCriteria.filter(fullKey => zoneInspection.criteria[fullKey] && zoneInspection.criteria[fullKey] !== '').length;
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        return { total, completed, percentage };
    }

    function updateZoneChecklistModalProgress() {
        const elPct = document.getElementById('zoneChecklistProgress');
        const elCounts = document.getElementById('zoneChecklistCounts');
        if (!elPct || !elCounts) return;
        const prog = computeZoneProgress();
        elPct.textContent = prog.percentage + '%';
        elCounts.textContent = `(${prog.completed}/${prog.total})`;
    }

    // Update zone comments
    function updateZoneComments(comments) {
        const inspection = getZoneInspection();
        if (inspection) {
            inspection.comments = comments;
            inspection.timestamp = new Date().toISOString();
            saveInspections();
        }
    }

    // Show export modal
    function showExportModal() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Exporter les Données</h2>
                    <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div class="space-y-4">
                    <button onclick="exportInspections('json')" 
                            class="w-full px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Exporter Inspections (JSON)
                    </button>
                    <button onclick="exportInspections('csv')" 
                            class="w-full px-4 py-3 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Exporter Inspections (CSV)
                    </button>
                    <button onclick="exportCurrentZone()" 
                            class="w-full px-4 py-3 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                        Exporter Zone Actuelle (JSON)
                    </button>
                </div>
                
                <div class="mt-6">
                    <h3 class="font-semibold mb-3">Importer Inspections</h3>
                    <input type="file" accept=".json" onchange="importInspections(event)" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    // Show non-conformities modal
    function showNonConformitiesModal() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        modal.innerHTML = `
            <div class="modal-content w-full max-w-4xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Rapport des Non-Conformités</h2>
                    <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <label class="flex items-center mb-4">
                    <input type="checkbox" id="filterZonesOnly" onchange="updateNonConformitiesView()" class="mr-2">
                    Afficher seulement les zones non conformes
                </label>
                
                <div id="nonConformitiesList" class="space-y-4 max-h-96 overflow-y-auto">
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        updateNonConformitiesView();
    }

    function updateNonConformitiesView() {
        const listDiv = document.getElementById('nonConformitiesList');
        const filterChecked = document.getElementById('filterZonesOnly')?.checked;
        
        const nonConformities = [];
        
        inspections.forEach(inspection => {
            if (inspection.campaign === currentCampaign && inspection.criteria) {
                const zone = zones.find(z => z.id === inspection.zoneId);
                const zoneName = zone ? zone.name : inspection.zoneId;
                
                Object.entries(inspection.criteria).forEach(([key, value]) => {
                    if (value === 'non') {
                        let elementName = '';
                        
                        if (inspection.type === 'zone') {
                            const [section, crit] = key.split('_');
                            const label = ZONE_CRITERIA[section] && ZONE_CRITERIA[section][crit] ? ZONE_CRITERIA[section][crit] : key;
                            elementName = `Zone: ${label}`;
                        } else {
                            const typeLabel = inspection.type === 'extincteur' ? 'Extincteur' : inspection.type === 'dm' ? 'DM' : 'Sortie';
                            elementName = `${typeLabel} ${inspection.elementData.id || ''}`;
                            const critLabel = CRITERIA[inspection.type] && CRITERIA[inspection.type][key] ? CRITERIA[inspection.type][key] : key;
                            elementName += ` - ${critLabel}`;
                        }
                        
                        nonConformities.push({
                            zone: zoneName,
                            element: elementName,
                            timestamp: inspection.timestamp
                        });
                    }
                });
            }
        });
        
        let content = '';
        
        if (filterChecked) {
            // Group by zone
            const zonesWithIssues = {};
            nonConformities.forEach(nc => {
                if (!zonesWithIssues[nc.zone]) zonesWithIssues[nc.zone] = [];
                zonesWithIssues[nc.zone].push(nc);
            });
            
            if (Object.keys(zonesWithIssues).length === 0) {
                content = '<p class="text-gray-500">Aucune zone non conforme trouvée.</p>';
            } else {
                Object.entries(zonesWithIssues).forEach(([zone, issues]) => {
                    content += `<div class="border border-red-200 bg-red-50 p-4 rounded"><h3 class="font-bold text-red-700">${zone} (${issues.length} non-conformité(s))</h3><ul class="mt-2 space-y-1">`;
                    issues.forEach(nc => {
                        content += `<li class="text-sm">${nc.element} <small class="text-gray-500">(${new Date(nc.timestamp).toLocaleString()})</small></li>`;
                    });
                    content += '</ul></div>';
                });
            }
        } else {
            // List all
            if (nonConformities.length === 0) {
                content = '<p class="text-gray-500">Aucune non-conformité trouvée.</p>';
            } else {
                nonConformities.forEach(nc => {
                    content += `<div class="border border-red-200 bg-red-50 p-3 rounded"><strong>${nc.zone}</strong>: ${nc.element} <small class="text-gray-500">(${new Date(nc.timestamp).toLocaleString()})</small></div>`;
                });
            }
        }
        
        listDiv.innerHTML = content;
    }

    // Export inspections
    function exportInspections(format) {
        const campaignInspections = inspections.filter(i => i.campaign === currentCampaign);
        
        if (format === 'json') {
            const data = JSON.stringify(campaignInspections, null, 2);
            downloadFile(data, `inspections_${currentCampaign}.json`, 'application/json');
        } else if (format === 'csv') {
            const csv = convertToCSV(campaignInspections);
            downloadFile(csv, `inspections_${currentCampaign}.csv`, 'text/csv');
        }
    }

    // Convert to CSV
    function convertToCSV(data) {
        if (data.length === 0) return '';
        
        const headers = ['Timestamp', 'Campaign', 'Zone ID', 'Type', 'Element Key', 'Criteria', 'Comments'];
        const rows = data.map(item => [
            item.timestamp,
            item.campaign,
            item.zoneId,
            item.type,
            item.elementKey || '',
            JSON.stringify(item.criteria),
            item.comments || ''
        ]);
        
        return [headers, ...rows].map(row => 
            row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
        ).join('\n');
    }

    // Download file
    function downloadFile(content, filename, contentType) {
        const blob = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Export current zone
    function exportCurrentZone() {
        if (!currentZone) return;
        
        const data = JSON.stringify(currentZone, null, 2);
        downloadFile(data, `zone_${currentZone.id}.json`, 'application/json');
    }

    // Import inspections
    function importInspections(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                inspections = [...inspections, ...importedData];
                saveInspections();
                updateKPIs();
                alert('Inspections importées avec succès !');
            } catch (error) {
                alert('Erreur lors de l\'importation : ' + error.message);
            }
        };
        reader.readAsText(file);
    }

    function renderAdminContent() {
        const adminContent = document.getElementById('adminContent');
        if (!adminContent) return;
        adminContent.innerHTML = `
            <div class="text-center text-gray-500">
                <div class="text-6xl mb-4">⚙️</div>
                <p>Sélectionnez une zone à modifier ou créez-en une nouvelle</p>
            </div>
        `;
    }

    function renderAdminZoneList() {
        const container = document.getElementById('adminZoneList');
        if (!container) return;

        container.innerHTML = zones.map(zone => {
            const cat = zone.category || '';
            const displayCat = cat.startsWith('Administratif') ? 'Administratif' : cat;
            return `
            <div class="flex justify-between items-center p-2 border border-gray-200 rounded hover:bg-gray-50">
                <div class="flex-1">
                    <div class="font-medium">${zone.name} ${displayCat ? `<span class=\"text-xs ml-2 px-1 py-0.5 bg-gray-100 rounded\">${displayCat}</span>` : ''}</div>
                    <div class="text-sm text-gray-500">${zone.id}</div>
                </div>
                <button onclick="editZone('${zone.id}')" 
                        class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                    Éditer
                </button>
            </div>
        `}).join('');
    }

    function createNewZone() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Créer une Nouvelle Zone</h2>
                    <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form onsubmit="saveNewZone(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">ID de la Zone</label>
                            <input type="text" name="zoneId" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                placeholder="zone-001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Nom de la Zone</label>
                            <input type="text" name="zoneName" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                placeholder="Atelier Principal">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Plan de la Zone</label>
                            <input type="file" name="planImage" accept="image/*" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="this.closest('.modal').remove()" 
                                class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                            Annuler
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Créer
                        </button>
                    </div>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function saveNewZone(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const zoneId = formData.get('zoneId');
        const zoneName = formData.get('zoneName');
        const planFile = formData.get('planImage');
        
        if (zones.find(z => z.id === zoneId)) {
            alert('Une zone avec cet ID existe déjà !');
            return;
        }
        
        const newZone = {
            id: zoneId,
            name: zoneName,
            floors: [
                {
                    id: 'RDC',
                    name: 'Rez-de-chaussée',
                    plan: { imageUrl: '', naturalWidth: 800, naturalHeight: 600 },
                    elements: { extincteurs: [], dm: [], sorties: [] }
                }
            ],
            category: '',
            enabledCriteria: {
                extincteur: Object.keys(CRITERIA.extincteur),
                dm: Object.keys(CRITERIA.dm),
                sortie: Object.keys(CRITERIA.sortie),
                zone: Object.keys(ZONE_CRITERIA).reduce((acc, section) => {
                    acc[section] = Object.keys(ZONE_CRITERIA[section]);
                    return acc;
                }, {})
            }
        };
        
        if (planFile && planFile.size > 0) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    newZone.floors[0].plan.imageUrl = e.target.result;
                    newZone.floors[0].plan.naturalWidth = img.width;
                    newZone.floors[0].plan.naturalHeight = img.height;
                    zones.push(newZone);
                    saveZones();
                    renderAdminZoneList();
                    renderZoneList();
                    event.target.closest('.modal').remove();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(planFile);
        } else {
            newZone.floors[0].plan.imageUrl = 'data:image/svg+xml;base64,' + btoa(`
                <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                    <rect width="800" height="600" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2"/>
                    <rect x="50" y="50" width="700" height="500" fill="#e9ecef" stroke="#6c757d" stroke-width="1"/>
                    <text x="400" y="300" text-anchor="middle" font-family="Arial" font-size="24" fill="#495057">${zoneName}</text>
                    <text x="400" y="330" text-anchor="middle" font-family="Arial" font-size="16" fill="#6c757d">Ajoutez des éléments en mode édition</text>
                </svg>
            `);
            zones.push(newZone);
            saveZones();
            renderAdminZoneList();
            renderZoneList();
            event.target.closest('.modal').remove();
        }
    }

    function showImportModal() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Importer une Zone</h2>
                    <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div class="space-y-4">
                    <p class="text-sm text-gray-600">Sélectionnez un fichier JSON de zone à importer</p>
                    <input type="file" accept=".json" onchange="importZoneFile(event)" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="this.closest('.modal').remove()" 
                            class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                        Fermer
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function importZoneFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedZone = JSON.parse(e.target.result);
                if (!importedZone.id || !importedZone.name) throw new Error('Zone invalide');
                
                if (zones.find(z => z.id === importedZone.id)) {
                    alert('Une zone avec cet ID existe déjà !');
                    return;
                }
                
                // Normalize imported zone to ensure floors exist
                if (!importedZone.floors && (importedZone.plan || importedZone.elements)) {
                    importedZone.floors = [{
                        id: importedZone.defaultFloorId || 'RDC',
                        name: importedZone.defaultFloorName || 'Rez-de-chaussée',
                        plan: importedZone.plan || { imageUrl: '' },
                        elements: importedZone.elements || { extincteurs: [], dm: [], sorties: [] }
                    }];
                    delete importedZone.plan;
                    delete importedZone.elements;
                }

                zones.push(importedZone);
                saveZones();
                renderAdminZoneList();
                renderZoneList();
                event.target.closest('.modal').remove();
                alert('Zone importée avec succès !');
            } catch (error) {
                alert('Erreur lors de l\'importation : ' + error.message);
            }
        };
        reader.readAsText(file);
    }

    function exportLibrary() {
        const data = JSON.stringify(zones, null, 2);
        downloadFile(data, `zones_library_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
    }

    const ELEMENT_COLLECTION_MAP = { extincteur: 'extincteurs', dm: 'dm', sortie: 'sorties' };
    const EXTINGUISHER_TYPES = ['Eau', 'Mousse', 'Poudre', 'CO2', 'Lithium'];

    function generateUniqueElementId(type, elements) {
        const prefix = type === 'extincteur' ? 'EXT' : 'DM';
        let counter = elements.length + 1;
        let candidate;
        do {
            candidate = `${prefix}-${String(counter).padStart(3, '0')}`;
            counter++;
        } while (elements.some(el => el.id === candidate));
        return candidate;
    }

    function addElement(type) {
        if (!currentZone) return;
        const collectionKey = ELEMENT_COLLECTION_MAP[type];
        if (!collectionKey) return;
        if (!currentFloor) return;
        currentFloor.elements = currentFloor.elements || { extincteurs: [], dm: [], sorties: [] };
        currentFloor.elements[collectionKey] = currentFloor.elements[collectionKey] || [];
        const collection = currentFloor.elements[collectionKey];
        const element = { x: 0.5, y: 0.5 };
        // read default size input if present (percentage), otherwise fallback to 2%
        const sizeInput = document.getElementById('defaultElemSize');
        let defaultSize = 0.02;
        if (sizeInput) {
            const parsed = parseFloat(sizeInput.value);
            if (!isNaN(parsed)) defaultSize = Math.max(0.005, Math.min(0.5, parsed / 100));
        }
        element.size = defaultSize;
        
        if (type !== 'sortie') {
            element.id = generateUniqueElementId(type, collection);
            if (type === 'extincteur') element.type = 'Poudre';
        }
        
        collection.push(element);
        saveZones();
        renderAdminElements();
        renderElementsList();
    }

    function removeElement(type, index) {
        if (!currentZone) return;
        const collectionKey = ELEMENT_COLLECTION_MAP[type];
        if (!currentFloor) return;
        const collection = currentFloor.elements?.[collectionKey];
        if (!collection || !collection[index]) return;
        
        if (!confirm('Supprimer cet élément ?')) return;
        
    const [removed] = collection.splice(index, 1);
    const elementKey = getElementKey(type, removed);
    inspections = inspections.filter(ins => !(ins.zoneId === currentZone.id && ins.floorId === (currentFloor?.id || null) && ins.elementKey === elementKey));
        
        saveZones();
        saveInspections();
        renderAdminElements();
        renderElementsList();
    }

    function renderElementsList() {
        const container = document.getElementById('elementsList');
        if (!container || !currentZone) return;
        
        const sections = [
            { type: 'extincteur', label: 'Extincteurs', collectionKey: 'extincteurs' },
            { type: 'dm', label: 'Déclencheurs Manuels', collectionKey: 'dm' },
            { type: 'sortie', label: 'Sorties de secours', collectionKey: 'sorties' }
        ];
        
        container.innerHTML = sections.map(({ type, label, collectionKey }) => {
            const collection = (currentFloor && currentFloor.elements && currentFloor.elements[collectionKey]) || [];
            const content = collection.length
                ? collection.map((el, idx) => `
                    <div class="border border-gray-200 rounded px-2 py-1 text-xs flex justify-between items-center bg-gray-50">
                        <div class="flex-1">
                            <div class="font-medium">${el.id || `Sortie #${idx + 1}`}${el.type ? ` (${el.type})` : ''}</div>
                            <div class="text-gray-500">X: ${Math.round(el.x * 100)}% Y: ${Math.round(el.y * 100)}% Taille: ${Math.round((el.size || 0.02) * 100)}%</div>
                        </div>
                        <div class="flex gap-1">
                            <button type="button" class="px-2 py-1 bg-yellow-500 text-white rounded text-sm hover:bg-yellow-600" onclick="editElementDialog('${type}', ${idx})">Éditer</button>
                            <button type="button" class="px-2 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700" onclick="removeElement('${type}', ${idx})">Suppr.</button>
                        </div>
                    </div>
                `).join('')
                : '<div class="text-xs text-gray-500 italic">Aucun élément</div>';
            
            return `
                <div class="space-y-1">
                    <h4 class="text-xs font-semibold text-gray-700">${label}</h4>
                    <div class="space-y-1">${content}</div>
                </div>
            `;
        }).join('');
    }

    function editElementDialog(type, index) {
        const collectionKey = ELEMENT_COLLECTION_MAP[type];
        if (!currentFloor) return;
        const element = currentFloor.elements[collectionKey][index];
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content max-w-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Éditer élément</h2>
                    <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form onsubmit="saveElementEdit(event, '${type}', ${index})">
                    <div class="space-y-4">
                        ${type === 'sortie' ? '' : `

                            <div>
                                <label class="block text-sm font-medium mb-2">ID</label>
                                <input type="text" id="editElemId" value="${element.id || ''}" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                        `}
                        ${type === 'extincteur' ? `

                            <div>
                                <label class="block text-sm font-medium mb-2">Type</label>
                                <select id="editElemType" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    ${EXTINGUISHER_TYPES.map(t => `<option value="${t}" ${element.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                                </select>
                            </div>
                        ` : ''}

                        <div>
                            <label class="block text-sm font-medium mb-2">Position</label>
                            <div class="flex gap-2">
                                <div class="flex-1">
                                    <label class="text-sm font-medium">X (%)</label>
                                    <input type="number" step="0.01" min="0" max="100" value="${(element.x * 100).toFixed(2)}" 
                                        onchange="updateElementPosition(${index}, 'x', this.value)" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="flex-1">
                                    <label class="text-sm font-medium">Y (%)</label>
                                    <input type="number" step="0.01" min="0" max="100" value="${(element.y * 100).toFixed(2)}" 
                                        onchange="updateElementPosition(${index}, 'y', this.value)" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Taille (%)</label>
                            <input id="editElemSize" type="number" step="0.1" min="0.5" max="50" value="${((element.size || 0.02) * 100).toFixed(2)}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md" />
                        </div>
                    </div>
                    
                    <div class="flex justify-between gap-3 mt-6">
                        <button type="button" onclick="if(confirm('Êtes-vous sûr de vouloir supprimer cet élément ?')) { removeElement('${type}', ${index}); this.closest('.modal').remove(); }" 
                                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                            Supprimer
                        </button>
                        <div class="flex gap-3">
                            <button type="button" onclick="this.closest('.modal').remove()" 
                                    class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                                Annuler
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Enregistrer
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    function saveElementEdit(event, type, index) {
        event.preventDefault();
        const collectionKey = ELEMENT_COLLECTION_MAP[type];
        if (!currentFloor) return;
        const element = currentFloor.elements[collectionKey][index];
        
        if (type !== 'sortie') {
            element.id = document.getElementById('editElemId').value.trim();
        }
        if (type === 'extincteur') {
            element.type = document.getElementById('editElemType').value;
        }
        // save size if provided
        const sizeInput = document.getElementById('editElemSize');
        if (sizeInput) {
            const val = parseFloat(sizeInput.value);
            if (!isNaN(val)) {
                element.size = Math.max(0.005, Math.min(0.5, val / 100));
            }
        }
        
        saveZones();
        renderElementsList();
        renderAdminElements();
        event.target.closest('.modal').remove();
    }

    function renderElementCriteriaConfig() {
        if (!currentZone) return;
        
        // Configurer les critères pour chaque type d'élément
        ['extincteur', 'dm', 'sortie'].forEach(type => {
            const container = document.getElementById(`${type}CriteriaConfig`);
            if (!container) return;
            
            currentZone.enabledCriteria = currentZone.enabledCriteria || {};
            currentZone.enabledCriteria[type] = currentZone.enabledCriteria[type] || Object.keys(CRITERIA[type] || {});
            
            const criteria = CRITERIA[type] || {};
            const enabledCriteria = currentZone.enabledCriteria[type] || [];
            
            container.innerHTML = Object.entries(criteria).map(([key, label]) => `
                <label class="flex items-center">
                    <input type="checkbox" ${enabledCriteria.includes(key) ? 'checked' : ''}
                        onchange="toggleElementCriterion('${type}', '${key}', this.checked)" class="mr-2">
                    <span>${label}</span>
                </label>
            `).join('');
        });
    }

    function renderZoneCriteriaConfig() {
        const container = document.getElementById('zoneCriteriaConfig');
        if (!container || !currentZone) return;
        
        currentZone.enabledCriteria = currentZone.enabledCriteria || {};
        currentZone.enabledCriteria.zone = currentZone.enabledCriteria.zone || {};
        
        container.innerHTML = Object.entries(ZONE_CRITERIA).map(([section, criteria]) => {
            const sectionValues = currentZone.enabledCriteria.zone[section] || [];
            return `
                <div class="border border-gray-100 rounded p-2 space-y-1">
                    <h5 class="text-xs font-semibold capitalize text-gray-700">${section.replace(/_/g, ' ')}</h5>
                    ${Object.entries(criteria).map(([key, label]) => `
                        <label class="flex items-center">
                            <input type="checkbox" ${sectionValues.includes(key) ? 'checked' : ''}
                                onchange="toggleZoneCriterion('${section}', '${key}', this.checked)" class="mr-1">
                            <span class="text-xs">${label}</span>
                        </label>
                    `).join('')}
                </div>
            `;
        }).join('');
    }

    function toggleElementCriterion(type, key, enabled) {
        if (!currentZone) return;
        currentZone.enabledCriteria = currentZone.enabledCriteria || {};
        currentZone.enabledCriteria[type] = currentZone.enabledCriteria[type] || [];
        
        if (enabled) {
            if (!currentZone.enabledCriteria[type].includes(key)) {
                currentZone.enabledCriteria[type].push(key);
            }
        } else {
            currentZone.enabledCriteria[type] = currentZone.enabledCriteria[type].filter(item => item !== key);
        }
        saveZones();
        updateKPIs();
    }

    function toggleZoneCriterion(section, key, enabled) {
        if (!currentZone) return;
        currentZone.enabledCriteria = currentZone.enabledCriteria || {};
        currentZone.enabledCriteria.zone = currentZone.enabledCriteria.zone || {};
        const sectionValues = currentZone.enabledCriteria.zone[section] = currentZone.enabledCriteria.zone[section] || [];
        
        if (enabled) {
            if (!sectionValues.includes(key)) sectionValues.push(key);
        } else {
            currentZone.enabledCriteria.zone[section] = sectionValues.filter(item => item !== key);
        }
        saveZones();
        updateKPIs();
    }

    let adminElementEditForm = null;

    function renderAdminElements() {
        const container = document.getElementById('adminElements');
        if (!container || !currentZone || !currentFloor) return;
        container.innerHTML = '';
        
        const planImage = document.getElementById('adminPlanImage');
        if (!planImage) return;
        
        // Vérifier que l'image a des dimensions valides avant de positionner
        if (!planImage.complete || planImage.clientWidth === 0) {
            // Attendre que l'image soit chargée
            planImage.onload = () => {
                requestAnimationFrame(() => renderAdminElements());
            };
            return;
        }
        ['extincteurs', 'dm', 'sorties'].forEach(type => {
            const elements = (currentFloor.elements && currentFloor.elements[type]) || [];
            elements.forEach((element, index) => {
                const adminElement = document.createElement('div');
                const typeShort = type === 'sorties' ? 'sortie' : type === 'extincteurs' ? 'extincteur' : 'dm';
                adminElement.className = `admin-element ${typeShort}`;
                adminElement.dataset.x = element.x;
                adminElement.dataset.y = element.y;
                adminElement.dataset.index = index;
                adminElement.dataset.elementKey = getElementKey(typeShort, element);
                // stocker le type singulier attendu par editElementDialog
                adminElement.dataset.type = typeShort;
                
                // Position initiale
                positionElement(adminElement, element.x, element.y, true);

                // Mark completed state at render time
                try {
                    const insp = getElementInspection(typeShort, element);
                    if (insp && isElementCompleted(insp)) {
                        adminElement.classList.add('completed');
                    } else {
                        adminElement.classList.remove('completed');
                    }
                } catch (e) {
                    // ignore
                }
                
                let isDragging = false;
                let currentX = element.x;
                let currentY = element.y;
                
                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                
                    const planImage = document.getElementById('adminPlanImage');
                    if (!planImage) return;
                    
                    const imageRect = planImage.getBoundingClientRect();
                    
                    currentX = Math.max(0, Math.min(1, (e.clientX - imageRect.left) / imageRect.width));
                    currentY = Math.max(0, Math.min(1, (e.clientY - imageRect.top) / imageRect.height));
                    
                    positionElement(adminElement, currentX, currentY, true);
                };
                
                const handleMouseUp = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    adminElement.style.cursor = 'move';
                    
                    element.x = currentX;
                    element.y = currentY;
                    adminElement.dataset.x = currentX;
                    adminElement.dataset.y = currentY;
                    
                    saveZones();
                    renderElementsList();
                    // Repositionner après sauvegarde
                    scheduleReposition(50);
                    
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
                
                adminElement.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return;
                    isDragging = true;
                    adminElement.style.cursor = 'grabbing';
                    e.preventDefault();
                    e.stopPropagation();
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });
                
                // Right-click: open the edit dialog for this element (no mouse resize)
                adminElement.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    editElementDialog(typeShort, index);
                });

                // initialize dataset.size avec valeur par défaut robuste
                if (element.size !== undefined && element.size > 0) {
                    adminElement.dataset.size = String(element.size);
                } else {
                    adminElement.dataset.size = '0.025'; // 2.5% par défaut
                }
                container.appendChild(adminElement);
            });
        });
        
        // Force un repositionnement après ajout de tous les éléments
        requestAnimationFrame(() => {
            scheduleReposition(50);
        });
    }

    function editZone(zoneId) {
        const zone = zones.find(z => z.id === zoneId);
        if (!zone) return;

        currentZone = zone;
        // ensure at least one floor
        currentZone.floors = currentZone.floors && currentZone.floors.length ? currentZone.floors : [{ id: 'RDC', name: 'Rez-de-chaussée', plan: { imageUrl: '' }, elements: { extincteurs: [], dm: [], sorties: [] } }];
        currentFloor = currentZone.floors[0];

        const adminContent = document.getElementById('adminContent');
        adminContent.innerHTML = `
            <div class="text-left h-full flex flex-col">
                <div class="flex justify-between items-center mb-6 pb-4 border-b flex-shrink-0">
                    <div class="flex items-center gap-3 flex-1">
                        <h2 class="text-2xl font-bold">Édition -</h2>
                        <input type="text" id="editZoneName" value="${zone.name}" 
                            class="text-2xl font-bold px-3 py-1 border border-gray-300 rounded-md flex-1"
                            onchange="updateZoneName(this.value)">
                    </div>
                    <div class="ml-4">
                        <label class="block text-sm font-medium">Catégorie</label>
                        <select id="editZoneCategory" class="px-2 py-1 border border-gray-300 rounded">
                            <option value="">-- Aucune --</option>
                            <option value="MR" ${zone.category === 'MR' ? 'selected' : ''}>MR</option>
                            <option value="PRM" ${zone.category === 'PRM' ? 'selected' : ''}>PRM</option>
                            <option value="SC" ${zone.category === 'SC' ? 'selected' : ''}>SC</option>
                            <option value="Administratif" ${zone.category === 'Administratif' ? 'selected' : ''}>Administratif</option>
                        </select>
                    </div>
                    <div class="flex gap-2 flex-shrink-0">
                        <button onclick="saveAndReturn()" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Enregistrer
                        </button>
                        <button onclick="renderAdminContent()" 
                                class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                            Retour
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 flex-1 overflow-hidden">
                    <div class="xl:col-span-2 flex flex-col overflow-hidden">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold">Plan de la Zone</h3>
                            <div class="flex items-center gap-2">
                                    <select id="adminFloorSelect" class="px-2 py-1 border border-gray-200 rounded text-sm"></select>
                                    <button type="button" onclick="(function(){ addFloor(); })()" class="px-2 py-1 bg-gray-200 rounded text-xs">+ Etage</button>
                                    <button type="button" id="deleteFloorBtn" onclick="deleteCurrentFloor()" title="Supprimer l'étage sélectionné" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">Suppr. Etage</button>
                                </div>
                        </div>
                        <div class="plan-container admin-mode mb-4 flex-1 overflow-auto" id="adminPlanContainer">
                            <img src="${(currentFloor && currentFloor.plan && currentFloor.plan.imageUrl) ? currentFloor.plan.imageUrl : ''}" class="plan-image w-full h-auto" id="adminPlanImage">
                            <div id="adminElements"></div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Modifier le plan</label>
                                <input type="file" accept="image/*" onchange="updateZonePlan(event)" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            </div>
                            
                            <div class="flex flex-col gap-2">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm">Taille par défaut (%):</label>
                                    <input id="defaultElemSize" type="number" step="0.1" min="0.5" max="50" value="3"
                                        class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" />
                                </div>
                                <button type="button" onclick="addElement('extincteur')" 
                                        class="w-full px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                                    + Ajouter Extincteur
                                </button>
                                <button type="button" onclick="addElement('dm')" 
                                        class="w-full px-3 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm">
                                    + Ajouter DM
                                </button>
                                <button type="button" onclick="addElement('sortie')" 
                                        class="w-full px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                                    + Ajouter Sortie
                                </button>
                            </div>
                            
                            <div class="border-t pt-4">
                                <h4 class="font-semibold mb-3 text-sm">Actions Zone</h4>
                                <div class="flex flex-col gap-2">
                                    <button type="button" onclick="duplicateZone()" 
                                            class="w-full px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm">
                                        🔄 Dupliquer Zone
                                    </button>
                                    <button type="button" onclick="clearAllElements()" 
                                            class="w-full px-3 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 text-sm">
                                        🗑️ Vider Éléments
                                    </button>
                                    <button type="button" onclick="deleteZone()" 
                                            class="w-full px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                        ❌ Supprimer Zone
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col overflow-hidden">
                        <h3 class="font-semibold mb-3">Éléments</h3>
                        <div id="elementsList" class="space-y-2 mb-4 overflow-y-auto flex-1 border border-gray-200 rounded p-3">
                        </div>
                        
                        <h3 class="font-semibold mb-3">Configuration des Critères</h3>
                        <div class="space-y-3 overflow-y-auto flex-1">
                            <div class="border border-gray-200 rounded p-3">
                                <h4 class="font-semibold text-sm mb-2">Critères Extincteurs</h4>
                                <div id="extincteurCriteriaConfig" class="space-y-1 text-xs">
                                </div>
                            </div>
                            
                            <div class="border border-gray-200 rounded p-3">
                                <h4 class="font-semibold text-sm mb-2">Critères DM</h4>
                                <div id="dmCriteriaConfig" class="space-y-1 text-xs">
                                </div>
                            </div>
                            
                            <div class="border border-gray-200 rounded p-3">
                                <h4 class="font-semibold text-sm mb-2">Critères Sorties</h4>
                                <div id="sortieCriteriaConfig" class="space-y-1 text-xs">
                                </div>
                            </div>
                            
                            <div class="border border-gray-200 rounded p-3">
                                <h4 class="font-semibold text-sm mb-2">Critères Zone</h4>
                                <div id="zoneCriteriaConfig" class="space-y-2 text-xs">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Variable pour stocker l'intervalle de reposition
        let adminEditRepositionInterval = null;

        setTimeout(() => {
            const adminImg = document.getElementById('adminPlanImage');
            const adminContainer = document.getElementById('adminPlanContainer');
            
            if (adminImg && adminContainer) {
                // Fonction pour repositionner avec observation
                const setupPositioning = () => {
                    renderAdminFloorSelector();
                    renderAdminElements();
                    renderElementsList();
                    renderElementCriteriaConfig();
                    renderZoneCriteriaConfig();
                    
                    // Reposition continu toutes les 500ms pendant l'édition
                    if (adminEditRepositionInterval) clearInterval(adminEditRepositionInterval);
                    adminEditRepositionInterval = setInterval(() => {
                        const container = document.getElementById('adminElements');
                        if (container && container.parentElement) {
                            repositionHotspots();
                        } else {
                            // Si le conteneur n'existe plus, arrêter l'intervalle
                            if (adminEditRepositionInterval) {
                                clearInterval(adminEditRepositionInterval);
                                adminEditRepositionInterval = null;
                            }
                        }
                    }, 500);
                };
                
                if (adminImg.complete && adminImg.naturalHeight !== 0) {
                    setupPositioning();
                } else {
                    adminImg.onload = setupPositioning;
                }
                
                // Observer de scroll pour repositionner en temps réel
                adminContainer.addEventListener('scroll', () => {
                    scheduleReposition(50);
                }, { passive: true });
                
                // Observer de resize du conteneur
                const resizeObserver = new ResizeObserver(() => {
                    scheduleReposition(100);
                });
                resizeObserver.observe(adminContainer);
            }
        }, 50);
    }

    function renderAdminFloorSelector() {
        const sel = document.getElementById('adminFloorSelect');
        if (!sel || !currentZone) return;
        sel.innerHTML = (currentZone.floors || []).map(f => `<option value="${f.id}" ${currentFloor && currentFloor.id === f.id ? 'selected' : ''}>${f.name || f.id}</option>`).join('');
        sel.onchange = (e) => {
            const id = e.target.value;
            const floor = (currentZone.floors || []).find(fi => fi.id === id);
            if (floor) {
                currentFloor = floor;
                const adminImg = document.getElementById('adminPlanImage');
                if (adminImg) adminImg.src = currentFloor.plan?.imageUrl || '';
                renderAdminElements();
                renderElementsList();
            }
        };
    }

    function addFloor() {
        if (!currentZone) return;
        const newId = `F${(currentZone.floors||[]).length+1}`;
        const floor = { id: newId, name: `Etage ${ (currentZone.floors||[]).length + 1 }`, plan: { imageUrl: '' }, elements: { extincteurs: [], dm: [], sorties: [] } };
        currentZone.floors = currentZone.floors || [];
        currentZone.floors.push(floor);
        currentFloor = floor;
        saveZones();
        renderAdminFloorSelector();
        renderAdminElements();
        renderElementsList();
    }

    function deleteCurrentFloor() {
        // helper called from the delete button in the admin UI
        const sel = document.getElementById('adminFloorSelect');
        const floorId = sel ? sel.value : (currentFloor && currentFloor.id);
        if (!floorId) {
            alert("Aucun étage sélectionné à supprimer.");
            return;
        }
        removeFloor(floorId);
    }

    function removeFloor(floorId) {
        if (!currentZone) return;
        const floors = currentZone.floors || [];
        if (floors.length <= 1) {
            alert("Impossible de supprimer le dernier étage. Si vous souhaitez supprimer la zone entière, utilisez 'Supprimer Zone'.");
            return;
        }

        const floor = floors.find(f => f.id === floorId) || { name: floorId };
        if (!confirm(`Supprimer l'étage "${floor.name || floorId}" et toutes ses inspections associées ?`)) return;

        // Count inspections to be removed for reporting
        const toRemoveCount = inspections.filter(i => i.zoneId === currentZone.id && i.floorId === floorId).length;

        // Remove inspections that reference this zone+floor
        inspections = inspections.filter(i => !(i.zoneId === currentZone.id && i.floorId === floorId));
        // Remove the floor
        currentZone.floors = floors.filter(f => f.id !== floorId);
        // Select a sensible fallback floor
        currentFloor = currentZone.floors[0] || null;

        // Persist changes
        saveInspections();
        saveZones();

        // Refresh admin UI
        renderAdminFloorSelector();
        renderAdminElements();
        renderElementsList();

        // If main view is showing this zone, update the main plan and hotspots
        try {
            const planImage = document.getElementById('planImage');
            if (planImage && currentZone && currentZone.id === (currentZone && currentZone.id)) {
                planImage.src = currentFloor?.plan?.imageUrl || '';
                planImage.onload = () => addHotspots();
                updateKPIs();
            }
        } catch (e) { /* ignore UI refresh errors */ }

        alert(`Étape supprimée avec succès. ${toRemoveCount} inspection(s) supprimée(s).`);
    }

            function saveAndReturn() {
                const newName = document.getElementById('editZoneName')?.value;
                const newCategory = document.getElementById('editZoneCategory')?.value;
                if (newName && currentZone) {
                    updateZoneName(newName);
                    if (newCategory !== undefined) currentZone.category = newCategory || '';
                    saveZones();
                }
                renderAdminContent();
            }

            function duplicateZone() {
                if (!currentZone) return;
                
                const newId = `${currentZone.id}_copy_${Date.now()}`;
                const newName = `${currentZone.name} (Copie)`;
                
                const duplicatedZone = {
                    ...JSON.parse(JSON.stringify(currentZone)), // Deep copy
                    id: newId,
                    name: newName
                };
                
                zones.push(duplicatedZone);
                saveZones();
                renderAdminZoneList();
                alert(`Zone "${newName}" créée avec succès!`);
            }

            function clearAllElements() {
                if (!currentZone) return;
                
                if (!confirm('Êtes-vous sûr de vouloir supprimer tous les éléments de cette zone ?')) return;
                if (!currentFloor) return;
                currentFloor.elements = { extincteurs: [], dm: [], sorties: [] };
                
                saveZones();
                renderAdminElements();
                renderElementsList();
                alert('Tous les éléments ont été supprimés.');
            }

            function deleteZone() {
                if (!currentZone) return;
                
                if (!confirm(`Êtes-vous sûr de vouloir supprimer définitivement la zone "${currentZone.name}" ?`)) return;
                
                // Supprimer la zone
                zones = zones.filter(z => z.id !== currentZone.id);
                
                // Supprimer toutes les inspections liées
                inspections = inspections.filter(i => i.zoneId !== currentZone.id);
                
                saveZones();
                saveInspections();
                renderAdminZoneList();
                renderAdminContent();
                
                alert(`Zone "${currentZone.name}" supprimée avec succès.`);
                currentZone = null;
            }

            // Remove photo function
            function removePhoto(index) {
                if (!currentElement) return;
                const inspection = getElementInspection(currentElement.type, currentElement.data);
                if (inspection && inspection.photos) {
                    inspection.photos.splice(index, 1);
                    saveInspections();
                    renderNotationPanel();
                }
            }

            function updateElementPosition(index, axis, value) {
                        // Update element position or size from the edit dialog inputs
                                if (!currentFloor) return;
                                // Try to find which collection the index refers to by searching the three collections
                                const collections = ['extincteurs','dm','sorties'];
                                let found = false;
                                for (const col of collections) {
                                    const arr = currentFloor.elements[col] || [];
                                    if (arr[index]) {
                                        const el = arr[index];
                                        if (axis === 'x') el.x = Math.max(0, Math.min(1, parseFloat(value) / 100 || 0));
                                        if (axis === 'y') el.y = Math.max(0, Math.min(1, parseFloat(value) / 100 || 0));
                                        if (axis === 'size') el.size = Math.max(0.005, Math.min(0.5, parseFloat(value) / 100 || 0.02));
                                        // persist and update UI
                                        saveZones();
                                        renderAdminElements();
                                        renderElementsList();
                                        found = true;
                                        break;
                                    }
                                }
                        if (!found) {
                            // index not found - ignore
                        }
            }

            // (mouse-based resize removed; resizing is done only via the edit dialog)

            // Initialize the application
            init();
        </script>
    </body>
</html>
