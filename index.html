<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourn√©es Incendie - Gestion des Inspections</title>
    <!-- Version 1.1 - Export/Import Notations ajout√© le 27/10/2025 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Mode sombre */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --modal-bg: #ffffff;
            --input-bg: #ffffff;
            --card-bg: #ffffff;
        }
        
        .dark-mode {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4b5563;
            --modal-bg: #374151;
            --input-bg: #1f2937;
            --card-bg: #374151;
        }
        
        body {
            box-sizing: border-box;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .bg-white { background-color: var(--card-bg) !important; }
        .bg-gray-50 { background-color: var(--bg-secondary) !important; }
        .bg-gray-100 { background-color: var(--bg-tertiary) !important; }
        .text-gray-900 { color: var(--text-primary) !important; }
        .text-gray-700 { color: var(--text-primary) !important; }
        .text-gray-600 { color: var(--text-secondary) !important; }
        .border-gray-200 { border-color: var(--border-color) !important; }
        .border-gray-300 { border-color: var(--border-color) !important; }
        
        /* Titres et textes en mode sombre */
        .dark-mode h3 {
            color: var(--text-primary) !important;
        }
        
        .dark-mode .text-gray-500 {
            color: var(--text-secondary) !important;
        }
        
        .dark-mode .text-sm {
            color: var(--text-primary);
        }
        
        .dark-mode .text-red-700 {
            color: #fca5a5 !important;
        }
        
        .dark-mode .text-red-600 {
            color: #fca5a5 !important;
        }
        
        .dark-mode .text-gray-500 {
            color: #9ca3af !important;
        }
        
        .dark-mode .hover\:text-gray-700:hover {
            color: #d1d5db !important;
        }
        
        /* Cartes de non-conformit√©s */
        .dark-mode .bg-red-50 {
            background-color: rgba(127, 29, 29, 0.2) !important;
        }
        
        .dark-mode .border-red-200 {
            border-color: #991b1b !important;
        }
        
        .dark-mode strong {
            color: var(--text-primary) !important;
        }
        
        .dark-mode .text-gray-800,
        .dark-mode .text-sm {
            color: var(--text-primary) !important;
        }
        
        .dark-mode .bg-gray-200 {
            background-color: #4b5563 !important;
        }
        
        /* Bandeaux d'information bleus */
        .dark-mode .bg-blue-50 {
            background-color: rgba(30, 64, 175, 0.2) !important;
        }
        
        .dark-mode .border-blue-200 {
            border-color: #3b82f6 !important;
        }
        
        .dark-mode .text-blue-800 {
            color: #93c5fd !important;
        }
        
        .modal-content {
            background-color: var(--modal-bg) !important;
            color: var(--text-primary) !important;
        }
        
        input, textarea, select {
            background-color: var(--input-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        .dark-mode input::placeholder,
        .dark-mode textarea::placeholder {
            color: var(--text-secondary);
        }
        
        /* Visionneuse de photos */
        .photo-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .photo-viewer-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .photo-viewer-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .photo-viewer-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 30px;
        }
        
        .photo-viewer-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .photo-viewer-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .photo-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .photo-viewer-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .photo-viewer-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .photo-viewer-nav:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }
        
        .photo-viewer-nav.prev {
            left: 20px;
        }
        
        .photo-viewer-nav.next {
            right: 20px;
        }
        
        .hotspot {
            position: absolute;
            width: 20px;
            height: 20px;
            /* carr√© avec coins l√©g√®rement arrondis */
            border-radius: 4px;
            border: 2px solid white;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: all 0.2s;
            z-index: 10;
            pointer-events: auto;
        }
        
        .hotspot:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        /* couleurs */
        .hotspot.extincteur { background-color: #ef4444; } /* rouge */
        .hotspot.dm { background-color: #f59e0b; } /* jaune */
        .hotspot.sortie { background-color: #10b981; } /* vert */
        
        /* √©l√©ment compl√©t√© : bordure verte plus visible */
        .hotspot.completed {
            border-color: #16a34a;
            border-width: 3px;
            box-shadow: 0 0 6px rgba(22,163,74,0.6);
        }
        
        .plan-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .plan-container.admin-mode {
            max-height: 75vh;
            min-height: 600px;
            overflow: auto;
        }
        
        .plan-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            line-height: 0;
        }
        
        .plan-image {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center;
        }
        
        .hotspot, .admin-element {
            pointer-events: auto;
        }
        
        .criteria-grid {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 8px;
            align-items: center;
        }
        
        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.375rem 0.25rem;
            border-radius: 4px;
            text-align: center;
        }
        
        /* Ajout d'un style sp√©cifique pour l'indicateur B√¢timent */
        .kpi-card.batiment {
            background: linear-gradient(135deg, #3b82f6 0%, #4f46e5 100%);
            border: 1.5px solid #2563eb;
            box-shadow: 0 2px 4px -1px rgba(59, 130, 246, 0.3);
        }
        
        .admin-element {
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 4px; /* square-ish */
            cursor: move;
            transform: translate(-50%, -50%);
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .admin-element.completed {
            border-color: #16a34a;
            box-shadow: 0 0 6px rgba(22,163,74,0.6);
        }

        /* Resize-by-mouse removed: resizing now only via the element edit dialog */
        .admin-element.resizing { transition: none; opacity: 0.95; }
        
        .admin-element:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .admin-element:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .admin-element.extincteur { background: #ef4444; }
        .admin-element.dm { background: #f59e0b; }
        .admin-element.sortie { background: #10b981; }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Mode sombre pour les modales */
        .dark-mode .modal-content {
            background: #1f2937;
            color: #f3f4f6;
        }
        
        /* Collapsible left panel */
        .left-panel {
            transition: width 0.25s ease;
            min-width: 56px; /* allow compact collapsed state */
            position: relative;
        }
        .left-panel.collapsed {
            width: 56px !important; /* collapsed width */
            overflow: visible;
        }
        .left-panel .panel-details {
            transition: opacity 0.2s ease, visibility 0.2s;
        }
        .left-panel.collapsed .panel-details {
            opacity: 0;
            visibility: hidden;
            height: 0;
            pointer-events: none;
        }
        .left-panel .collapse-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: transparent;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .left-panel .collapse-strip {
            display: none;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            font-weight: 600;
            font-size: 12px;
            color: #374151;
            position: absolute;
            left: 8px;
            top: 50%;
            transform-origin: left center;
            transform: translateY(-50%) rotate(-90deg);
        }
        .left-panel.collapsed .collapse-strip {
            display: block;
        }
        
        /* Styles pour les sections repliables de crit√®res */
        details summary {
            list-style: none;
        }
        details summary::-webkit-details-marker {
            display: none;
        }
        details[open] > summary {
            margin-bottom: 0;
        }
        
        /* Animation douce pour les checkboxes */
        input[type="checkbox"] {
            transition: all 0.2s ease;
        }
        input[type="checkbox"]:checked {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="h-full bg-gray-50">
    <div id="app" class="h-full flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold text-gray-900">Tourn√©es Incendie</h1>
                    <!-- Indicateur de stockage -->
                    <div id="storageIndicator" class="text-xs" title="Utilisation du stockage local">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-600">üíæ</span>
                            <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div id="storageBar" class="h-full bg-green-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span id="storageText" class="text-gray-700 font-medium">0%</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4">
                    <select id="campaignSelect" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="2025Q1">2025 Q1</option>
                        <option value="2025Q2">2025 Q2</option>
                        <option value="2025Q3">2025 Q3</option>
                        <option value="2025Q4" selected>2025 Q4</option>
                    </select>
                    <button id="darkModeToggle" class="px-3 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors" title="Basculer mode sombre/clair">
                        <span id="darkModeIcon">üåô</span>
                    </button>
                    <button id="dashboardBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        üìä Tableaux de bord
                    </button>
                    <button id="adminModeBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                        Mode Admin
                    </button>
                    <button id="nonConformitesBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        Non-Conformit√©s
                    </button>
                    <button id="exportBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Exporter
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Left Panel: KPIs only (modified to be collapsible) -->
            <div id="leftPanel" class="left-panel w-72 bg-white border-r flex flex-col">
                <div class="p-3 border-b flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="leftPanelToggleBtn" class="collapse-toggle" title="R√©duire / D√©velopper">
                            <svg id="leftPanelIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M6 4a1 1 0 011 1v10a1 1 0 11-2 0V5a1 1 0 011-1zM10 4a1 1 0 011 1v10a1 1 0 11-2 0V5a1 1 0 011-1zM14 4a1 1 0 011 1v10a1 1 0 11-2 0V5a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div class="collapse-strip" id="leftPanelStrip">Zone</div>
                    </div>
                    <div class="text-sm font-semibold text-gray-700" id="leftPanelZoneLabel">Zone S√©lectionn√©e</div>
                </div>
                <div class="panel-details flex flex-col flex-1">
                    <!-- Zone Selection Dropdown -->
                    <div class="p-4 border-b">
                        <h2 class="text-lg font-semibold mb-3">Zone S√©lectionn√©e</h2>
                        <select id="zoneSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">S√©lectionnez une zone...</option>
                            <!-- Options will be populated here -->
                        </select>
                        
                        <div class="mt-3 text-sm">
                            <div class="font-medium mb-1">Filtrer par cat√©gorie</div>
                            <div id="categoryFilter" class="flex gap-2 flex-wrap">
                                <label class="inline-flex items-center"><input type="checkbox" value="MR" onchange="renderZoneList()" class="mr-1">MR</label>
                                <label class="inline-flex items-center"><input type="checkbox" value="PRM" onchange="renderZoneList()" class="mr-1">PRM</label>
                                <label class="inline-flex items-center"><input type="checkbox" value="SC" onchange="renderZoneList()" class="mr-1">SC</label>
                                <label class="inline-flex items-center"><input type="checkbox" value="Administratif" onchange="renderZoneList()" class="mr-1">Administratif</label>
                            </div>
                        </div>

                        <!-- Sort UI removed as requested; zones are displayed sorted by name A‚ÜíZ -->
                        <label class="flex items-center mt-2">
                            <input type="checkbox" id="filterNonCompliant" onchange="renderZoneList(); if (currentZone) addHotspots();" class="mr-2">
                            <span class="text-sm">Afficher seulement les zones non conformes</span>
                        </label>
                    </div>

                    <!-- KPIs -->
                    <div class="p-1 flex-1">
                        <h2 class="text-sm font-semibold mb-1.5">Indicateurs</h2>
                        <div class="space-y-1">
                            <div class="kpi-card">
                                <div class="text-base font-bold" id="kpiExtincteurs">0%</div>
                                <div class="text-[10px] opacity-90 leading-tight">Extincteurs</div>
                            </div>
                            <div class="kpi-card">
                                <div class="text-base font-bold" id="kpiDM">0%</div>
                                <div class="text-[10px] opacity-90 leading-tight">D√©clencheurs Manuels</div>
                            </div>
                            <div class="kpi-card">
                                <div class="text-base font-bold" id="kpiSorties">0%</div>
                                <div class="text-[10px] opacity-90 leading-tight">Sorties de Secours</div>
                            </div>
                            <!-- Indicateur B√¢timent pour la checklist zone -->
                            <div class="kpi-card batiment">
                                <div class="text-base font-bold" id="kpiBatiment">0%</div>
                                <div class="text-[10px] opacity-90 leading-tight">B√¢timent</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Panel: Plan -->
            <div class="flex-1 p-4 flex flex-col min-w-0 overflow-hidden">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg font-semibold" id="currentZoneName">S√©lectionnez une zone</h2>
                        <select id="floorSelect" class="px-2 py-1 border border-gray-300 rounded-md text-sm hidden"></select>
                    </div>
                    <button id="zoneChecklistBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 hidden">
                        Checklist Zone
                    </button>
                </div>
                <div class="flex-1 flex items-center justify-center overflow-hidden" style="min-height: 0;">
                    <div id="planContainer" class="plan-container hidden" style="width: 100%; height: 100%;">
                        <div id="planWrapper" class="plan-wrapper">
                            <img id="planImage" class="plan-image" alt="Plan de la zone">
                            <!-- Hotspots will be added here -->
                        </div>
                    </div>
                    <div id="noZoneMessage" class="text-gray-500 text-center">
                        <div class="text-6xl mb-4">üè¢</div>
                        <p>S√©lectionnez une zone pour afficher son plan</p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Notation -->
            <div class="w-[500px] bg-white border-l flex flex-col" id="notationPanel">
                <div class="flex items-center justify-between p-4 border-b flex-shrink-0">
                    <h2 class="text-lg font-semibold">Notation</h2>
                    <button id="notationCloseBtn" class="text-sm text-gray-600 px-2 py-1 rounded hover:bg-gray-100">Fermer</button>
                </div>
                <div id="notationContent" class="text-gray-500 text-center p-4 overflow-y-auto flex-1">
                    <div class="text-4xl mb-2">üìù</div>
                    <p>Cliquez sur un √©l√©ment du plan pour le noter</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Mode -->
    <div id="adminMode" class="hidden h-full bg-gray-50">
        <header class="bg-white shadow-sm border-b px-6 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Mode Administration</h1>
                <button id="exitAdminBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                    Retour
                </button>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <!-- Admin Left Panel -->
            <div class="w-80 bg-white border-r p-4">
                <div class="space-y-4">
                    <button id="createZoneBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        ‚ûï Cr√©er une Zone
                    </button>
                    <button id="importZoneBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        üì• Importer Zone/Librairie
                    </button>
                    <button id="exportLibraryBtn" class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                        üì§ Exporter Librairie
                    </button>
                </div>

                <div class="mt-4 p-3 bg-gray-100 rounded">
                    <h3 class="font-semibold mb-2 text-sm">Filtres de Cat√©gorie</h3>
                    <div class="flex gap-2 flex-wrap">
                        <label class="inline-flex items-center text-sm"><input type="checkbox" value="MR" onchange="renderAdminZoneList()" class="mr-1">MR</label>
                        <label class="inline-flex items-center text-sm"><input type="checkbox" value="PRM" onchange="renderAdminZoneList()" class="mr-1">PRM</label>
                        <label class="inline-flex items-center text-sm"><input type="checkbox" value="SC" onchange="renderAdminZoneList()" class="mr-1">SC</label>
                        <label class="inline-flex items-center text-sm"><input type="checkbox" value="Administratif" onchange="renderAdminZoneList()" class="mr-1">Administratif</label>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="font-semibold mb-3">Zones Existantes</h3>
                    <div id="adminZoneList" class="space-y-2">
                        <!-- Admin zone list -->
                    </div>
                </div>
            </div>

            <!-- Admin Center Panel -->
            <div class="flex-1 p-4">
                <div id="adminContent" class="text-center text-gray-500">
        <!-- Modals will be inserted here -->

        <script>
            // Application State
            let currentCampaign = '2025Q4';
            let currentZone = null;
            let currentFloor = null; // newly selected floor within currentZone
            let currentElement = null;
            let zones = [];
            let inspections = [];
            let isAdminMode = false;

            // Criteria definitions
            const CRITERIA = {
                extincteur: {
                    'acces_degage': 'Acc√®s d√©gag√©',
                    'etat': '√âtat',
                    'fixation': 'Fixation',
                    'goupille': 'Goupille',
                    'entretien': 'Entretien',
                    'cinq_s': '5S'
                },
                sortie: {
                    'acces_degage': 'Acc√®s d√©gag√©',
                    'signaletique': 'Signal√©tique',
                    'barre_antipanique': 'Barre antipanique'
                },
                dm: {
                    'etat': '√âtat',
                    'accessibilite': 'Accessibilit√©'
                }
            };

            const ZONE_CRITERIA = {
                'ria': {
                    'acces': 'Acc√®s',
                    'etat': '√âtat',
                    'entretien_annuel': 'Entretien annuel'
                },
                'poteaux': {
                    'acces': 'Acc√®s',
                    'etat': '√âtat'
                },
                'desenfumage': {
                    'acces': 'Acc√®s',
                    'etat': '√âtat',
                    'entretien_annuel': 'Entretien annuel'
                },
                'circulation_issues': {
                    'acces': 'Acc√®s',
                    'barre_antipanique': 'Barre antipanique'
                },
                'eclairage': {
                    'veilleuse': 'Veilleuse',
                    'sati_voyant': 'SATI (voyant)',
                    'voyant_test_vert': 'Voyant test vert'
                },
                'consignes_plans': {
                    'affichage': 'Affichage',
                    'maj': 'MAJ',
                    'lisible': 'Lisible'
                },
                'gf_sf': {
                    'brassards': 'Brassards',
                    'liste_agents': 'Liste agents'
                },
                'chargeurs': {
                    'plomb': 'Plomb',
                    'lithium': 'Lithium',
                    'affichage_prevention': 'Affichage pr√©vention',
                    'extincteur_adapte': 'Extincteur adapt√©'
                },
                'agent_sait': {
                    'q1_appuyer_dm': 'Q1 Appuyer DM',
                    'q2_appeler_poste': 'Q2 Appeler poste',
                    'q3_attaquer_si_possible': 'Q3 Attaquer si possible',
                    'q4_evacuer': 'Q4 √âvacuer'
                }
            };

            // Add updateKPIs function
            function updateKPIs() {
                // Mettre √† jour l'indicateur de stockage
                updateStorageIndicator();
                
                // si pas de zone s√©lectionn√©e, remettre tout √† z√©ro
                if (!currentZone) {
                    const reset = id => { const el = document.getElementById(id); if (el) el.textContent = '0%'; };
                    reset('kpiExtincteurs');
                    reset('kpiDM');
                    reset('kpiSorties');
                    reset('kpiBatiment');
                    return;
                }

                // KPI par type d'√©l√©ments
                // use current floor elements when available
                const floorElements = currentFloor?.elements || { extincteurs: [], dm: [], sorties: [] };
                const criteriaTypes = {
                    'extincteur': floorElements.extincteurs || [],
                    'dm': floorElements.dm || [],
                    'sortie': floorElements.sorties || []
                };

                Object.entries(criteriaTypes).forEach(([type, elements]) => {
                    const total = elements.length;
                    const elementId = `kpi${type === 'sortie' ? 'Sorties' : type === 'extincteur' ? 'Extincteurs' : 'DM'}`;
                    const el = document.getElementById(elementId);
                    if (!el) return;

                    if (total === 0) {
                        el.textContent = 'N/A';
                        return;
                    }

                    let completed = 0;
                    elements.forEach(item => {
                        const insp = getElementInspection(type, item);
                        if (insp && isElementCompleted(insp)) completed++;
                    });

                    const percent = Math.round((completed / total) * 100);
                    el.textContent = `${percent}% (${completed}/${total})`;
                });

                // KPI B√¢timent -> bas√© sur la checklist zone
                const batimentEl = document.getElementById('kpiBatiment');
                if (!batimentEl) return;

                const zoneInspection = getZoneInspection(); // peut √™tre undefined
                // rassembler toutes les cl√©s activ√©es (format section_key)
                const enabledZoneKeys = [];
                Object.entries(ZONE_CRITERIA).forEach(([section]) => {
                    const enabled = currentZone.enabledCriteria?.zone?.[section] || [];
                    enabled.forEach(key => enabledZoneKeys.push(`${section}_${key}`));
                });

                const totalZoneCriteria = enabledZoneKeys.length;
                if (totalZoneCriteria === 0) {
                    batimentEl.textContent = 'N/A';
                    return;
                }

                let completedZoneCriteria = 0;
                if (zoneInspection && zoneInspection.criteria) {
                    enabledZoneKeys.forEach(fullKey => {
                        if (zoneInspection.criteria[fullKey] && zoneInspection.criteria[fullKey] !== '') {
                            completedZoneCriteria++;
                        }
                    });
                }

                const pct = Math.round((completedZoneCriteria / totalZoneCriteria) * 100);
                batimentEl.textContent = `${pct}%`;
            }

            // Clean up event listeners setup and remove duplicate toggleLeftPanel
            function setupEventListeners() {
                // Campaign select
                const campaignSelect = document.getElementById('campaignSelect');
                if (campaignSelect) campaignSelect.addEventListener('change', e => {
                    currentCampaign = e.target.value;
                    // Update KPIs and visual state for the selected campaign
                    updateKPIs();
                    // Recreate hotspots so their 'completed' (green) state reflects the new campaign's inspections
                    try { addHotspots(); } catch (err) { console.debug('addHotspots error on campaign change', err); }
                    // Update admin elements completion state if admin UI is visible
                    try { renderAdminElements(); } catch (err) { console.debug('renderAdminElements error on campaign change', err); }
                    // Update non-conformities view if open
                    try { updateNonConformitiesView(); } catch (err) { /* ignore if modal not open */ }
                });

                // Zone select
                const zoneSelect = document.getElementById('zoneSelect');
                if (zoneSelect) zoneSelect.addEventListener('change', e => {
                    if (e.target.value) {
                        selectZone(e.target.value);
                    } else {
                        currentZone = null;
                        document.getElementById('currentZoneName').textContent = 'S√©lectionnez une zone';
                        document.getElementById('zoneChecklistBtn').classList.add('hidden');
                        document.getElementById('planContainer').classList.add('hidden');
                        document.getElementById('noZoneMessage').classList.remove('hidden');
                        updateKPIs();
                    }
                });

                // Admin mode toggle
                const adminModeBtn = document.getElementById('adminModeBtn');
                if (adminModeBtn) adminModeBtn.addEventListener('click', () => toggleAdminMode(true));

                // Dashboard button
                const dashboardBtn = document.getElementById('dashboardBtn');
                if (dashboardBtn) dashboardBtn.addEventListener('click', showDashboard);

                // Export button
                const exportBtn = document.getElementById('exportBtn');
                if (exportBtn) exportBtn.addEventListener('click', showExportModal);

                // Non-Conformit√©s button
                const nonConformitesBtn = document.getElementById('nonConformitesBtn');
                if (nonConformitesBtn) nonConformitesBtn.addEventListener('click', showNonConformitiesModal);

                // Zone checklist button
                const zoneChecklistBtn = document.getElementById('zoneChecklistBtn');
                if (zoneChecklistBtn) zoneChecklistBtn.addEventListener('click', showZoneChecklist);

                // Notation panel close button
                const notationCloseBtn = document.getElementById('notationCloseBtn');
                if (notationCloseBtn) notationCloseBtn.addEventListener('click', closeNotationPanel);

                // Left panel toggle
                const leftPanelToggleBtn = document.getElementById('leftPanelToggleBtn');
                if (leftPanelToggleBtn) leftPanelToggleBtn.addEventListener('click', toggleLeftPanel);
            }

            // Initialize application
            async function init() {
                await loadData();
                setupEventListeners();
                renderZoneList();
                updateKPIs();
                updateStorageIndicator(); // Afficher l'√©tat du stockage
                applyLeftPanelState(); // apply saved collapsed state
                initDarkMode(); // Initialiser le mode sombre
                
                // Tenter de charger TICP.json si disponible (pour synchronisation)
                await tryLoadTICPJson();
            }
            
            // Mode sombre
            function initDarkMode() {
                const darkMode = localStorage.getItem('darkMode') === 'true';
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
                }
                
                document.getElementById('darkModeToggle').addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const isDark = document.body.classList.contains('dark-mode');
                    localStorage.setItem('darkMode', isDark);
                    document.getElementById('darkModeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
                });
            }
            
            // Visionneuse de photos
            let photoViewerState = {
                photos: [],
                currentIndex: 0,
                zoom: 1,
                rotation: 0
            };
            
            function openPhotoViewer(photos, startIndex = 0) {
                photoViewerState.photos = photos;
                photoViewerState.currentIndex = startIndex;
                photoViewerState.zoom = 1;
                photoViewerState.rotation = 0;
                
                const viewer = document.createElement('div');
                viewer.className = 'photo-viewer';
                viewer.id = 'photoViewer';
                viewer.innerHTML = `
                    <div class="photo-viewer-content">
                        <button class="photo-viewer-close" onclick="closePhotoViewer()">√ó</button>
                        ${photos.length > 1 ? `
                            <button class="photo-viewer-nav prev" onclick="prevPhoto()">‚Äπ</button>
                            <button class="photo-viewer-nav next" onclick="nextPhoto()">‚Ä∫</button>
                        ` : ''}
                        <img id="viewerImage" class="photo-viewer-image" src="${photos[startIndex]}" alt="Photo">
                        <div class="photo-viewer-controls">
                            <button class="photo-viewer-btn" onclick="zoomIn()" title="Zoom +">üîç+</button>
                            <button class="photo-viewer-btn" onclick="zoomOut()" title="Zoom -">üîç-</button>
                            <button class="photo-viewer-btn" onclick="rotateLeft()" title="Rotation ‚Ü∂">‚Ü∂</button>
                            <button class="photo-viewer-btn" onclick="rotateRight()" title="Rotation ‚Ü∑">‚Ü∑</button>
                            <button class="photo-viewer-btn" onclick="resetView()" title="R√©initialiser">‚ü≤</button>
                            ${photos.length > 1 ? `<span class="text-white mx-2">${startIndex + 1}/${photos.length}</span>` : ''}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(viewer);
                updatePhotoTransform();
                
                // Fermer avec Echap
                document.addEventListener('keydown', photoViewerKeyHandler);
            }
            
            function closePhotoViewer() {
                const viewer = document.getElementById('photoViewer');
                if (viewer) {
                    viewer.remove();
                    document.removeEventListener('keydown', photoViewerKeyHandler);
                }
            }
            
            function photoViewerKeyHandler(e) {
                if (e.key === 'Escape') closePhotoViewer();
                if (e.key === 'ArrowLeft') prevPhoto();
                if (e.key === 'ArrowRight') nextPhoto();
            }
            
            function updatePhotoTransform() {
                const img = document.getElementById('viewerImage');
                if (img) {
                    img.style.transform = `scale(${photoViewerState.zoom}) rotate(${photoViewerState.rotation}deg)`;
                }
            }
            
            function updatePhotoCounter() {
                const viewer = document.getElementById('photoViewer');
                if (viewer && photoViewerState.photos.length > 1) {
                    const counter = viewer.querySelector('.photo-viewer-controls span');
                    if (counter) {
                        counter.textContent = `${photoViewerState.currentIndex + 1}/${photoViewerState.photos.length}`;
                    }
                }
            }
            
            function prevPhoto() {
                if (photoViewerState.currentIndex > 0) {
                    photoViewerState.currentIndex--;
                    photoViewerState.zoom = 1;
                    photoViewerState.rotation = 0;
                    document.getElementById('viewerImage').src = photoViewerState.photos[photoViewerState.currentIndex];
                    updatePhotoTransform();
                    updatePhotoCounter();
                }
            }
            
            function nextPhoto() {
                if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
                    photoViewerState.currentIndex++;
                    photoViewerState.zoom = 1;
                    photoViewerState.rotation = 0;
                    document.getElementById('viewerImage').src = photoViewerState.photos[photoViewerState.currentIndex];
                    updatePhotoTransform();
                    updatePhotoCounter();
                }
            }
            
            function zoomIn() {
                photoViewerState.zoom = Math.min(photoViewerState.zoom + 0.25, 4);
                updatePhotoTransform();
            }
            
            function zoomOut() {
                photoViewerState.zoom = Math.max(photoViewerState.zoom - 0.25, 0.5);
                updatePhotoTransform();
            }
            
            function rotateLeft() {
                photoViewerState.rotation -= 90;
                updatePhotoTransform();
            }
            
            function rotateRight() {
                photoViewerState.rotation += 90;
                updatePhotoTransform();
            }
            
            function resetView() {
                photoViewerState.zoom = 1;
                photoViewerState.rotation = 0;
                updatePhotoTransform();
            }
            
            // Tableau de bord avec graphiques
            function showDashboard() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 1200px;">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold">üìä Tableaux de Bord</h2>
                            <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Graphique √©volution des non-conformit√©s -->
                            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                                <h3 class="text-lg font-semibold mb-4">√âvolution des Non-Conformit√©s</h3>
                                <canvas id="nonConformitiesChart"></canvas>
                            </div>
                            
                            <!-- Graphique √©volution de la conformit√© -->
                            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                                <h3 class="text-lg font-semibold mb-4">√âvolution de la Conformit√© (%)</h3>
                                <canvas id="conformityEvolutionChart"></canvas>
                            </div>
                            
                            <!-- Graphique taux de conformit√© par cat√©gorie -->
                            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                                <h3 class="text-lg font-semibold mb-4">Taux de Conformit√© par Cat√©gorie</h3>
                                <canvas id="categoryChart"></canvas>
                            </div>
                            
                            <!-- Statistiques globales -->
                            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                                <h3 class="text-lg font-semibold mb-4">Statistiques Globales</h3>
                                <div id="globalStats" class="space-y-2"></div>
                            </div>
                            
                            <!-- Graphique r√©partition par type d'√©l√©ment -->
                            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow col-span-1 md:col-span-2">
                                <h3 class="text-lg font-semibold mb-4">R√©partition des Non-Conformit√©s par Type</h3>
                                <div class="flex justify-center">
                                    <canvas id="elementTypeChart" style="max-width: 400px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // G√©n√©rer les graphiques
                setTimeout(() => {
                    generateNonConformitiesChart();
                    generateConformityEvolutionChart();
                    generateCategoryChart();
                    generateGlobalStats();
                    generateElementTypeChart();
                }, 100);
            }
            
            function generateNonConformitiesChart() {
                const campaigns = ['2025Q1', '2025Q2', '2025Q3', '2025Q4'];
                const data = campaigns.map(campaign => {
                    return inspections.filter(insp => 
                        insp.campaign === campaign && 
                        insp.criteria && 
                        Object.values(insp.criteria).includes('non')
                    ).length;
                });
                
                const ctx = document.getElementById('nonConformitiesChart');
                if (!ctx) return;
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: campaigns,
                        datasets: [{
                            label: 'Non-Conformit√©s',
                            data: data,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            function generateConformityEvolutionChart() {
                const campaigns = ['2025Q1', '2025Q2', '2025Q3', '2025Q4'];
                const conformityRates = campaigns.map(campaign => {
                    const totalInspections = inspections.filter(insp => insp.campaign === campaign).length;
                    const nonConformInspections = inspections.filter(insp => 
                        insp.campaign === campaign && 
                        insp.criteria && 
                        Object.values(insp.criteria).includes('non')
                    ).length;
                    
                    return totalInspections > 0 
                        ? Math.round(((totalInspections - nonConformInspections) / totalInspections) * 100)
                        : 0;
                });
                
                const ctx = document.getElementById('conformityEvolutionChart');
                if (!ctx) return;
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: campaigns,
                        datasets: [{
                            label: 'Taux de Conformit√© (%)',
                            data: conformityRates,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: value => value + '%'
                                }
                            }
                        }
                    }
                });
            }
            
            function generateCategoryChart() {
                const categories = ['MR', 'SC', 'PRM', 'Administratif'];
                const stats = categories.map(category => {
                    const categoryZones = zones.filter(zone => {
                        const cat = zone.category.startsWith('Administratif:') ? 'Administratif' : zone.category;
                        return cat === category;
                    });
                    
                    const zoneIds = categoryZones.map(z => z.id);
                    const totalInspections = inspections.filter(insp => 
                        insp.campaign === currentCampaign && 
                        zoneIds.includes(insp.zoneId)
                    ).length;
                    
                    const nonConformInspections = inspections.filter(insp => 
                        insp.campaign === currentCampaign && 
                        zoneIds.includes(insp.zoneId) &&
                        insp.criteria && 
                        Object.values(insp.criteria).includes('non')
                    ).length;
                    
                    return totalInspections > 0 
                        ? Math.round(((totalInspections - nonConformInspections) / totalInspections) * 100)
                        : 0;
                });
                
                const ctx = document.getElementById('categoryChart');
                if (!ctx) return;
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: categories,
                        datasets: [{
                            label: 'Taux de Conformit√© (%)',
                            data: stats,
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.6)',
                                'rgba(16, 185, 129, 0.6)',
                                'rgba(245, 158, 11, 0.6)',
                                'rgba(139, 92, 246, 0.6)'
                            ],
                            borderColor: [
                                '#3b82f6',
                                '#10b981',
                                '#f59e0b',
                                '#8b5cf6'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: value => value + '%'
                                }
                            }
                        }
                    }
                });
            }
            
            function generateGlobalStats() {
                const totalZones = zones.length;
                const totalInspections = inspections.filter(i => i.campaign === currentCampaign).length;
                const nonConformities = inspections.filter(i => 
                    i.campaign === currentCampaign && 
                    i.criteria && 
                    Object.values(i.criteria).includes('non')
                ).length;
                const withPhotos = inspections.filter(i => 
                    i.campaign === currentCampaign && 
                    i.photos && i.photos.length > 0
                ).length;
                
                const conformityRate = totalInspections > 0 
                    ? Math.round(((totalInspections - nonConformities) / totalInspections) * 100)
                    : 0;
                
                const statsDiv = document.getElementById('globalStats');
                if (!statsDiv) return;
                
                statsDiv.innerHTML = `
                    <div class="flex justify-between p-3 bg-blue-100 dark:bg-blue-800 rounded">
                        <span class="font-medium text-blue-900 dark:text-blue-100">Total Zones:</span>
                        <span class="font-bold text-blue-900 dark:text-blue-50">${totalZones}</span>
                    </div>
                    <div class="flex justify-between p-3 bg-green-100 dark:bg-green-800 rounded">
                        <span class="font-medium text-green-900 dark:text-green-100">Inspections (${currentCampaign}):</span>
                        <span class="font-bold text-green-900 dark:text-green-50">${totalInspections}</span>
                    </div>
                    <div class="flex justify-between p-3 bg-red-100 dark:bg-red-800 rounded">
                        <span class="font-medium text-red-900 dark:text-red-100">Non-Conformit√©s:</span>
                        <span class="font-bold text-red-900 dark:text-red-50">${nonConformities}</span>
                    </div>
                    <div class="flex justify-between p-3 bg-purple-100 dark:bg-purple-800 rounded">
                        <span class="font-medium text-purple-900 dark:text-purple-100">Avec Photos:</span>
                        <span class="font-bold text-purple-900 dark:text-purple-50">${withPhotos}</span>
                    </div>
                    <div class="flex justify-between p-3 bg-yellow-100 dark:bg-yellow-800 rounded">
                        <span class="font-medium text-yellow-900 dark:text-yellow-100">Taux de Conformit√©:</span>
                        <span class="font-bold text-lg text-yellow-900 dark:text-yellow-50">${conformityRate}%</span>
                    </div>
                `;
            }
            
            function generateElementTypeChart() {
                const types = ['extincteur', 'dm', 'sortie', 'zone'];
                const typeLabels = {
                    'extincteur': 'Extincteurs',
                    'dm': 'DM',
                    'sortie': 'Sorties',
                    'zone': 'Zones'
                };
                
                const data = types.map(type => {
                    return inspections.filter(insp => 
                        insp.campaign === currentCampaign && 
                        insp.type === type &&
                        insp.criteria && 
                        Object.values(insp.criteria).includes('non')
                    ).length;
                });
                
                const ctx = document.getElementById('elementTypeChart');
                if (!ctx) return;
                
                const chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: types.map(t => typeLabels[t]),
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.6)',
                                'rgba(245, 158, 11, 0.6)',
                                'rgba(16, 185, 129, 0.6)',
                                'rgba(59, 130, 246, 0.6)'
                            ],
                            borderColor: [
                                '#ef4444',
                                '#f59e0b',
                                '#10b981',
                                '#3b82f6'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { 
                                position: 'bottom'
                            }
                        },
                        onClick: (event, activeElements) => {
                            if (activeElements.length > 0) {
                                const index = activeElements[0].index;
                                const type = types[index];
                                showNonConformitiesByType(type, typeLabels[type]);
                            }
                        }
                    }
                });
            }
            
            function showNonConformitiesByType(type, typeLabel) {
                // R√©cup√©rer toutes les non-conformit√©s pour ce type
                const nonConformities = inspections.filter(insp => 
                    insp.campaign === currentCampaign && 
                    insp.type === type &&
                    insp.criteria && 
                    Object.values(insp.criteria).includes('non')
                );
                
                if (nonConformities.length === 0) {
                    alert(`Aucune non-conformit√© trouv√©e pour les ${typeLabel}.`);
                    return;
                }
                
                // Cr√©er le modal avec les d√©tails
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">üìã Non-Conformit√©s : ${typeLabel}</h2>
                            <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <div class="mb-4 p-3 bg-blue-100 dark:bg-blue-800 rounded">
                            <p class="text-sm font-semibold text-blue-900 dark:text-blue-100">
                                Campagne : ${currentCampaign} ‚Ä¢ Total : ${nonConformities.length} non-conformit√©(s)
                            </p>
                        </div>
                        
                        <div class="space-y-4 max-h-96 overflow-y-auto">
                            ${nonConformities.map((insp, idx) => {
                                const zone = zones.find(z => z.id === insp.zoneId);
                                const zoneName = zone ? zone.name : insp.zoneId;
                                
                                // R√©cup√©rer les crit√®res non conformes
                                const nonConformCriteria = Object.entries(insp.criteria || {})
                                    .filter(([key, value]) => value === 'non')
                                    .map(([key, value]) => {
                                        if (type === 'zone') {
                                            const [section, crit] = key.split('_');
                                            return ZONE_CRITERIA[section] && ZONE_CRITERIA[section][crit] 
                                                ? ZONE_CRITERIA[section][crit] 
                                                : key;
                                        } else {
                                            return CRITERIA[type] && CRITERIA[type][key] 
                                                ? CRITERIA[type][key] 
                                                : key;
                                        }
                                    });
                                
                                // Identifier l'√©l√©ment
                                let elementId = '';
                                if (type === 'extincteur') {
                                    elementId = insp.elementData?.id || insp.elementKey || '';
                                } else if (type === 'dm') {
                                    elementId = insp.elementData?.id || insp.elementKey || '';
                                } else if (type === 'sortie') {
                                    elementId = insp.elementData?.id || insp.elementKey || '';
                                }
                                
                                return `
                                    <div class="p-4 bg-white dark:bg-gray-700 border-l-4 border-red-500 rounded shadow">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex-1">
                                                <h3 class="font-bold text-lg text-gray-900 dark:text-gray-100">
                                                    ${typeLabel === 'Zones' ? 'Zone' : typeLabel.slice(0, -1)} ${elementId}
                                                </h3>
                                                <p class="text-sm text-gray-600 dark:text-gray-300">
                                                    üìç Zone : <span class="font-semibold">${zoneName}</span>
                                                </p>
                                            </div>
                                            <span class="text-xs bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-100 px-2 py-1 rounded">
                                                #${idx + 1}
                                            </span>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <p class="text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                                ‚ö†Ô∏è Crit√®res non conformes :
                                            </p>
                                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-800 dark:text-gray-200">
                                                ${nonConformCriteria.map(crit => `<li>${crit}</li>`).join('')}
                                            </ul>
                                        </div>
                                        
                                        ${insp.comments ? `
                                            <div class="mt-3 p-2 bg-yellow-50 dark:bg-yellow-900 rounded">
                                                <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-100">üí¨ Commentaire :</p>
                                                <p class="text-sm text-yellow-900 dark:text-yellow-50">${insp.comments}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${insp.photos && insp.photos.length > 0 ? `
                                            <div class="mt-3">
                                                <p class="text-xs font-semibold text-gray-600 dark:text-gray-300 mb-2">üì∏ Photos (${insp.photos.length}) :</p>
                                                <div class="flex gap-2 overflow-x-auto">
                                                    ${insp.photos.map((photo, pIdx) => `
                                                        <img src="${photo}" 
                                                             class="w-16 h-16 object-cover rounded cursor-pointer hover:opacity-80"
                                                             onclick="openPhotoViewer(${JSON.stringify(insp.photos)}, ${pIdx})"
                                                             title="Cliquez pour agrandir">
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        <div class="mt-3 text-xs text-gray-500 dark:text-gray-400">
                                            üïí ${new Date(insp.timestamp).toLocaleString('fr-FR')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button onclick="this.closest('.modal').remove()" 
                                    class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                Fermer
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // Fonction pour charger TICP.json en arri√®re-plan
            async function tryLoadTICPJson() {
                // Charger TICP.json automatiquement en arri√®re-plan (sans alertes)
                // Cela permet la synchronisation avec un fichier centralis√©
                if (window.location && /^https?:/.test(window.location.protocol)) {
                    const candidates = [
                        'TICP.json',
                        './TICP.json',
                        './data/TICP.json'
                    ];

                    for (const path of candidates) {
                        try {
                            console.info('Tentative de chargement de', path);
                            const resp = await fetch(path, { cache: 'no-cache' });
                            if (!resp.ok) continue;
                            
                            const json = await resp.json();
                            let externalZones = [];
                            
                            if (Array.isArray(json)) {
                                externalZones = json;
                            } else if (json && Array.isArray(json.zones)) {
                                externalZones = json.zones;
                            } else if (json && (json.id || json.name)) {
                                externalZones = [json];
                            }
                            
                            // Smart filtering: check for default category filters in UI
                            const checkboxes = document.querySelectorAll('#categoryFilter input[type="checkbox"][checked]');
                            const defaultCategories = Array.from(checkboxes).map(cb => cb.value);
                            
                            if (defaultCategories.length > 0) {
                                // Filter zones based on default categories
                                const filteredCount = externalZones.length;
                                externalZones = externalZones.filter(zone => defaultCategories.includes(zone.categorie));
                                console.info(`üîç Filtre natif d√©tect√©: ${defaultCategories.join(', ')} - ${externalZones.length}/${filteredCount} zones correspondantes`);
                            }
                            
                            if (externalZones.length > 0) {
                                console.info(`‚úÖ ${externalZones.length} zone(s) trouv√©e(s) dans ${path}`);
                                
                                // Fusionner automatiquement avec gestion intelligente des √©l√©ments
                                if (zones.length > 0) {
                                    let addedZones = 0;
                                    let addedElements = 0;
                                    
                                    externalZones.forEach(extZone => {
                                        const existingZone = zones.find(z => z.id === extZone.id);
                                        
                                        if (!existingZone) {
                                            // Zone n'existe pas : ajouter enti√®rement
                                            zones.push(extZone);
                                            addedZones++;
                                        } else {
                                            // Zone existe : fusionner les √©l√©ments intelligemment
                                            if (extZone.floors && existingZone.floors) {
                                                extZone.floors.forEach(extFloor => {
                                                    const existingFloor = existingZone.floors.find(f => f.id === extFloor.id);
                                                    
                                                    if (!existingFloor) {
                                                        // Floor n'existe pas : ajouter enti√®rement
                                                        existingZone.floors.push(extFloor);
                                                    } else if (extFloor.elements) {
                                                        // Floor existe : fusionner les √©l√©ments
                                                        
                                                        // Fonction helper pour v√©rifier si un √©l√©ment existe d√©j√† (m√™me position)
                                                        const elementExists = (collection, newElement) => {
                                                            const tolerance = 0.01; // 1% de tol√©rance sur la position
                                                            return collection.some(existing => {
                                                                const samePosition = Math.abs(existing.x - newElement.x) < tolerance && 
                                                                                   Math.abs(existing.y - newElement.y) < tolerance;
                                                                const sameId = existing.id && newElement.id && existing.id === newElement.id;
                                                                return samePosition || sameId;
                                                            });
                                                        };
                                                        
                                                        // Fusionner les extincteurs
                                                        if (extFloor.elements.extincteurs) {
                                                            existingFloor.elements.extincteurs = existingFloor.elements.extincteurs || [];
                                                            extFloor.elements.extincteurs.forEach(ext => {
                                                                if (!elementExists(existingFloor.elements.extincteurs, ext)) {
                                                                    existingFloor.elements.extincteurs.push(ext);
                                                                    addedElements++;
                                                                    console.info(`‚ûï Ajout extincteur ${ext.id || 'sans ID'} dans ${existingZone.name} (${extFloor.name})`);
                                                                }
                                                            });
                                                        }
                                                        
                                                        // Fusionner les DM
                                                        if (extFloor.elements.dm) {
                                                            existingFloor.elements.dm = existingFloor.elements.dm || [];
                                                            extFloor.elements.dm.forEach(dm => {
                                                                if (!elementExists(existingFloor.elements.dm, dm)) {
                                                                    existingFloor.elements.dm.push(dm);
                                                                    addedElements++;
                                                                    console.info(`‚ûï Ajout DM ${dm.id || 'sans ID'} dans ${existingZone.name} (${extFloor.name})`);
                                                                }
                                                            });
                                                        }
                                                        
                                                        // Fusionner les sorties
                                                        if (extFloor.elements.sorties) {
                                                            existingFloor.elements.sorties = existingFloor.elements.sorties || [];
                                                            extFloor.elements.sorties.forEach(sortie => {
                                                                if (!elementExists(existingFloor.elements.sorties, sortie)) {
                                                                    existingFloor.elements.sorties.push(sortie);
                                                                    addedElements++;
                                                                    console.info(`‚ûï Ajout sortie dans ${existingZone.name} (${extFloor.name}) √† position (${sortie.x}, ${sortie.y})`);
                                                                }
                                                            });
                                                        }
                                                    }
                                                });
                                            }
                                        }
                                    });
                                    
                                    if (addedZones > 0 || addedElements > 0) {
                                        saveZones();
                                        renderZoneList();
                                        console.info(`‚úÖ Fusion termin√©e : ${addedZones} zone(s) + ${addedElements} √©l√©ment(s) ajout√©(s) depuis ${path}`);
                                    } else {
                                        console.info(`‚ÑπÔ∏è Aucun nouvel √©l√©ment √† ajouter depuis ${path}`);
                                    }
                                } else {
                                    // Pas de zones locales, charger directement
                                    zones = externalZones;
                                    saveZones();
                                    renderZoneList();
                                    console.info(`‚úÖ ${externalZones.length} zone(s) charg√©e(s) depuis ${path}`);
                                }
                                
                                break;
                            }
                        } catch (err) {
                            console.debug('√âchec du chargement de', path, err);
                        }
                    }
                }
            }

            // Load data from localStorage. When the app is served over HTTP(S) (for example
            // via GitHub Pages) try to load `TICP.json` from the repository by default so
            // every user sees the pre-created zones.
            async function loadData() {
                // Essayer d'abord de charger depuis IndexedDB (plus d'espace, prioritaire)
                if (isIndexedDBAvailable()) {
                    try {
                        const idbZones = await loadFromIndexedDB('zones');
                        const idbInspections = await loadFromIndexedDB('inspections');
                        
                        if (idbZones && Array.isArray(idbZones)) {
                            zones = idbZones;
                            console.log('‚úÖ Zones charg√©es depuis IndexedDB');
                        }
                        
                        if (idbInspections && Array.isArray(idbInspections)) {
                            inspections = idbInspections;
                            console.log('‚úÖ Inspections charg√©es depuis IndexedDB');
                        }
                    } catch (err) {
                        console.warn('Erreur lors du chargement depuis IndexedDB, utilisation de localStorage', err);
                    }
                }
                
                // Fallback sur localStorage si IndexedDB n'a rien retourn√©
                if (!zones || zones.length === 0) {
                    const savedZones = localStorage.getItem('fireInspection_zones');
                    if (savedZones) {
                        try {
                            zones = JSON.parse(savedZones);
                            console.log('‚úÖ Zones charg√©es depuis localStorage');
                        } catch (e) {
                            console.error('Erreur parsing savedZones from localStorage, ignoring savedZones', e);
                            zones = [];
                        }
                    }
                }
                
                if (!inspections || inspections.length === 0) {
                    const savedInspections = localStorage.getItem('fireInspection_inspections');
                    if (savedInspections) {
                        try {
                            inspections = JSON.parse(savedInspections);
                            console.log('‚úÖ Inspections charg√©es depuis localStorage');
                        } catch (e) {
                            console.error('Erreur parsing savedInspections from localStorage', e);
                            inspections = [];
                        }
                    }
                }

                // Data migration: convert legacy zone.plan + zone.elements into zone.floors
                if (Array.isArray(zones) && zones.length > 0) {
                    zones = zones.map(z => {
                        if (!z.floors && (z.plan || z.elements)) {
                            const floor = {
                                id: z.defaultFloorId || 'RDC',
                                name: z.defaultFloorName || 'Rez-de-chauss√©e',
                                plan: z.plan || { imageUrl: '', naturalWidth: z.plan?.naturalWidth || 800, naturalHeight: z.plan?.naturalHeight || 600 },
                                elements: z.elements || { extincteurs: [], dm: [], sorties: [] }
                            };
                            z.floors = [floor];
                            // keep legacy fields for backward inspection if needed, but remove to avoid confusion
                            delete z.plan;
                            delete z.elements;
                        }
                        return z;
                    });
                    // persist migration result
                    saveZones();
                }

                // If still empty, fall back to the embedded default
                if (!zones || zones.length === 0) {
                    zones = [{
                        id: 'AT14',
                        name: 'AT14',
                        floors: [
                            {
                                id: 'RDC',
                                name: 'Rez-de-chauss√©e',
                                plan: {
                                    imageUrl: 'data:image/svg+xml;base64,' + btoa(`
                                        <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                                            <rect width="800" height="600" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2"/>
                                            <rect x="50" y="50" width="700" height="500" fill="#e9ecef" stroke="#6c757d" stroke-width="1"/>
                                            <text x="400" y="300" text-anchor="middle" font-family="Arial" font-size="24" fill="#495057">Plan d'exemple - AT14 (RDC)</text>
                                        </svg>
                                    `),
                                    naturalWidth: 800,
                                    naturalHeight: 600
                                },
                                elements: {
                                    extincteurs: [
                                        { id: 'EXT-001', type: 'Poudre', x: 0.2, y: 0.3, size: 0.03 },
                                        { id: 'EXT-002', type: 'CO2', x: 0.8, y: 0.3, size: 0.03 }
                                    ],
                                    dm: [
                                        { id: 'DM-001', x: 0.1, y: 0.7, size: 0.025 },
                                        { id: 'DM-002', x: 0.9, y: 0.7, size: 0.025 }
                                    ],
                                    sorties: [
                                        { x: 0.5, y: 0.1, size: 0.035 },
                                        { x: 0.5, y: 0.9, size: 0.035 }
                                    ]
                                }
                            },
                            {
                                id: '1',
                                name: '1er √©tage',
                                plan: {
                                    imageUrl: 'data:image/svg+xml;base64,' + btoa(`
                                        <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                                            <rect width="800" height="600" fill="#fff7ed" stroke="#fde68a" stroke-width="2"/>
                                            <text x="400" y="300" text-anchor="middle" font-family="Arial" font-size="24" fill="#92400e">Plan d'exemple - AT14 (1er)</text>
                                        </svg>
                                    `),
                                    naturalWidth: 800,
                                    naturalHeight: 600
                                },
                                elements: {
                                    extincteurs: [
                                        { id: 'EXT-101', type: 'Eau', x: 0.4, y: 0.5, size: 0.03 }
                                    ],
                                    dm: [],
                                    sorties: []
                                }
                            }
                        ],
                        enabledCriteria: {
                            extincteur: Object.keys(CRITERIA.extincteur),
                            dm: Object.keys(CRITERIA.dm),
                            sortie: Object.keys(CRITERIA.sortie),
                            zone: Object.keys(ZONE_CRITERIA).reduce((acc, section) => {
                                acc[section] = Object.keys(ZONE_CRITERIA[section]);
                                return acc;
                            }, {})
                        }
                    }];
                    saveZones();
                }
            }

            // Save data to localStorage (robuste face au quota)
            function isQuotaExceeded(e) {
                return e && (e.code === 22 || e.code === 1014 || e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED');
            }

            // Supprime toutes les photos d'inspections pour lib√©rer de l'espace
            function removeAllInspectionPhotos() {
                let removed = 0;
                inspections.forEach(ins => {
                    if (ins.photos && ins.photos.length) {
                        removed += ins.photos.length;
                        ins.photos = [];
                    }
                });
                return removed;
            }

            // Tentatives de sauvegarde avec strategies si quota d√©pass√©
            async function saveZones() {
                // V√©rifier l'espace avant de sauvegarder
                const storageInfo = getStorageInfo();
                console.log(`Utilisation du stockage: ${storageInfo.used}MB / ${storageInfo.limit}MB (${storageInfo.percent}%)`);
                
                // Essayer d'abord IndexedDB si disponible (beaucoup plus d'espace)
                if (isIndexedDBAvailable()) {
                    try {
                        await saveToIndexedDB('zones', zones);
                        console.log('‚úÖ Zones sauvegard√©es dans IndexedDB');
                        // Sauvegarder aussi dans localStorage comme backup (si possible)
                        try {
                            localStorage.setItem('fireInspection_zones', JSON.stringify(zones));
                        } catch (e) {
                            console.debug('localStorage backup failed, but IndexedDB succeeded');
                        }
                        updateStorageIndicator();
                        return;
                    } catch (err) {
                        console.warn('IndexedDB save failed, falling back to localStorage', err);
                    }
                }
                
                // Nettoyage pr√©ventif si > 80%
                if (parseFloat(storageInfo.percent) > 80) {
                    const cleaned = autoCleanStorage();
                    if (cleaned) {
                        console.log(`Nettoyage automatique: ${cleaned.photosRemoved} photos supprim√©es`);
                    }
                }
                
                try {
                    localStorage.setItem('fireInspection_zones', JSON.stringify(zones));
                    updateStorageIndicator(); // Mettre √† jour l'indicateur apr√®s sauvegarde r√©ussie
                } catch (err) {
                    if (isQuotaExceeded(err)) {
                        console.warn('Quota d√©pass√©, tentative de lib√©ration d\'espace...');
                        
                        // 1) tenter de lib√©rer en supprimant photos d'inspection
                        const removedPhotos = removeAllInspectionPhotos();
                        try {
                            localStorage.setItem('fireInspection_inspections', JSON.stringify(inspections));
                            localStorage.setItem('fireInspection_zones', JSON.stringify(zones));
                            const newStorage = getStorageInfo();
                            alert(`‚úÖ Espace lib√©r√© : ${removedPhotos} photo(s) supprim√©es.\n\nStockage: ${newStorage.used}MB / ${newStorage.limit}MB (${newStorage.percent}%)`);
                            return;
                        } catch (err2) {
                            // 2) retirer les plans volumineux des floors (en dernier recours)
                            const threshold = 150 * 1024; // ~150KB
                            let removedPlans = 0;
                            zones.forEach(z => {
                                if (z.floors) {
                                    z.floors.forEach(floor => {
                                        if (floor.plan && floor.plan.imageUrl && floor.plan.imageUrl.length > threshold) {
                                            floor.plan._backupImage = floor.plan.imageUrl; // m√©moire temporaire (non persist√©e)
                                            floor.plan.imageUrl = '';
                                            removedPlans++;
                                        }
                                    });
                                }
                                // Ancien format (compatibility)
                                if (z.plan && z.plan.imageUrl && z.plan.imageUrl.length > threshold) {
                                    z.plan._backupImage = z.plan.imageUrl;
                                    z.plan.imageUrl = '';
                                    removedPlans++;
                                }
                            });
                            try {
                                localStorage.setItem('fireInspection_inspections', JSON.stringify(inspections));
                                localStorage.setItem('fireInspection_zones', JSON.stringify(zones));
                                const newStorage = getStorageInfo();
                                alert(`‚ö†Ô∏è Espace critique : ${removedPlans} image(s) de plan retir√©es.\n\nStockage: ${newStorage.used}MB / ${newStorage.limit}MB\n\nConseils:\n- Exportez vos donn√©es\n- Utilisez des images plus petites\n- Supprimez les anciennes zones`);
                                return;
                            } catch (err3) {
                                console.error('saveZones failed after cleanup', err3);
                                const finalStorage = getStorageInfo();
                                alert(`‚ùå Impossible de sauvegarder.\n\nStockage: ${finalStorage.used}MB / ${finalStorage.limit}MB (${finalStorage.percent}%)\n\nüí° Solutions:\n1. Exportez vos donn√©es (bouton Exporter)\n2. Supprimez des zones inutiles\n3. Videz le cache du navigateur\n4. Utilisez un autre navigateur`);
                            }
                        }
                    } else {
                        console.error('saveZones unexpected error', err);
                        throw err;
                    }
                }
            }

            async function saveInspections() {
                // Essayer d'abord IndexedDB si disponible
                if (isIndexedDBAvailable()) {
                    try {
                        await saveToIndexedDB('inspections', inspections);
                        console.log('‚úÖ Inspections sauvegard√©es dans IndexedDB');
                        // Backup dans localStorage si possible
                        try {
                            localStorage.setItem('fireInspection_inspections', JSON.stringify(inspections));
                        } catch (e) {
                            console.debug('localStorage backup failed, but IndexedDB succeeded');
                        }
                        updateStorageIndicator();
                        return;
                    } catch (err) {
                        console.warn('IndexedDB save failed, falling back to localStorage', err);
                    }
                }
                
                try {
                    localStorage.setItem('fireInspection_inspections', JSON.stringify(inspections));
                    updateStorageIndicator(); // Mettre √† jour l'indicateur apr√®s sauvegarde r√©ussie
                } catch (err) {
                    if (isQuotaExceeded(err)) {
                        const removedPhotos = removeAllInspectionPhotos();
                        try {
                            localStorage.setItem('fireInspection_inspections', JSON.stringify(inspections));
                            const storageInfo = getStorageInfo();
                            alert(`‚úÖ ${removedPhotos} photo(s) supprim√©es.\n\nStockage: ${storageInfo.used}MB / ${storageInfo.limit}MB (${storageInfo.percent}%)`);
                        } catch (err2) {
                            console.error('saveInspections failed after cleanup', err2);
                            const storageInfo = getStorageInfo();
                            alert(`‚ùå Impossible de sauvegarder les inspections.\n\nStockage: ${storageInfo.used}MB / ${storageInfo.limit}MB\n\nüí° Exportez vos donn√©es et supprimez des anciennes zones.`);
                        }
                    } else {
                        console.error('saveInspections unexpected error', err);
                        throw err;
                    }
                }
            }

            // Compression / redimensionnement des images DataURL pour stocker dans localStorage
            // Optimisation agressive pour √©conomiser l'espace
            function compressImage(dataUrl, maxWidth = 1200, quality = 0.65) {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        
                        // R√©duire davantage si l'image est tr√®s grande
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        
                        // Am√©lioration de la qualit√© de rendu avant compression
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Exporter en JPEG avec qualit√© r√©duite
                        let compressed = canvas.toDataURL('image/jpeg', quality);
                        
                        // Si l'image est encore trop grande (>500KB), r√©duire davantage
                        if (compressed.length > 500000) {
                            compressed = canvas.toDataURL('image/jpeg', 0.5);
                        }
                        
                        // Si encore trop grande (>800KB), r√©duire la r√©solution
                        if (compressed.length > 800000) {
                            const smallerWidth = Math.round(width * 0.75);
                            const smallerHeight = Math.round(height * 0.75);
                            canvas.width = smallerWidth;
                            canvas.height = smallerHeight;
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            ctx.drawImage(img, 0, 0, smallerWidth, smallerHeight);
                            compressed = canvas.toDataURL('image/jpeg', 0.5);
                        }
                        
                        resolve(compressed);
                    };
                    img.onerror = () => resolve(dataUrl);
                    img.src = dataUrl;
                });
            }
            
            // Fonction pour calculer l'utilisation du stockage (uniquement pour cette app)
            function getStorageInfo() {
                // Calculer uniquement l'espace utilis√© par notre application
                let appTotal = 0;
                const appKeys = ['fireInspection_zones', 'fireInspection_inspections', 'fireInspection_leftPanelCollapsed'];
                
                appKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value) {
                        appTotal += value.length + key.length;
                    }
                });
                
                // Calculer aussi le total global pour diagnostic
                let globalTotal = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        globalTotal += localStorage[key].length + key.length;
                    }
                }
                
                const appMB = (appTotal / (1024 * 1024)).toFixed(2);
                const globalMB = (globalTotal / (1024 * 1024)).toFixed(2);
                const limitMB = 5; // Limite typique de localStorage
                const percentUsed = ((appTotal / (limitMB * 1024 * 1024)) * 100).toFixed(1);
                
                // Log pour diagnostic
                if (parseFloat(globalMB) - parseFloat(appMB) > 0.5) {
                    console.log(`‚ÑπÔ∏è Stockage global: ${globalMB}MB (dont ${appMB}MB pour cette app, ${(globalMB - appMB).toFixed(2)}MB autres donn√©es)`);
                }
                
                return {
                    used: appMB,           // Uniquement cette app
                    usedGlobal: globalMB,  // Total localStorage
                    limit: limitMB,
                    percent: percentUsed,  // Pourcentage bas√© sur cette app
                    bytes: appTotal,
                    bytesGlobal: globalTotal
                };
            }
            
            // ===== IndexedDB Storage (pour plus d'espace) =====
            const DB_NAME = 'FireInspectionDB';
            const DB_VERSION = 1;
            const STORE_NAME = 'data';
            
            // Ouvrir la base de donn√©es IndexedDB
            function openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME);
                        }
                    };
                });
            }
            
            // Sauvegarder dans IndexedDB
            async function saveToIndexedDB(key, value) {
                try {
                    const db = await openDB();
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.put(value, key);
                    
                    return new Promise((resolve, reject) => {
                        transaction.oncomplete = () => {
                            db.close();
                            resolve();
                        };
                        transaction.onerror = () => {
                            db.close();
                            reject(transaction.error);
                        };
                    });
                } catch (err) {
                    console.error('IndexedDB save error:', err);
                    throw err;
                }
            }
            
            // Lire depuis IndexedDB
            async function loadFromIndexedDB(key) {
                try {
                    const db = await openDB();
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(key);
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => {
                            db.close();
                            resolve(request.result);
                        };
                        request.onerror = () => {
                            db.close();
                            reject(request.error);
                        };
                    });
                } catch (err) {
                    console.error('IndexedDB load error:', err);
                    return null;
                }
            }
            
            // V√©rifier si IndexedDB est disponible
            function isIndexedDBAvailable() {
                return typeof indexedDB !== 'undefined';
            }
            
            // Fonction pour mettre √† jour l'indicateur visuel de stockage
            // Fonction pour mettre √† jour l'indicateur visuel de stockage
            function updateStorageIndicator() {
                const storage = getStorageInfo();
                const storageBar = document.getElementById('storageBar');
                const storageText = document.getElementById('storageText');
                const storageIndicator = document.getElementById('storageIndicator');
                
                if (!storageBar || !storageText || !storageIndicator) return;
                
                const percent = parseFloat(storage.percent);
                storageBar.style.width = `${Math.min(100, percent)}%`;
                storageText.textContent = `${storage.percent}%`;
                
                // Indiquer si IndexedDB est utilis√©
                const usingIndexedDB = isIndexedDBAvailable();
                const storageType = usingIndexedDB ? 'IndexedDB' : 'localStorage';
                
                // Construire le message avec d√©tails
                let tooltipMsg = `App: ${storage.used}MB / ${storage.limit}MB (${storageType})`;
                
                // Ajouter info sur le stockage global si diff√©rent
                if (storage.usedGlobal && parseFloat(storage.usedGlobal) > parseFloat(storage.used) + 0.1) {
                    tooltipMsg += `\nGlobal: ${storage.usedGlobal}MB (autres donn√©es)`;
                }
                
                // Changer la couleur selon le niveau d'utilisation de l'app
                if (percent < 60) {
                    storageBar.className = 'h-full bg-green-500 transition-all duration-300';
                    storageIndicator.title = `${tooltipMsg}\nStatut: Bon ‚úì`;
                } else if (percent < 80) {
                    storageBar.className = 'h-full bg-yellow-500 transition-all duration-300';
                    storageIndicator.title = `${tooltipMsg}\nStatut: Attention ‚ö†`;
                } else if (percent < 95) {
                    storageBar.className = 'h-full bg-orange-500 transition-all duration-300';
                    storageIndicator.title = `${tooltipMsg}\nStatut: Critique !`;
                } else {
                    storageBar.className = 'h-full bg-red-500 transition-all duration-300';
                    storageIndicator.title = `${tooltipMsg}\nStatut: PLEIN !`;
                }
            }
            
            // Fonction pour nettoyer automatiquement l'espace
            function autoCleanStorage() {
                const storage = getStorageInfo();
                
                // Si on d√©passe 80% du quota, nettoyer
                if (parseFloat(storage.percent) > 80) {
                    console.log('Nettoyage automatique du stockage...');
                    
                    // 1. Supprimer les photos d'inspection les plus anciennes
                    let photosRemoved = 0;
                    inspections.forEach(insp => {
                        if (insp.photo) {
                            insp.photo = '';
                            photosRemoved++;
                        }
                    });
                    
                    // 2. Re-compresser les images de plan si n√©cessaire
                    let plansCompressed = 0;
                    zones.forEach(z => {
                        if (z.floors) {
                            z.floors.forEach(floor => {
                                if (floor.plan && floor.plan.imageUrl && floor.plan.imageUrl.length > 300000) {
                                    // Marquer pour re-compression au prochain chargement
                                    plansCompressed++;
                                }
                            });
                        }
                    });
                    
                    return { photosRemoved, plansCompressed };
                }
                
                return null;
            }

            // --- Ajout : utilitaires de positionnement et recalcul syst√©matique ---
    
    // Fonction helper pour calculer les dimensions r√©elles de l'image avec object-fit: contain
    function getImageDisplayedDimensions(img) {
        const naturalWidth = img.naturalWidth || 1;
        const naturalHeight = img.naturalHeight || 1;
        const containerWidth = img.offsetWidth;
        const containerHeight = img.offsetHeight;
        
        // Si les dimensions du conteneur sont nulles, attendre
        if (!containerWidth || !containerHeight) {
            return { displayedWidth: 0, displayedHeight: 0, offsetX: 0, offsetY: 0 };
        }
        
        const naturalRatio = naturalWidth / naturalHeight;
        const containerRatio = containerWidth / containerHeight;
        
        let displayedWidth, displayedHeight, offsetX, offsetY;
        
        if (naturalRatio > containerRatio) {
            // L'image est limit√©e par la largeur
            displayedWidth = containerWidth;
            displayedHeight = containerWidth / naturalRatio;
            offsetX = 0;
            offsetY = (containerHeight - displayedHeight) / 2;
        } else {
            // L'image est limit√©e par la hauteur
            displayedHeight = containerHeight;
            displayedWidth = containerHeight * naturalRatio;
            offsetX = (containerWidth - displayedWidth) / 2;
            offsetY = 0;
        }
        
        return { displayedWidth, displayedHeight, offsetX, offsetY };
    }
    
    function positionElement(el, xPercent, yPercent, isAdminMode = false) {
        const planImageId = isAdminMode ? 'adminPlanImage' : 'planImage';
        
        const planImage = document.getElementById(planImageId);
        
        if (!planImage) {
            // Pas d'image, ne rien faire - attendre
            return;
        }
        
        // V√©rifier que l'image est charg√©e
        if (!planImage.complete || planImage.naturalHeight === 0) {
            // Image pas encore charg√©e, ne rien faire
            return;
        }
        
        // V√©rifier que l'image a des dimensions valides
        if (!planImage.offsetWidth || !planImage.offsetHeight) {
            // Dimensions pas encore calcul√©es, ne rien faire
            return;
        }
        
        // Calculer les dimensions r√©elles avec object-fit: contain
        const dims = getImageDisplayedDimensions(planImage);
        
        if (!dims.displayedWidth || !dims.displayedHeight) {
            // Dimensions pas valides, ne rien faire
            return;
        }
        
        // Position relative au conteneur (avec offset pour centrage)
        const leftPx = dims.offsetX + (xPercent * dims.displayedWidth);
        const topPx = dims.offsetY + (yPercent * dims.displayedHeight);
        
        el.style.position = 'absolute';
        el.style.left = `${leftPx}px`;
        el.style.top = `${topPx}px`;
        el.style.transform = 'translate(-50%, -50%)';
        
        // Taille de l'√©l√©ment : fraction de la largeur affich√©e de l'image
        const size = parseFloat(el.dataset.size);
        if (!isNaN(size)) {
            const px = Math.max(6, Math.round(size * dims.displayedWidth));
            el.style.width = px + 'px';
            el.style.height = px + 'px';
        }
    }

    function repositionHotspots() {
        // Reposition hotspots en mode normal
        const planWrapper = document.getElementById('planWrapper');
        if (planWrapper) {
            planWrapper.querySelectorAll('.hotspot').forEach(h => {
                const x = parseFloat(h.dataset.x);
                const y = parseFloat(h.dataset.y);
                if (!isNaN(x) && !isNaN(y)) {
                    positionElement(h, x, y, false);
                }
            });
        }
        
        // Reposition admin-elements en mode admin
        const adminWrapper = document.getElementById('adminPlanWrapper');
        if (adminWrapper) {
            adminWrapper.querySelectorAll('.admin-element').forEach(a => {
                const x = parseFloat(a.dataset.x);
                const y = parseFloat(a.dataset.y);
                if (!isNaN(x) && !isNaN(y)) {
                    positionElement(a, x, y, true);
                }
            });
        }
    }

    let _repositionTimer = null;
    function scheduleReposition(delay = 200) {
        if (_repositionTimer) clearTimeout(_repositionTimer);
        _repositionTimer = setTimeout(() => {
            repositionHotspots();
            _repositionTimer = null;
        }, delay);
    }

    function createHotspot(type, x, y, elementData) {
        const hotspot = document.createElement('div');
        hotspot.className = `hotspot ${type}`;
        hotspot.dataset.x = String(x);
        hotspot.dataset.y = String(y);
        hotspot.dataset.elementKey = getElementKey(type, elementData);
        hotspot.dataset.size = String(elementData?.size || 0.02);
        
        // Position initiale
        positionElement(hotspot, x, y, false);

        const inspection = getElementInspection(type, elementData);
        if (inspection && isElementCompleted(inspection)) {
            hotspot.classList.add('completed');
        }

        hotspot.addEventListener('click', () => {
            selectElement(type, elementData);
            // Forcer reposition apr√®s affichage du panneau
            scheduleReposition(150);
        });

        return hotspot;
    }

    function closeNotationPanel() {
        currentElement = null;
        const panel = document.getElementById('notationPanel');
        if (panel) panel.classList.add('hidden');
        // Reposition apr√®s fermeture du panneau
        scheduleReposition(150);
    }

    window.addEventListener('resize', () => scheduleReposition(80));
    window.addEventListener('orientationchange', () => scheduleReposition(80));

    const mainPlanImage = document.getElementById('planImage');
    if (mainPlanImage) {
        mainPlanImage.addEventListener('load', () => {
            scheduleReposition(40);
        });
        
        // Observer les changements de taille de l'image (resize, layout changes)
        const imgObserver = new ResizeObserver(() => {
            scheduleReposition(50);
        });
        imgObserver.observe(mainPlanImage);
    }
    
    // Observer le conteneur du plan pour d√©tecter les changements de layout (volet ferm√©/ouvert)
    const planWrapper = document.getElementById('planWrapper');
    if (planWrapper) {
        const wrapperObserver = new ResizeObserver(() => {
            scheduleReposition(100);
        });
        wrapperObserver.observe(planWrapper);
    }
    
    const planContainer = document.getElementById('planContainer');
    if (planContainer) {
        const containerObserver = new ResizeObserver(() => {
            scheduleReposition(100);
        });
        containerObserver.observe(planContainer);
    }

    function toggleLeftPanel() {
        const left = document.getElementById('leftPanel');
        if (!left) return;
        left.classList.toggle('collapsed');
        const isCollapsed = left.classList.contains('collapsed');
        localStorage.setItem('fireInspection_leftPanelCollapsed', isCollapsed ? '1' : '0');
        
        const label = document.getElementById('leftPanelZoneLabel');
        const strip = document.getElementById('leftPanelStrip');
        if (isCollapsed) {
            if (currentZone && strip) strip.textContent = currentZone.name;
            if (label) label.classList.add('hidden');
        } else {
            if (label) label.classList.remove('hidden');
        }
        // Forcer repositionnement imm√©diat puis apr√®s l'animation CSS (250ms)
        repositionHotspots();
        scheduleReposition(300);
    }

    function applyLeftPanelState() {
        const left = document.getElementById('leftPanel');
        if (!left) return;
        const saved = localStorage.getItem('fireInspection_leftPanelCollapsed');
        if (saved === '1') {
            left.classList.add('collapsed');
            const label = document.getElementById('leftPanelZoneLabel');
            if (label) label.classList.add('hidden');
            const strip = document.getElementById('leftPanelStrip');
            if (strip && currentZone) strip.textContent = currentZone.name;
        }
    }

    function showZoneChecklist() {
        if (!currentZone) return;

        const zoneInspection = getZoneInspection() || createZoneInspection();

        const modal = document.createElement('div');
        modal.className = 'modal';
        
        // Calculer la compl√©tude de la zone - affichage initial (la mise √† jour en direct utilisera updateZoneChecklistModalProgress)
        const initialProgress = computeZoneProgress();
        modal.innerHTML = `
            <div class="modal-content w-full max-w-4xl">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">Checklist Zone - ${currentZone.name}</h2>
                        <div class="text-sm text-gray-600 mt-2">
                            Avancement: <span id="zoneChecklistProgress" class="font-bold text-blue-600">${initialProgress.percentage}%</span>
                            <span id="zoneChecklistCounts" class="text-gray-600">(${initialProgress.completed}/${initialProgress.total})</span>
                        </div>
                    </div>
                    <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div class="space-y-6 max-h-96 overflow-y-auto">
                    ${Object.entries(ZONE_CRITERIA).map(([section, criteria]) => `

                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-semibold text-lg mb-3 capitalize">${section.replace(/_/g, ' ')}</h3>
                            <div class="space-y-3">
                                ${Object.entries(criteria).map(([key, label]) => {
                                    const fullKey = `${section}_${key}`;
                                    return `
                                        <div class="criteria-grid">
                                            <label class="text-sm font-medium">${label}</label>
                                            <label class="flex items-center">
                                                <input type="radio" name="${fullKey}" value="oui" 
                                                    ${zoneInspection.criteria[fullKey] === 'oui' ? 'checked' : ''}

                                                    onchange="updateZoneCriteria('${fullKey}', 'oui')" class="mr-1">
                                                <span class="text-green-600">Oui</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="${fullKey}" value="non" 
                                                    ${zoneInspection.criteria[fullKey] === 'non' ? 'checked' : ''}

                                                    onchange="updateZoneCriteria('${fullKey}', 'non')" class="mr-1">
                                                <span class="text-red-600">Non</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="${fullKey}" value="so" 
                                                    ${zoneInspection.criteria[fullKey] === 'so' ? 'checked' : ''}

                                                    onchange="updateZoneCriteria('${fullKey}', 'so')" class="mr-1">
                                                <span class="text-gray-500">S.O.</span>
                                            </label>
                                        </div>
                                    `;
                                }).join('')}

                            </div>
                        </div>
                    `).join('')}

                </div>
                
                <div class="mt-6">
                    <label class="block text-sm font-medium mb-2">Commentaires Zone</label>
                    <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                            rows="3" placeholder="Commentaires g√©n√©raux sur la zone..."
                            onchange="updateZoneComments(this.value)">${zoneInspection.comments || ''}</textarea>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button onclick="this.closest('.modal').remove()" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Fermer
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        // Mettre √† jour les KPI apr√®s les modifications dans la checklist
        updateKPIs();
    }

    function isElementCompleted(inspection) {
        const criteria = CRITERIA[inspection.type] || {};
        const enabledCriteria = currentZone?.enabledCriteria?.[inspection.type] || Object.keys(criteria);

        return enabledCriteria.every(key =>
            inspection.criteria[key] && inspection.criteria[key] !== ''
        );
    }

    // Render floor selector UI when a zone is selected
    function renderFloorSelector() {
        const sel = document.getElementById('floorSelect');
        if (!sel || !currentZone) return;
        const floors = currentZone.floors || [];
        if (floors.length <= 1) {
            sel.classList.add('hidden');
            return;
        }
        sel.classList.remove('hidden');
        sel.innerHTML = floors.map(f => `<option value="${f.id}" ${currentFloor && currentFloor.id === f.id ? 'selected' : ''}>${f.name || f.id}</option>`).join('');
        sel.onchange = (e) => {
            const id = e.target.value;
            const floor = (currentZone.floors || []).find(fi => fi.id === id);
            if (floor) {
                currentFloor = floor;
                const planImage = document.getElementById('planImage');
                if (planImage) {
                    planImage.src = currentFloor.plan?.imageUrl || '';
                    planImage.onload = () => addHotspots();
                }
                updateKPIs();
            }
        };
    }

    function toggleAdminMode(enable) {
        isAdminMode = !!enable;
        const appEl = document.getElementById('app');
        const adminEl = document.getElementById('adminMode');
        if (appEl && adminEl) {
            appEl.classList.toggle('hidden', isAdminMode);
            adminEl.classList.toggle('hidden', !isAdminMode);
        }

        if (isAdminMode) {
            // render admin UI and reattach admin action buttons
            renderAdminZoneList();
            renderAdminContent();

            const createBtn = document.getElementById('createZoneBtn');
            if (createBtn) createBtn.onclick = createNewZone;
            const importBtn = document.getElementById('importZoneBtn');
            if (importBtn) importBtn.onclick = showImportModal;
            const exportLibraryBtn = document.getElementById('exportLibraryBtn');
            if (exportLibraryBtn) exportLibraryBtn.onclick = exportLibrary;
            const exitBtn = document.getElementById('exitAdminBtn');
            if (exitBtn) exitBtn.onclick = () => toggleAdminMode(false);
        } else {
            // leaving admin mode: refresh main view
            renderZoneList();
            if (currentZone) {
                const mainPlanImage = document.getElementById('planImage');
                const planUrl = currentFloor?.plan?.imageUrl || '';
                if (mainPlanImage && mainPlanImage.src !== planUrl) {
                    mainPlanImage.src = planUrl;
                    mainPlanImage.onload = () => addHotspots();
                } else {
                    addHotspots();
                }
                updateKPIs();
            }
        }
    }

    function hasNonConformities(zone) {
        return inspections.some(inspection => 
            inspection.campaign === currentCampaign && 
            inspection.zoneId === zone.id && 
            inspection.criteria && 
            Object.values(inspection.criteria).includes('non')
        );
    }

    function renderZoneList() {
        const container = document.getElementById('zoneSelect');
        const filterChecked = document.getElementById('filterNonCompliant')?.checked;

        // Get active category filters
        const checkboxes = document.querySelectorAll('#categoryFilter input[type="checkbox"]:checked');
        const activeCategories = Array.from(checkboxes).map(cb => cb.value);

        let filteredZones = zones.slice();

        // Category filter
        if (activeCategories.length > 0) {
            filteredZones = filteredZones.filter(zone => activeCategories.includes(zone.categorie));
        }

        // Filtre optionnel : non-conformit√©s
        if (filterChecked) {
            filteredZones = filteredZones.filter(hasNonConformities);
        }

        // Default sorting by name A‚ÜíZ
        filteredZones.sort((a,b) => (a.name||'').localeCompare(b.name||''));

        container.innerHTML = '<option value="">S√©lectionnez une zone...</option>' +
            filteredZones.map(zone => `
                <option value="${zone.id}" ${currentZone?.id === zone.id ? 'selected' : ''}>
                    ${zone.name} (${zone.id})${zone.category ? ' ‚Äî ' + zone.category : ''}
                </option>
            `).join('');
        // Update left panel compact label when collapsed
        const left = document.getElementById('leftPanel');
        const strip = document.getElementById('leftPanelStrip');
        const leftLabel = document.getElementById('leftPanelZoneLabel');
        if (left && left.classList.contains('collapsed')) {
            if (currentZone && strip) strip.textContent = currentZone.name;
            if (leftLabel) leftLabel.classList.add('hidden');
        } else {
            if (leftLabel) leftLabel.textContent = currentZone ? `${currentZone.name}` : 'Zone S√©lectionn√©e';
        }
    }

    function selectZone(zoneId) {
        currentZone = zones.find(z => z.id === zoneId);
        if (!currentZone) return;

        document.getElementById('currentZoneName').textContent = currentZone.name;
        // update small left label if present
        const leftLabel = document.getElementById('leftPanelZoneLabel');
        if (leftLabel) leftLabel.textContent = currentZone.name;
        const leftStrip = document.getElementById('leftPanelStrip');
        if (leftStrip && document.getElementById('leftPanel')?.classList.contains('collapsed')) {
            leftStrip.textContent = currentZone.name;
        }
        document.getElementById('zoneChecklistBtn').classList.remove('hidden');

        // Initialize currentFloor to first available floor
        currentFloor = (currentZone.floors && currentZone.floors[0]) || null;

        // Show plan
        const planContainer = document.getElementById('planContainer');
        const planImage = document.getElementById('planImage');
        const noZoneMessage = document.getElementById('noZoneMessage');

        if (currentFloor && currentFloor.plan && currentFloor.plan.imageUrl) {
            planImage.src = currentFloor.plan.imageUrl;
        } else {
            planImage.src = '';
        }
        planContainer.classList.remove('hidden');
        noZoneMessage.classList.add('hidden');

        // Populate floor selector
        renderFloorSelector();

        // Add hotspots
        planImage.onload = () => {
            addHotspots();
            renderZoneList(); // Refresh to show selection
            updateKPIs();
        };
    }

    function hasElementNonConformity(type, elementData) {
        const inspection = getElementInspection(type, elementData);
        return inspection && inspection.criteria && Object.values(inspection.criteria).includes('non');
    }

    function addHotspots() {
        const planWrapper = document.getElementById('planWrapper');
        const planImage = document.getElementById('planImage');
        
        if (!planWrapper) return;
        
        // Remove existing hotspots
        planWrapper.querySelectorAll('.hotspot').forEach(h => h.remove());
        
        if (!currentZone || !planImage || !currentFloor) return;
        
        const filterChecked = document.getElementById('filterNonCompliant')?.checked;
        
        // Wait for image to be fully loaded and positioned
        const addHotspotsWhenReady = () => {
            // Add extincteur hotspots (from currentFloor)
            currentFloor.elements.extincteurs?.forEach(ext => {
                if (!filterChecked || hasElementNonConformity('extincteur', ext)) {
                    const hotspot = createHotspot('extincteur', ext.x, ext.y, ext);
                    planWrapper.appendChild(hotspot);
                }
            });
            
            // Add DM hotspots
            currentFloor.elements.dm?.forEach(dm => {
                if (!filterChecked || hasElementNonConformity('dm', dm)) {
                    const hotspot = createHotspot('dm', dm.x, dm.y, dm);
                    planWrapper.appendChild(hotspot);
                }
            });
            
            // Add sortie hotspots
            currentFloor.elements.sorties?.forEach((sortie, index) => {
                if (!filterChecked || hasElementNonConformity('sortie', { ...sortie, index })) {
                    const hotspot = createHotspot('sortie', sortie.x, sortie.y, { ...sortie, index });
                    planWrapper.appendChild(hotspot);
                }
            });
            
            // Reposition apr√®s ajout de tous les hotspots
            scheduleReposition(80);
        };
        
        if (planImage.complete && planImage.naturalHeight !== 0) {
            addHotspotsWhenReady();
        } else {
            planImage.onload = addHotspotsWhenReady;
        }
    }

    function createHotspot(type, x, y, elementData) {
        const hotspot = document.createElement('div');
        hotspot.className = `hotspot ${type}`;
        hotspot.dataset.x = String(x);
        hotspot.dataset.y = String(y);
        if (elementData && elementData.size !== undefined) hotspot.dataset.size = String(elementData.size);
        
        // Position initiale
        positionElement(hotspot, x, y, false);

        const inspection = getElementInspection(type, elementData);
        if (inspection && isElementCompleted(inspection)) {
            hotspot.classList.add('completed');
        }

        hotspot.addEventListener('click', () => {
            selectElement(type, elementData);
            // Forcer reposition apr√®s affichage du panneau
            scheduleReposition(150);
        });

        return hotspot;
    }

    function selectElement(type, elementData) {
        currentElement = { type, data: elementData };
        // show notation panel
        const panel = document.getElementById('notationPanel');
        if (panel) {
            panel.classList.remove('hidden');
            // Reposition apr√®s changement de layout
            setTimeout(() => scheduleReposition(100), 50);
        }
        renderNotationPanel();
    }

    function renderNotationPanel() {
        const container = document.getElementById('notationContent');
        
        if (!currentElement) {
            container.innerHTML = `
                <div class="text-gray-500 text-center">
                    <div class="text-4xl mb-2">üìù</div>
                    <p>Cliquez sur un √©l√©ment du plan pour le noter</p>
                </div>
            `;
            return;
        }
        
        const { type, data } = currentElement;
        const criteria = CRITERIA[type] || {};
        const inspection = getElementInspection(type, data) || createElementInspection(type, data);
        
        let title = type.charAt(0).toUpperCase() + type.slice(1);
        
        // Afficher le num√©ro/ID en √©vidence pour extincteurs et DM
        if (type === 'extincteur' || type === 'dm') {
            if (data.id) {
                title = `<span class="text-gray-600">${type === 'extincteur' ? 'Extincteur' : 'DM'}</span> <span class="text-2xl font-bold text-blue-600">N¬∞${data.id}</span>`;
            } else {
                title = `<span class="text-gray-600">${type === 'extincteur' ? 'Extincteur' : 'DM'}</span> <span class="text-red-600 text-sm">(pas de num√©ro)</span>`;
            }
            if (type === 'extincteur' && data.type) {
                title += ` <span class="text-sm text-gray-500">(${data.type})</span>`;
            }
        } else {
            // Pour les sorties ou autres
            if (data.id) title += ` - ${data.id}`;
            if (data.type) title += ` (${data.type})`;
        }
        
        // Afficher la quantit√© si c'est un extincteur
        const quantity = data.quantity || 1;
        if (type === 'extincteur' && quantity > 1) {
            title += ` <span class="text-sm bg-orange-100 text-orange-800 px-2 py-1 rounded">[√ó${quantity}]</span>`;
        }
        
        // Calculer la compl√©tude de cet √©l√©ment
        const enabledCriteria = currentZone?.enabledCriteria?.[type] || Object.keys(criteria);
        const completedCount = enabledCriteria.filter(key => inspection.criteria[key] && inspection.criteria[key] !== '').length;
        const percentage = Math.round((completedCount / enabledCriteria.length) * 100);
        
        container.innerHTML = `
            <div class="text-left">
                <div class="mb-4 pb-3 border-b">
                    <h3 class="font-semibold text-lg">${title}</h3>
                    <div class="text-sm text-gray-600 mt-2">
                        Avancement: <span class="font-bold text-blue-600">${percentage}%</span> (${completedCount}/${enabledCriteria.length})
                    </div>
                </div>
                
                ${(type === 'extincteur' || type === 'dm') ? `
                <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                    <h4 class="text-sm font-semibold text-yellow-800 mb-3">‚úèÔ∏è Modifier l'√©l√©ment</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Num√©ro ${type === 'extincteur' ? 'de l\'extincteur' : 'du DM'}</label>
                            <input type="text" id="elementIdInput" value="${data.id || ''}" 
                                onchange="updateElementId(this.value)"
                                placeholder="${type === 'extincteur' ? 'EXT-001' : 'DM-001'}"
                                class="w-full px-3 py-2 border border-yellow-300 rounded-md text-sm font-semibold">
                        </div>
                        ${type === 'extincteur' ? `
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Type d'extincteur</label>
                            <select id="elementTypeSelect" onchange="updateElementType(this.value)"
                                class="w-full px-3 py-2 border border-yellow-300 rounded-md text-sm">
                                <option value="">-- S√©lectionner --</option>
                                ${EXTINGUISHER_TYPES.map(t => `<option value="${t}" ${data.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                            </select>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
                
                <div class="space-y-4">
                    ${Object.entries(criteria).map(([key, label]) => `
                        <div class="criteria-grid">
                            <label class="text-sm font-medium">${label}</label>
                            <label class="flex items-center">
                                <input type="radio" name="${key}" value="oui" 
                                    ${inspection.criteria[key] === 'oui' ? 'checked' : ''}

                                    onchange="updateCriteria('${key}', 'oui')" class="mr-1">
                                <span class="text-green-600">Oui</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="${key}" value="non" 
                                    ${inspection.criteria[key] === 'non' ? 'checked' : ''}

                                    onchange="updateCriteria('${key}', 'non')" class="mr-1">
                                <span class="text-red-600">Non</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="${key}" value="so" 
                                    ${inspection.criteria[key] === 'so' ? 'checked' : ''}

                                    onchange="updateCriteria('${key}', 'so')" class="mr-1">
                                <span class="text-gray-500">S.O.</span>
                            </label>
                        </div>
                    `).join('')}

                </div>
                
                ${type === 'extincteur' ? `
                <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
                    <label class="block text-sm font-medium mb-2">
                        <span class="text-blue-800">üî¢ Quantit√© d'extincteurs</span>
                        <span class="text-xs text-gray-600 ml-2">(regroupement)</span>
                    </label>
                    <input type="number" min="1" max="99" value="${quantity}" 
                        onchange="updateQuantity(this.value)"
                        class="w-24 px-3 py-2 border border-blue-300 rounded-md text-center font-semibold">
                    <p class="text-xs text-gray-600 mt-1">Indiquez le nombre d'extincteurs √† ce m√™me emplacement</p>
                </div>
                ` : ''}
                
                <div class="mt-6">
                    <label class="block text-sm font-medium mb-2">Commentaires</label>
                    <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                            rows="3" placeholder="Commentaires optionnels..."
                            onchange="updateComments(this.value)">${inspection.comments || ''}</textarea>
                </div>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium mb-2">Photos</label>
                    <input type="file" accept="image/*" multiple 
                        onchange="handlePhotoUpload(event)" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <div id="photoPreview" class="mt-2 grid grid-cols-2 gap-2">
                        ${(inspection.photos || []).map((photo, index) => `
                            <div class="relative cursor-pointer" onclick="openPhotoViewer(${JSON.stringify(inspection.photos)}, ${index})">
                                <img src="${photo}" class="w-full h-20 object-cover rounded border hover:opacity-80 transition-opacity">
                                <button onclick="event.stopPropagation(); removePhoto(${index})" 
                                        class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs hover:bg-red-600">√ó</button>
                                <div class="absolute bottom-1 right-1 bg-black bg-opacity-50 text-white text-xs px-1 rounded">üîç</div>
                            </div>
                        `).join('')}

                    </div>
                </div>
            </div>
        `;
    }

    function updateZoneName(newName) {
        if (!currentZone) return;
        currentZone.name = newName.trim();
    }

    function updateZoneId(newId) {
        if (!currentZone) return;
        
        const trimmedId = newId.trim();
        if (!trimmedId) {
            alert('L\'ID de la zone ne peut pas √™tre vide');
            document.getElementById('editZoneId').value = currentZone.id;
            return;
        }
        
        // V√©rifier si l'ID existe d√©j√† (sauf pour la zone actuelle)
        const existingZone = zones.find(z => z.id === trimmedId && z !== currentZone);
        if (existingZone) {
            alert(`Une zone avec l'ID "${trimmedId}" existe d√©j√† !`);
            document.getElementById('editZoneId').value = currentZone.id;
            return;
        }
        
        const oldId = currentZone.id;
        currentZone.id = trimmedId;
        
        // Mettre √† jour les inspections li√©es √† cette zone
        inspections.forEach(insp => {
            if (insp.zoneId === oldId) {
                insp.zoneId = trimmedId;
            }
        });
        
        saveZones();
        saveInspections();
        
        // Mettre √† jour l'indication du format de fichier
        const formatHint = document.querySelector('.text-xs.text-gray-500');
        if (formatHint && currentFloor) {
            formatHint.textContent = `Format fichier: ID_NomEtage.png (ex: ${trimmedId}_${currentFloor.name}.png)`;
        }
        
        updatePlanFileHint();
        
        alert(`ID de la zone mis √† jour de "${oldId}" vers "${trimmedId}".\nPensez √† renommer vos fichiers images selon le format: ${trimmedId}_NomEtage.png\nExemple: ${trimmedId}_${currentFloor?.name || 'RDC'}.png`);
    }

    function bulkUpdateExtinguisherType() {
        if (!currentZone) return;
        
        // Compter le nombre total d'extincteurs dans la zone
        let totalExtinguishers = 0;
        currentZone.floors.forEach(floor => {
            if (floor.elements && floor.elements.extincteurs) {
                totalExtinguishers += floor.elements.extincteurs.length;
            }
        });
        
        if (totalExtinguishers === 0) {
            alert('Aucun extincteur trouv√© dans cette zone.');
            return;
        }
        
        // Cr√©er une modal pour choisir le nouveau type
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 400px;">
                <h3 class="text-lg font-bold mb-4">Modifier le type de tous les extincteurs</h3>
                <p class="text-sm text-gray-600 mb-4">
                    Cette action va modifier le type de <strong>${totalExtinguishers} extincteur(s)</strong> dans tous les √©tages de la zone.
                </p>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Nouveau type :</label>
                    <select id="bulkExtType" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        ${EXTINGUISHER_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}
                    </select>
                </div>
                <div class="flex gap-2 justify-end">
                    <button onclick="this.closest('.modal').remove()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Annuler
                    </button>
                    <button onclick="confirmBulkUpdateExtinguisherType()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Confirmer
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function confirmBulkUpdateExtinguisherType() {
        const newType = document.getElementById('bulkExtType').value;
        if (!newType || !currentZone) return;
        
        let updatedCount = 0;
        
        // Parcourir tous les √©tages et tous les extincteurs
        currentZone.floors.forEach(floor => {
            if (floor.elements && floor.elements.extincteurs) {
                floor.elements.extincteurs.forEach(ext => {
                    ext.type = newType;
                    updatedCount++;
                });
            }
        });
        
        saveZones();
        renderElementsList();
        renderAdminElements();
        
        // Fermer la modal
        document.querySelector('.modal')?.remove();
        
        alert(`${updatedCount} extincteur(s) mis √† jour vers le type "${newType}".`);
    }

    // Get element inspection
    function getElementInspection(type, elementData) {
        const key = getElementKey(type, elementData);
        return inspections.find(i => 
            i.campaign === currentCampaign && 
            i.zoneId === currentZone.id && 
            i.floorId === (currentFloor?.id || null) &&
            i.elementKey === key
        );
    }

    // Create element inspection
    function createElementInspection(type, elementData) {
        const key = getElementKey(type, elementData);
        const inspection = {
            timestamp: new Date().toISOString(),
            campaign: currentCampaign,
            zoneId: currentZone.id,
            floorId: currentFloor?.id || null,
            elementKey: key,
            type: type,
            elementData: elementData,
            criteria: {},
            comments: '',
            photos: []
        };
        
        inspections.push(inspection);
        saveInspections();
        return inspection;
    }

    // Get element key
    function getElementKey(type, elementData) {
        // include floor id in keys to disambiguate same element ids across floors
        const floorPart = currentFloor?.id ? `${currentFloor.id}_` : '';
        if (type === 'sortie') {
            return `${floorPart}${type}_${elementData.x}_${elementData.y}`;
        }
        return `${floorPart}${type}_${elementData.id || elementData.index}`;
    }

    // Update criteria
    function updateCriteria(criteriaKey, value) {
        if (!currentElement) return;
        
        const inspection = getElementInspection(currentElement.type, currentElement.data);
        if (inspection) {
            inspection.criteria[criteriaKey] = value;
            inspection.timestamp = new Date().toISOString();
            saveInspections();
            updateKPIs();
            // Refresh notation panel counts/percentage
            renderNotationPanel();
            // Update completed state on the matching hotspots and admin elements
            const elementKey = inspection.elementKey;
            // Hotspots
            const planWrapper = document.getElementById('planWrapper');
            if (planWrapper) {
                planWrapper.querySelectorAll('.hotspot').forEach(h => {
                    if (h.dataset.elementKey === elementKey) {
                        if (isElementCompleted(inspection)) h.classList.add('completed'); else h.classList.remove('completed');
                    }
                });
            }
            // Admin elements
            document.querySelectorAll('.admin-element').forEach(a => {
                if (a.dataset.elementKey === elementKey) {
                    if (isElementCompleted(inspection)) a.classList.add('completed'); else a.classList.remove('completed');
                }
            });
            // Force reposition si n√©cessaire
            // Re-render hotspots and admin elements to ensure visual state is consistent
            addHotspots();
            renderAdminElements();
            scheduleReposition(100);
        }
    }

    // Update comments
    function updateComments(comments) {
        if (!currentElement) return;
        
        const inspection = getElementInspection(currentElement.type, currentElement.data);
        if (inspection) {
            inspection.comments = comments;
            inspection.timestamp = new Date().toISOString();
            saveInspections();
        }
    }

    // Update quantity (for extincteurs)
    function updateQuantity(quantity) {
        if (!currentElement || currentElement.type !== 'extincteur') return;
        
        const qty = parseInt(quantity);
        if (isNaN(qty) || qty < 1) return;
        
        currentElement.data.quantity = qty;
        
        // Mettre √† jour dans la zone
        if (currentZone && currentFloor) {
            const extincteurs = currentFloor.elements.extincteurs || [];
            const index = extincteurs.findIndex(ext => getElementKey('extincteur', ext) === getElementKey('extincteur', currentElement.data));
            if (index !== -1) {
                extincteurs[index].quantity = qty;
                saveZones();
                
                // Re-render pour afficher la nouvelle quantit√©
                renderNotationPanel();
            }
        }
    }

    // Update element ID (number)
    function updateElementId(newId) {
        if (!currentElement) return;
        
        const trimmedId = newId.trim();
        if (!trimmedId) {
            alert('Le num√©ro ne peut pas √™tre vide');
            document.getElementById('elementIdInput').value = currentElement.data.id || '';
            return;
        }
        
        const oldKey = getElementKey(currentElement.type, currentElement.data);
        currentElement.data.id = trimmedId;
        
        // Mettre √† jour dans la zone
        if (currentZone && currentFloor) {
            const elementType = currentElement.type;
            const collectionKey = elementType === 'extincteur' ? 'extincteurs' : elementType === 'dm' ? 'dm' : 'sorties';
            const collection = currentFloor.elements[collectionKey] || [];
            
            const index = collection.findIndex(el => getElementKey(elementType, el) === oldKey);
            if (index !== -1) {
                collection[index].id = trimmedId;
                saveZones();
                
                // Mettre √† jour la cl√© de l'inspection si elle existe
                const inspection = inspections.find(i => 
                    i.campaign === currentCampaign && 
                    i.zoneId === currentZone.id && 
                    i.floorId === (currentFloor?.id || null) &&
                    i.elementKey === oldKey
                );
                if (inspection) {
                    inspection.elementKey = getElementKey(elementType, currentElement.data);
                    inspection.elementData = currentElement.data;
                    saveInspections();
                }
                
                // Re-render pour afficher le nouveau num√©ro
                renderNotationPanel();
                // Mettre √† jour les hotspots
                addHotspots();
                // Mettre √† jour les √©l√©ments admin si en mode admin
                if (isAdminMode) renderAdminElements();
            }
        }
    }

    // Update element type (for extincteurs)
    function updateElementType(newType) {
        if (!currentElement || currentElement.type !== 'extincteur') return;
        
        currentElement.data.type = newType;
        
        // Mettre √† jour dans la zone
        if (currentZone && currentFloor) {
            const extincteurs = currentFloor.elements.extincteurs || [];
            const index = extincteurs.findIndex(ext => getElementKey('extincteur', ext) === getElementKey('extincteur', currentElement.data));
            if (index !== -1) {
                extincteurs[index].type = newType;
                saveZones();
                
                // Re-render pour afficher le nouveau type
                renderNotationPanel();
                // Mettre √† jour les hotspots
                addHotspots();
                // Mettre √† jour les √©l√©ments admin si en mode admin
                if (isAdminMode) renderAdminElements();
            }
        }
    }

    // Handle photo upload (compress before storing)
    function handlePhotoUpload(event) {
        if (!currentElement) return;

        const files = Array.from(event.target.files);
        const inspection = getElementInspection(currentElement.type, currentElement.data);
        if (!inspection) return;

        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                // compress image before storing
                compressImage(e.target.result, 1200, 0.65).then(compressed => {
                    inspection.photos = inspection.photos || [];
                    inspection.photos.push(compressed);
                    inspection.timestamp = new Date().toISOString();
                    saveInspections();
                    renderNotationPanel(); // Refresh to show new photos
                });
            };
            reader.readAsDataURL(file);
        });
    }

    // Update zone plan (compress before storing, robust save)
    function updateZonePlan(event) {
        const file = event.target.files[0];
        if (!file || !currentZone || !currentFloor) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            // create a backup of current elements and plan before attempting conversion
            try {
                currentFloor._backupElements = currentFloor.elements ? JSON.parse(JSON.stringify(currentFloor.elements)) : null;
                currentFloor._backupPlanImage = currentFloor.plan && currentFloor.plan.imageUrl ? currentFloor.plan.imageUrl : '';
            } catch (err) {
                // ignore backup failure
                console.debug('backup creation failed', err);
            }

            compressImage(e.target.result, 1200, 0.65).then(compressedDataUrl => {
                const img = new Image();
                img.onload = () => {
                    currentFloor.plan = currentFloor.plan || {};

                    // If previous natural dimensions are present, try to preserve element positions/sizes
                    const oldNaturalWidth = currentFloor.plan.naturalWidth || null;
                    const oldNaturalHeight = currentFloor.plan.naturalHeight || null;
                    const newNaturalWidth = img.width;
                    const newNaturalHeight = img.height;

                    // If elements exist, normalize/convert coordinates to relative fractions
                    if (currentFloor.elements) {
                        ['extincteurs', 'dm', 'sorties'].forEach(collectionKey => {
                            const arr = currentFloor.elements[collectionKey] || [];
                            arr.forEach(el => {
                                // If coordinates look like absolute pixels (greater than 1), convert to fractions
                                if (oldNaturalWidth && oldNaturalHeight) {
                                    if (el.x > 1) el.x = Math.max(0, Math.min(1, el.x / oldNaturalWidth));
                                    if (el.y > 1) el.y = Math.max(0, Math.min(1, el.y / oldNaturalHeight));
                                } else {
                                    // If no old natural size but coords appear >1, assume pixels and convert using new size
                                    if (el.x > 1) el.x = Math.max(0, Math.min(1, el.x / newNaturalWidth));
                                    if (el.y > 1) el.y = Math.max(0, Math.min(1, el.y / newNaturalHeight));
                                }

                                // Resize value: if size looks like pixels (>1) convert to fraction of width
                                if (el.size !== undefined) {
                                    if (oldNaturalWidth && el.size > 1) {
                                        // convert from px (old natural reference) to fraction of new width
                                        const px = el.size;
                                        const frac = px / oldNaturalWidth;
                                        el.size = Math.max(0.005, Math.min(0.5, frac * (oldNaturalWidth / newNaturalWidth)));
                                    } else if (el.size > 1) {
                                        // no old reference: interpret as px on new image
                                        el.size = Math.max(0.005, Math.min(0.5, el.size / newNaturalWidth));
                                    }
                                    // if el.size <= 1 it's already a fraction; keep as-is
                                }
                            });
                        });
                    }

                    // Now store the new plan and its natural dimensions
                    currentFloor.plan.imageUrl = compressedDataUrl;
                    currentFloor.plan.naturalWidth = newNaturalWidth;
                    currentFloor.plan.naturalHeight = newNaturalHeight;

                    // Save with quota handling
                    saveZones();

                    // Update admin view
                    const adminPlanImage = document.getElementById('adminPlanImage');
                    if (adminPlanImage) {
                        adminPlanImage.src = compressedDataUrl;
                        adminPlanImage.onload = () => renderAdminElements();
                    }
                    // Update main view
                    const mainPlanImage = document.getElementById('planImage');
                    if (mainPlanImage) {
                        mainPlanImage.src = compressedDataUrl;
                        mainPlanImage.onload = () => addHotspots();
                    }
                    alert('Plan de la zone mis √† jour avec succ√®s (image compress√©e pour stockage).');
                };
                img.onerror = () => alert('Erreur lors du traitement de l\'image.');
                img.src = compressedDataUrl;
            });
        };
        reader.readAsDataURL(file);
    }

    // Normalize floor elements to ensure x/y are fractions (0..1) and size is fraction of width
    function normalizeFloorElements(floor) {
        if (!floor || !floor.elements) return;
        const cols = ['extincteurs', 'dm', 'sorties'];
        cols.forEach(key => {
            const arr = floor.elements[key] || [];
            arr.forEach(el => {
                if (!el) return;
                // normalize x/y
                if (typeof el.x === 'number') {
                    if (el.x > 1) el.x = Math.max(0, Math.min(1, el.x / (floor.plan?.naturalWidth || el.x)));
                } else {
                    el.x = 0.5;
                }
                if (typeof el.y === 'number') {
                    if (el.y > 1) el.y = Math.max(0, Math.min(1, el.y / (floor.plan?.naturalHeight || el.y)));
                } else {
                    el.y = 0.5;
                }

                // normalize size
                if (el.size === undefined || el.size === null) {
                    el.size = 0.02;
                } else if (el.size > 1) {
                    // interpret as pixels relative to width
                    el.size = Math.max(0.005, Math.min(0.5, el.size / (floor.plan?.naturalWidth || 200)));
                } else {
                    el.size = Math.max(0.005, Math.min(0.5, el.size));
                }
            });
        });
    }

    // Restore a previously stored backup for the current floor (elements + plan image)
    function restoreBackupPlan() {
        if (!currentZone || !currentFloor) return alert('Aucune zone ou √©tage s√©lectionn√©.');
        if (!currentFloor._backupElements && !currentFloor._backupPlanImage) return alert('Aucune sauvegarde trouv√©e pour cet √©tage.');

        if (!confirm('Restaurer la sauvegarde de ce plan et de ses √©l√©ments ? Cela remplacera les modifications actuelles.')) return;

        try {
            if (currentFloor._backupElements) currentFloor.elements = JSON.parse(JSON.stringify(currentFloor._backupElements));
            if (currentFloor._backupPlanImage) {
                currentFloor.plan = currentFloor.plan || {};
                currentFloor.plan.imageUrl = currentFloor._backupPlanImage;
            }
            // normalize and persist
            normalizeFloorElements(currentFloor);
            saveZones();
            // refresh admin UI if visible
            renderAdminElements();
            renderElementsList();
            const adminImg = document.getElementById('adminPlanImage');
            if (adminImg) adminImg.src = currentFloor.plan.imageUrl || '';
            alert('Restauration effectu√©e.');
        } catch (err) {
            console.error('restoreBackupPlan failed', err);
            alert('√âchec de la restauration : voir la console.');
        }
    }

    // Get zone inspection
    function getZoneInspection() {
        return inspections.find(i => 
            i.campaign === currentCampaign && 
            i.zoneId === currentZone.id && 
            i.type === 'zone'
        );
    }

    // Create zone inspection
    function createZoneInspection() {
        const inspection = {
            timestamp: new Date().toISOString(),
            campaign: currentCampaign,
            zoneId: currentZone.id,
            type: 'zone',
            criteria: {},
            comments: ''
        };
        
        inspections.push(inspection);
        saveInspections();
        return inspection;
    }

    // Update zone criteria
    function updateZoneCriteria(criteriaKey, value) {
        const inspection = getZoneInspection() || createZoneInspection();
        if (inspection) {
            inspection.criteria[criteriaKey] = value;
            inspection.timestamp = new Date().toISOString();
            saveInspections();
            updateKPIs();
            // If the checklist modal is open, update its progress display live
            updateZoneChecklistModalProgress();
        }
    }

    // Compute zone progress: returns { total, completed, percentage }
    function computeZoneProgress() {
        if (!currentZone) return { total: 0, completed: 0, percentage: 0 };
        const zoneInspection = getZoneInspection() || createZoneInspection();
        let allZoneCriteria = [];
        Object.entries(ZONE_CRITERIA).forEach(([section, criteria]) => {
            if (currentZone.enabledCriteria?.zone?.[section]) {
                currentZone.enabledCriteria.zone[section].forEach(key => {
                    allZoneCriteria.push(`${section}_${key}`);
                });
            }
        });

        const total = allZoneCriteria.length;
        const completed = allZoneCriteria.filter(fullKey => zoneInspection.criteria[fullKey] && zoneInspection.criteria[fullKey] !== '').length;
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        return { total, completed, percentage };
    }

    function updateZoneChecklistModalProgress() {
        const elPct = document.getElementById('zoneChecklistProgress');
        const elCounts = document.getElementById('zoneChecklistCounts');
        if (!elPct || !elCounts) return;
        const prog = computeZoneProgress();
        elPct.textContent = prog.percentage + '%';
        elCounts.textContent = `(${prog.completed}/${prog.total})`;
    }

    // Update zone comments
    function updateZoneComments(comments) {
        const inspection = getZoneInspection();
        if (inspection) {
            inspection.comments = comments;
            inspection.timestamp = new Date().toISOString();
            saveInspections();
        }
    }

    // Show export modal
    function showExportModal() {
        const deleteButtonText = 'Supprimer toutes les notations';
        const deleteWarningText = '‚ö†Ô∏è Supprime <strong>TOUTES</strong> les notations pour la campagne actuelle. Cette action est irr√©versible !';
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Exporter les Donn√©es</h2>
                    <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div class="space-y-4">
                    <button onclick="exportInspections('json')" 
                            class="w-full px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Exporter Inspections (JSON)
                    </button>
                    <button onclick="exportInspections('csv')" 
                            class="w-full px-4 py-3 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Exporter Inspections (CSV)
                    </button>
                    <button onclick="exportCurrentZone()" 
                            class="w-full px-4 py-3 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                        Exporter Zone Actuelle (JSON)
                    </button>
                    
                    <hr class="my-4 border-gray-300">
                    
                    <h3 class="font-semibold mb-3 text-sm text-gray-700">üìù Export / Import Notations</h3>
                    
                    <button onclick="exportNotations()" 
                            class="w-full px-4 py-3 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 flex items-center justify-center gap-2">
                        <span>üì§</span> Exporter Notations de Zone
                    </button>
                    
                    <p class="text-xs text-gray-600 mt-2 mb-3">
                        Exporte uniquement les notations (crit√®res + photos) des √©l√©ments de la zone actuelle
                    </p>
                </div>
                
                <div class="mt-6">
                    <h3 class="font-semibold mb-3 text-gray-900">Importer Inspections</h3>
                    <input type="file" accept=".json" onchange="importInspections(event)" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    
                    <div class="mt-4 border-t pt-4">
                        <h3 class="font-semibold mb-3 text-sm text-gray-700">üìù Importer Notations</h3>
                        <input type="file" accept=".json" onchange="importNotations(event)" 
                            class="w-full px-3 py-2 border border-indigo-300 rounded-md bg-indigo-50">
                        <p class="text-xs text-gray-600 mt-2">
                            Importe les notations en les associant aux √©l√©ments correspondants (par ID/position)
                        </p>
                    </div>
                    
                    <div class="mt-4 border-t pt-4">
                        <h3 class="font-semibold mb-3 text-sm text-red-700">üóëÔ∏è Gestion des Notations</h3>
                        <button onclick="deleteAllNotations()" 
                                class="w-full px-4 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center justify-center gap-2">
                            <span>üóëÔ∏è</span> ${deleteButtonText}
                        </button>
                        <p class="text-xs text-red-600 mt-2 font-medium">
                            ${deleteWarningText}
                        </p>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    // Show non-conformities modal
    function showNonConformitiesModal() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        modal.innerHTML = `
            <div class="modal-content w-full max-w-4xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Rapport des Non-Conformit√©s</h2>
                    <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <label class="flex items-center mb-4 text-gray-700">
                    <input type="checkbox" id="filterZonesOnly" onchange="updateNonConformitiesView()" class="mr-2">
                    Afficher seulement les zones non conformes
                </label>
                
                <div id="nonConformitiesList" class="space-y-4 max-h-96 overflow-y-auto">
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        updateNonConformitiesView();
    }

    function updateNonConformitiesView() {
        const listDiv = document.getElementById('nonConformitiesList');
        const filterChecked = document.getElementById('filterZonesOnly')?.checked;
        
        const nonConformities = [];
        
        inspections.forEach(inspection => {
            if (inspection.campaign === currentCampaign && inspection.criteria) {
                const zone = zones.find(z => z.id === inspection.zoneId);
                const zoneName = zone ? zone.name : inspection.zoneId;
                
                Object.entries(inspection.criteria).forEach(([key, value]) => {
                    if (value === 'non') {
                        let elementName = '';
                        
                        if (inspection.type === 'zone') {
                            const [section, crit] = key.split('_');
                            const label = ZONE_CRITERIA[section] && ZONE_CRITERIA[section][crit] ? ZONE_CRITERIA[section][crit] : key;
                            elementName = `Zone: ${label}`;
                        } else {
                            const typeLabel = inspection.type === 'extincteur' ? 'Extincteur' : inspection.type === 'dm' ? 'DM' : 'Sortie';
                            elementName = `${typeLabel} ${inspection.elementData.id || ''}`;
                            const critLabel = CRITERIA[inspection.type] && CRITERIA[inspection.type][key] ? CRITERIA[inspection.type][key] : key;
                            elementName += ` - ${critLabel}`;
                        }
                        
                        nonConformities.push({
                            zone: zoneName,
                            element: elementName,
                            timestamp: inspection.timestamp
                        });
                    }
                });
            }
        });
        
        let content = '';
        
        if (filterChecked) {
            // Group by zone
            const zonesWithIssues = {};
            nonConformities.forEach(nc => {
                if (!zonesWithIssues[nc.zone]) zonesWithIssues[nc.zone] = [];
                zonesWithIssues[nc.zone].push(nc);
            });
            
            if (Object.keys(zonesWithIssues).length === 0) {
                content = '<p class="text-gray-500">Aucune zone non conforme trouv√©e.</p>';
            } else {
                Object.entries(zonesWithIssues).forEach(([zone, issues]) => {
                    content += `<div class="border border-red-200 bg-red-50 p-4 rounded"><h3 class="font-bold text-red-700">${zone} (${issues.length} non-conformit√©(s))</h3><ul class="mt-2 space-y-1">`;
                    issues.forEach(nc => {
                        content += `<li class="text-sm text-gray-800">${nc.element} <small class="text-gray-500">(${new Date(nc.timestamp).toLocaleString()})</small></li>`;
                    });
                    content += '</ul></div>';
                });
            }
        } else {
            // List all
            if (nonConformities.length === 0) {
                content = '<p class="text-gray-500">Aucune non-conformit√© trouv√©e.</p>';
            } else {
                nonConformities.forEach(nc => {
                    content += `<div class="border border-red-200 bg-red-50 p-3 rounded text-gray-800"><strong>${nc.zone}</strong>: ${nc.element} <small class="text-gray-500">(${new Date(nc.timestamp).toLocaleString()})</small></div>`;
                });
            }
        }
        
        listDiv.innerHTML = content;
    }

    // Export inspections
    function exportInspections(format) {
        // Exporter toutes les zones
        const filteredZoneIds = zones.map(z => z.id);
        
        const campaignInspections = inspections.filter(i => 
            i.campaign === currentCampaign && 
            filteredZoneIds.includes(i.zoneId)
        );
        
        const categorySuffix = categoryChecks.length > 0 ? `_${categoryChecks.join('-')}` : '';
        
        if (format === 'json') {
            const data = JSON.stringify(campaignInspections, null, 2);
            downloadFile(data, `inspections${categorySuffix}_${currentCampaign}.json`, 'application/json');
        } else if (format === 'csv') {
            const csv = convertToCSV(campaignInspections);
            downloadFile(csv, `inspections${categorySuffix}_${currentCampaign}.csv`, 'text/csv');
        }
    }

    // Convert to CSV
    function convertToCSV(data) {
        if (data.length === 0) return '';
        
        const headers = ['Timestamp', 'Campaign', 'Zone ID', 'Type', 'Element Key', 'Criteria', 'Comments'];
        const rows = data.map(item => [
            item.timestamp,
            item.campaign,
            item.zoneId,
            item.type,
            item.elementKey || '',
            JSON.stringify(item.criteria),
            item.comments || ''
        ]);
        
        return [headers, ...rows].map(row => 
            row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
        ).join('\n');
    }

    // Download file
    function downloadFile(content, filename, contentType) {
        const blob = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Export current zone
    function exportCurrentZone() {
        if (!currentZone) return;
        
        const data = JSON.stringify(currentZone, null, 2);
        downloadFile(data, `zone_${currentZone.id}.json`, 'application/json');
    }

    // Import inspections
    function importInspections(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                inspections = [...inspections, ...importedData];
                saveInspections();
                updateKPIs();
                alert('Inspections import√©es avec succ√®s !');
            } catch (error) {
                alert('Erreur lors de l\'importation : ' + error.message);
            }
        };
        reader.readAsText(file);
    }

    function renderAdminContent() {
        const adminContent = document.getElementById('adminContent');
        if (!adminContent) return;
        adminContent.innerHTML = `
            <div class="text-center text-gray-500">
                <div class="text-6xl mb-4">‚öôÔ∏è</div>
                <p>S√©lectionnez une zone √† modifier ou cr√©ez-en une nouvelle</p>
            </div>
        `;
    }

    function renderAdminZoneList() {
        const container = document.getElementById('adminZoneList');
        if (!container) return;

        // Get active category filters from admin panel
        const adminPanel = document.getElementById('adminPanel');
        if (!adminPanel) return;
        
        const checkboxes = adminPanel.querySelectorAll('input[type="checkbox"][value]');
        const activeCategories = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        let filteredZones = zones.slice();

        // Category filter
        if (activeCategories.length > 0) {
            filteredZones = filteredZones.filter(zone => activeCategories.includes(zone.categorie));
        }
        
        // Tri par nom
        filteredZones.sort((a,b) => (a.name||'').localeCompare(b.name||''));

        container.innerHTML = filteredZones.map(zone => {
            const cat = zone.category || '';
            const displayCat = cat.startsWith('Administratif') ? 'Administratif' : cat;
            return `
            <div class="flex justify-between items-center p-2 border border-gray-200 rounded hover:bg-gray-50">
                <div class="flex-1">
                    <div class="font-medium">${zone.name} ${displayCat ? `<span class=\"text-xs ml-2 px-1 py-0.5 bg-gray-100 rounded\">${displayCat}</span>` : ''}</div>
                    <div class="text-sm text-gray-500">${zone.id}</div>
                </div>
                <button onclick="editZone('${zone.id}')" 
                        class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                    √âditer
                </button>
            </div>
        `}).join('');
    }

    function createNewZone() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Cr√©er une Nouvelle Zone</h2>
                    <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form onsubmit="saveNewZone(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">ID de la Zone</label>
                            <input type="text" name="zoneId" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                placeholder="zone-001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Nom de la Zone</label>
                            <input type="text" name="zoneName" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                placeholder="Atelier Principal">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Plan de la Zone</label>
                            <input type="file" name="planImage" accept="image/*" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="this.closest('.modal').remove()" 
                                class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                            Annuler
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Cr√©er
                        </button>
                    </div>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function saveNewZone(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const zoneId = formData.get('zoneId');
        const zoneName = formData.get('zoneName');
        const planFile = formData.get('planImage');
        
        if (zones.find(z => z.id === zoneId)) {
            alert('Une zone avec cet ID existe d√©j√† !');
            return;
        }
        
        const newZone = {
            id: zoneId,
            name: zoneName,
            floors: [
                {
                    id: 'RDC',
                    name: 'Rez-de-chauss√©e',
                    plan: { imageUrl: '', naturalWidth: 800, naturalHeight: 600 },
                    elements: { extincteurs: [], dm: [], sorties: [] }
                }
            ],
            category: '',
            enabledCriteria: {
                extincteur: Object.keys(CRITERIA.extincteur),
                dm: Object.keys(CRITERIA.dm),
                sortie: Object.keys(CRITERIA.sortie),
                zone: Object.keys(ZONE_CRITERIA).reduce((acc, section) => {
                    acc[section] = Object.keys(ZONE_CRITERIA[section]);
                    return acc;
                }, {})
            }
        };
        
        if (planFile && planFile.size > 0) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    newZone.floors[0].plan.imageUrl = e.target.result;
                    newZone.floors[0].plan.naturalWidth = img.width;
                    newZone.floors[0].plan.naturalHeight = img.height;
                    zones.push(newZone);
                    saveZones();
                    renderAdminZoneList();
                    renderZoneList();
                    event.target.closest('.modal').remove();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(planFile);
        } else {
            newZone.floors[0].plan.imageUrl = 'data:image/svg+xml;base64,' + btoa(`
                <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                    <rect width="800" height="600" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2"/>
                    <rect x="50" y="50" width="700" height="500" fill="#e9ecef" stroke="#6c757d" stroke-width="1"/>
                    <text x="400" y="300" text-anchor="middle" font-family="Arial" font-size="24" fill="#495057">${zoneName}</text>
                    <text x="400" y="330" text-anchor="middle" font-family="Arial" font-size="16" fill="#6c757d">Ajoutez des √©l√©ments en mode √©dition</text>
                </svg>
            `);
            zones.push(newZone);
            saveZones();
            renderAdminZoneList();
            renderZoneList();
            event.target.closest('.modal').remove();
        }
    }

    function showImportModal() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Importer une Zone ou une Librairie</h2>
                    <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded p-3 text-sm">
                        <p class="font-medium text-blue-900 mb-1">Formats support√©s :</p>
                        <ul class="text-blue-700 list-disc ml-5 space-y-1">
                            <li>Une zone unique (fichier JSON d'une zone)</li>
                            <li>Une librairie compl√®te (fichier TICP_zones_library_*.json)</li>
                            <li>Un tableau de zones</li>
                        </ul>
                    </div>
                    <p class="text-sm text-gray-600">S√©lectionnez un fichier JSON √† importer</p>
                    <input type="file" accept=".json" onchange="importZoneFile(event)" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="this.closest('.modal').remove()" 
                            class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                        Fermer
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function importZoneFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                let zonesToImport = [];
                
                // Support multiple import formats
                if (Array.isArray(importedData)) {
                    // Direct array of zones
                    zonesToImport = importedData;
                } else if (importedData.zones && Array.isArray(importedData.zones)) {
                    // Library format with zones property
                    zonesToImport = importedData.zones;
                } else if (importedData.id && importedData.name) {
                    // Single zone object
                    zonesToImport = [importedData];
                } else {
                    throw new Error('Format de fichier non reconnu');
                }
                
                if (zonesToImport.length === 0) {
                    alert('Aucune zone trouv√©e dans le fichier');
                    return;
                }
                
                // Process each zone
                let imported = 0;
                let skipped = 0;
                const conflicts = [];
                
                zonesToImport.forEach(importedZone => {
                    if (!importedZone.id || !importedZone.name) {
                        skipped++;
                        return;
                    }
                    
                    // Check for existing zone with same ID
                    if (zones.find(z => z.id === importedZone.id)) {
                        conflicts.push(importedZone.id);
                        skipped++;
                        return;
                    }
                    
                    // Normalize imported zone to ensure floors exist
                    if (!importedZone.floors && (importedZone.plan || importedZone.elements)) {
                        importedZone.floors = [{
                            id: importedZone.defaultFloorId || 'RDC',
                            name: importedZone.defaultFloorName || 'Rez-de-chauss√©e',
                            plan: importedZone.plan || { imageUrl: '', naturalWidth: 800, naturalHeight: 600 },
                            elements: importedZone.elements || { extincteurs: [], dm: [], sorties: [] }
                        }];
                        delete importedZone.plan;
                        delete importedZone.elements;
                    }
                    
                    // Ensure all floors have proper structure and normalized elements
                    if (importedZone.floors) {
                        importedZone.floors.forEach(floor => {
                            // Ensure plan structure
                            if (!floor.plan) {
                                floor.plan = { imageUrl: '', naturalWidth: 800, naturalHeight: 600 };
                            }
                            if (!floor.plan.naturalWidth) floor.plan.naturalWidth = 800;
                            if (!floor.plan.naturalHeight) floor.plan.naturalHeight = 600;
                            
                            // Ensure elements structure
                            if (!floor.elements) {
                                floor.elements = { extincteurs: [], dm: [], sorties: [] };
                            }
                            
                            // Normalize elements: ensure x, y are fractions (0-1) and size exists
                            ['extincteurs', 'dm', 'sorties'].forEach(key => {
                                const arr = floor.elements[key] || [];
                                arr.forEach(el => {
                                    if (!el) return;
                                    
                                    // Ensure x and y are valid fractions (0-1)
                                    if (typeof el.x !== 'number' || el.x < 0 || el.x > 1) {
                                        el.x = 0.5;
                                    }
                                    if (typeof el.y !== 'number' || el.y < 0 || el.y > 1) {
                                        el.y = 0.5;
                                    }
                                    
                                    // Ensure size exists and is a valid fraction
                                    if (typeof el.size !== 'number' || el.size <= 0 || el.size > 1) {
                                        el.size = 0.02;
                                    }
                                });
                            });
                        });
                    }
                    
                    // Ensure enabledCriteria exist
                    if (!importedZone.enabledCriteria) {
                        importedZone.enabledCriteria = {
                            extincteur: Object.keys(CRITERIA.extincteur),
                            dm: Object.keys(CRITERIA.dm),
                            sortie: Object.keys(CRITERIA.sortie),
                            zone: Object.keys(ZONE_CRITERIA).reduce((acc, section) => {
                                acc[section] = Object.keys(ZONE_CRITERIA[section]);
                                return acc;
                            }, {})
                        };
                    }
                    
                    zones.push(importedZone);
                    imported++;
                });
                
                if (imported > 0) {
                    saveZones();
                    renderAdminZoneList();
                    renderZoneList();
                    event.target.closest('.modal').remove();
                }
                
                // Show detailed result
                let message = `Import termin√© :\n‚úì ${imported} zone(s) import√©e(s)`;
                if (skipped > 0) {
                    message += `\n‚ö† ${skipped} zone(s) ignor√©e(s)`;
                }
                if (conflicts.length > 0) {
                    message += `\n\nConflits (ID d√©j√† existants) :\n- ${conflicts.join('\n- ')}`;
                }
                alert(message);
                
            } catch (error) {
                console.error('Import error:', error);
                alert('Erreur lors de l\'importation : ' + error.message);
            }
        };
        reader.readAsText(file);
    }

    function exportLibrary() {
        // Exporter toutes les zones
        const zonesToExport = zones.slice();
        
        // Export library in a format compatible with import
        const exportData = {
            version: "1.0",
            exportDate: new Date().toISOString(),
            zones: zonesToExport
        };
        const data = JSON.stringify(exportData, null, 2);
        const filename = `TICP_zones_library_${new Date().toISOString().split('T')[0]}.json`;
        downloadFile(data, filename, 'application/json');
        
        alert(`Librairie export√©e avec succ√®s : ${zonesToExport.length} zone(s)\nFichier : ${filename}`);
    }

    function exportCurrentZone() {
        if (!currentZone) {
            alert('Aucune zone s√©lectionn√©e pour l\'export.');
            return;
        }
        
        // Export uniquement la zone courante
        const exportData = {
            version: "1.0",
            exportDate: new Date().toISOString(),
            zones: [currentZone]
        };
        const data = JSON.stringify(exportData, null, 2);
        const filename = `TICP_zone_${currentZone.id}_${new Date().toISOString().split('T')[0]}.json`;
        downloadFile(data, filename, 'application/json');
        alert(`Zone "${currentZone.name}" export√©e avec succ√®s !\nFichier : ${filename}`);
    }

    // ===== EXPORT / IMPORT NOTATIONS =====
    
    /**
     * Exporte uniquement les notations (inspections) de la zone actuelle ou de toutes les zones
     * Inclut les crit√®res, commentaires et photos
     */
    function exportNotations() {
        // R√©cup√©rer les filtres de cat√©gorie actifs
        const categoryChecks = Array.from(document.querySelectorAll('#categoryFilter input[type=checkbox]:checked')).map(i => i.value);
        
        // Demander si on veut exporter une seule zone ou toutes les zones
        const exportAll = !currentZone || confirm(
            currentZone 
                ? `Exporter les notations :\n\n` +
                  `‚Ä¢ Zone actuelle uniquement : "${currentZone.name}" ‚Üí Cliquez sur ANNULER\n` +
                  `‚Ä¢ Toutes les zones filtr√©es ‚Üí Cliquez sur OK\n\n` +
                  `Campagne : ${currentCampaign}\n` +
                  (categoryChecks.length > 0 ? `Cat√©gories : ${categoryChecks.join(', ')}` : 'Toutes cat√©gories')
                : `Aucune zone s√©lectionn√©e.\n\nVoulez-vous exporter les notations de TOUTES les zones filtr√©es ?`
        );
        
        let zoneInspections;
        let zones_exported = [];
        let filename;
        
        if (exportAll) {
            // Filtrer les zones selon les cat√©gories actives
            let filteredZones = zones;
            if (categoryChecks.length > 0) {
                filteredZones = zones.filter(zone => {
                    // Normaliser la cat√©gorie pour g√©rer "Administratif:xxx"
                    const category = zone.category.startsWith('Administratif:') ? 'Administratif' : zone.category;
                    return categoryChecks.includes(category);
                });
            }
            
            const filteredZoneIds = filteredZones.map(z => z.id);
            
            // Exporter toutes les zones filtr√©es
            zoneInspections = inspections.filter(insp => 
                insp.campaign === currentCampaign && 
                filteredZoneIds.includes(insp.zoneId)
            );
            
            // Obtenir la liste des zones uniques
            const zoneIds = [...new Set(zoneInspections.map(i => i.zoneId))];
            zones_exported = zoneIds.map(zoneId => {
                const zone = zones.find(z => z.id === zoneId);
                return {
                    id: zoneId,
                    name: zone ? zone.name : zoneId
                };
            });
            
            if (zoneInspections.length === 0) {
                const categoriesText = categoryChecks.length > 0 ? ` (cat√©gories: ${categoryChecks.join(', ')})` : '';
                alert(`‚ùå Aucune notation trouv√©e pour la campagne ${currentCampaign}${categoriesText}.`);
                return;
            }
            
            const categorySuffix = categoryChecks.length > 0 ? `_${categoryChecks.join('-')}` : '';
            filename = `Notations_TOUTES_ZONES${categorySuffix}_${currentCampaign}_${new Date().toISOString().split('T')[0]}.json`;
        } else {
            // Exporter uniquement la zone actuelle
            if (!currentZone) {
                alert('‚ö†Ô∏è Aucune zone s√©lectionn√©e.\nVeuillez s√©lectionner une zone avant d\'exporter ses notations.');
                return;
            }
            
            zoneInspections = inspections.filter(insp => 
                insp.zoneId === currentZone.id && 
                insp.campaign === currentCampaign
            );
            
            zones_exported = [{
                id: currentZone.id,
                name: currentZone.name
            }];
            
            if (zoneInspections.length === 0) {
                const confirmExport = confirm(
                    `‚ö†Ô∏è Aucune notation trouv√©e pour la zone "${currentZone.name}" (campagne ${currentCampaign}).\n\n` +
                    `Voulez-vous quand m√™me cr√©er un fichier vide ?`
                );
                if (!confirmExport) return;
            }
            
            filename = `Notations_${currentZone.id}_${currentCampaign}_${new Date().toISOString().split('T')[0]}.json`;
        }
        
        // Cr√©er le fichier d'export avec m√©tadonn√©es
        const exportData = {
            version: "1.0",
            exportType: "notations",
            exportDate: new Date().toISOString(),
            campaign: currentCampaign,
            zones: zones_exported,
            inspections: zoneInspections,
            stats: {
                total: zoneInspections.length,
                zonesCount: zones_exported.length,
                withPhotos: zoneInspections.filter(i => i.photos && i.photos.length > 0).length,
                nonConformities: zoneInspections.filter(i => 
                    i.criteria && Object.values(i.criteria).includes('non')
                ).length
            }
        };
        
        const data = JSON.stringify(exportData, null, 2);
        downloadFile(data, filename, 'application/json');
        
        // Message d√©taill√©
        let message = `‚úÖ Export r√©ussi !\n\n`;
        if (exportAll) {
            message += `Zones : ${zones_exported.length} zone(s)\n`;
            if (zones_exported.length <= 5) {
                zones_exported.forEach(z => message += `  ‚Ä¢ ${z.name} (${z.id})\n`);
            } else {
                zones_exported.slice(0, 3).forEach(z => message += `  ‚Ä¢ ${z.name} (${z.id})\n`);
                message += `  ... et ${zones_exported.length - 3} autre(s)\n`;
            }
        } else {
            message += `Zone : ${zones_exported[0].name} (${zones_exported[0].id})\n`;
        }
        message += `Campagne : ${currentCampaign}\n` +
            `Notations export√©es : ${exportData.stats.total}\n` +
            `Avec photos : ${exportData.stats.withPhotos}\n` +
            `Non-conformit√©s : ${exportData.stats.nonConformities}\n\n` +
            `Fichier : ${filename}`;
        
        alert(message);
    }
    
    /**
     * Supprime toutes les notations des zones filtr√©es pour la campagne actuelle
     * Respecte les filtres de cat√©gorie actifs (checkboxes coch√©es)
     * Demande une double confirmation pour √©viter les suppressions accidentelles
     */
    function deleteAllNotations() {
        // R√©cup√©rer les filtres de cat√©gorie actifs
        const categoryChecks = Array.from(document.querySelectorAll('#categoryFilter input[type=checkbox]:checked')).map(i => i.value);
        
        // D√©terminer les zones filtr√©es
        let filteredZoneIds;
        let filterDescription;
        
        if (categoryChecks.length > 0) {
            // Des filtres sont actifs : utiliser les zones correspondantes
            filteredZoneIds = zones
                .filter(z => {
                    const cat = z.category || '';
                    const normalized = cat.startsWith('Administratif') ? 'Administratif' : cat;
                    return categoryChecks.includes(normalized);
                })
                .map(z => z.id);
            
            filterDescription = `Cat√©gories : ${categoryChecks.join(', ')}`;
        } else {
            // Aucun filtre actif : toutes les zones
            filteredZoneIds = zones.map(z => z.id);
            filterDescription = 'Toutes les cat√©gories';
        }
        
        // Trouver les inspections correspondantes
        const filteredInspections = inspections.filter(i => 
            i.campaign === currentCampaign && filteredZoneIds.includes(i.zoneId)
        );
        
        const count = filteredInspections.length;
        
        if (count === 0) {
            const msg = categoryChecks.length > 0 
                ? `Aucune notation √† supprimer pour les zones ${categoryChecks.join(', ')} de la campagne ${currentCampaign}`
                : `Aucune notation √† supprimer pour la campagne ${currentCampaign}`;
            alert('‚ÑπÔ∏è ' + msg);
            return;
        }
        
        // Liste des zones concern√©es
        const affectedZones = [...new Set(filteredInspections.map(i => i.zoneId))];
        const zoneNames = affectedZones.map(id => {
            const z = zones.find(zone => zone.id === id);
            return z ? z.name : id;
        }).join(', ');
        
        // Premi√®re confirmation
        const firstConfirm = confirm(
            `‚ö†Ô∏è ATTENTION - Suppression de notations\n\n` +
            `Vous √™tes sur le point de supprimer :\n` +
            `‚Ä¢ ${count} notation(s)\n` +
            `‚Ä¢ Campagne : ${currentCampaign}\n` +
            `‚Ä¢ ${filterDescription}\n` +
            `‚Ä¢ Zones concern√©es (${affectedZones.length}) : ${affectedZones.length <= 5 ? zoneNames : affectedZones.length + ' zones'}\n\n` +
            `Cette action est IRR√âVERSIBLE !\n\n` +
            `Voulez-vous continuer ?`
        );
        
        if (!firstConfirm) {
            return;
        }
        
        // Deuxi√®me confirmation (s√©curit√©)
        const secondConfirm = confirm(
            `üö® DERNI√àRE CONFIRMATION\n\n` +
            `√ätes-vous VRAIMENT s√ªr de vouloir supprimer ${count} notation(s) ?\n\n` +
            `Conseil : Exportez d'abord vos notations avant de les supprimer !`
        );
        
        if (!secondConfirm) {
            alert('‚úÖ Suppression annul√©e. Vos donn√©es sont conserv√©es.');
            return;
        }
        
        // Effectuer la suppression
        const beforeCount = inspections.length;
        inspections = inspections.filter(i => 
            !(i.campaign === currentCampaign && filteredZoneIds.includes(i.zoneId))
        );
        const afterCount = inspections.length;
        const deleted = beforeCount - afterCount;
        
        // Sauvegarder
        saveInspections();
        
        // Mettre √† jour l'affichage
        updateKPIs();
        if (currentZone) {
            addHotspots();
            renderNotationPanel();
        }
        
        // Fermer le modal d'export
        const modal = document.querySelector('.modal');
        if (modal) modal.remove();
        
        // Message de confirmation
        alert(
            `‚úÖ Suppression effectu√©e avec succ√®s !\n\n` +
            `‚Ä¢ ${deleted} notation(s) supprim√©e(s)\n` +
            `‚Ä¢ Campagne : ${currentCampaign}\n` +
            `‚Ä¢ ${filterDescription}\n` +
            `‚Ä¢ Zones : ${affectedZones.length}\n\n` +
            `Les indicateurs ont √©t√© mis √† jour.`
        );
    }

    /**
     * Importe les notations depuis un fichier JSON
     * Associe intelligemment les notations aux √©l√©ments existants
     * Support import multi-zones
     */
    function importNotations(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                
                // V√©rifier le format
                if (!importedData.exportType || importedData.exportType !== 'notations') {
                    const continueAnyway = confirm(
                        '‚ö†Ô∏è Ce fichier ne semble pas √™tre un export de notations.\n\n' +
                        'Voulez-vous quand m√™me essayer de l\'importer ?'
                    );
                    if (!continueAnyway) return;
                }
                
                const importedInspections = importedData.inspections || [];
                
                if (importedInspections.length === 0) {
                    alert('‚ùå Aucune notation trouv√©e dans le fichier.');
                    return;
                }
                
                // Statistiques d'import globales
                let added = 0;
                let updated = 0;
                let skipped = 0;
                const notFound = [];
                const zonesProcessed = new Set();
                
                // Parcourir les notations import√©es
                importedInspections.forEach(importedInsp => {
                    // V√©rifier que la zone existe
                    const zone = zones.find(z => z.id === importedInsp.zoneId);
                    if (!zone) {
                        if (!notFound.some(item => item.startsWith(`Zone ${importedInsp.zoneId}`))) {
                            notFound.push(`Zone ${importedInsp.zoneId} (n'existe pas)`);
                        }
                        skipped++;
                        return;
                    }
                    
                    // Marquer la zone comme trait√©e
                    zonesProcessed.add(importedInsp.zoneId);
                    
                    // Trouver le floor correspondant
                    let targetFloor = null;
                    if (importedInsp.floorId) {
                        targetFloor = zone.floors?.find(f => f.id === importedInsp.floorId);
                    }
                    if (!targetFloor && zone.floors && zone.floors.length > 0) {
                        targetFloor = zone.floors[0]; // Fallback sur le premier √©tage
                    }
                    
                    if (!targetFloor) {
                        notFound.push(`√âtage ${importedInsp.floorId} dans zone ${importedInsp.zoneId}`);
                        skipped++;
                        return;
                    }
                    
                    // V√©rifier que l'√©l√©ment existe dans la zone
                    let elementExists = false;
                    
                    if (importedInsp.type === 'zone') {
                        // Notation de zone : toujours valide
                        elementExists = true;
                    } else {
                        // Notation d'√©l√©ment : v√©rifier l'existence
                        const collectionKey = importedInsp.type === 'extincteur' ? 'extincteurs' :
                                            importedInsp.type === 'dm' ? 'dm' :
                                            importedInsp.type === 'sortie' ? 'sorties' : null;
                        
                        if (collectionKey && targetFloor.elements) {
                            const collection = targetFloor.elements[collectionKey] || [];
                            
                            // Recherche par ID exact (pour extincteurs et DM)
                            if (importedInsp.elementData?.id) {
                                elementExists = collection.some(el => el.id === importedInsp.elementData.id);
                            }
                            
                            // Recherche par position (pour sorties et √©l√©ments sans ID)
                            if (!elementExists && importedInsp.elementData?.x !== undefined && importedInsp.elementData?.y !== undefined) {
                                const tolerance = 0.02; // 2% de tol√©rance sur la position
                                elementExists = collection.some(el => 
                                    Math.abs(el.x - importedInsp.elementData.x) < tolerance &&
                                    Math.abs(el.y - importedInsp.elementData.y) < tolerance
                                );
                            }
                        }
                    }
                    
                    if (!elementExists) {
                        const elementDesc = importedInsp.type === 'zone' ? 
                            'Zone globale' : 
                            `${importedInsp.type} ${importedInsp.elementData?.id || 'sans ID'}`;
                        notFound.push(`[${zone.name}] ${elementDesc}`);
                        skipped++;
                        return;
                    }
                    
                    // Chercher si une inspection existe d√©j√†
                    const existingInspIndex = inspections.findIndex(insp =>
                        insp.campaign === importedInsp.campaign &&
                        insp.zoneId === importedInsp.zoneId &&
                        insp.floorId === importedInsp.floorId &&
                        insp.elementKey === importedInsp.elementKey &&
                        insp.type === importedInsp.type
                    );
                    
                    if (existingInspIndex !== -1) {
                        // Mettre √† jour l'inspection existante
                        inspections[existingInspIndex] = {
                            ...inspections[existingInspIndex],
                            ...importedInsp,
                            timestamp: new Date().toISOString() // Mise √† jour du timestamp
                        };
                        updated++;
                    } else {
                        // Ajouter la nouvelle inspection
                        inspections.push({
                            ...importedInsp,
                            timestamp: new Date().toISOString()
                        });
                        added++;
                    }
                });
                
                // Sauvegarder
                if (added > 0 || updated > 0) {
                    saveInspections();
                    updateKPIs();
                    
                    // Rafra√Æchir l'affichage si on est dans une zone concern√©e
                    if (currentZone && zonesProcessed.has(currentZone.id)) {
                        addHotspots();
                        renderNotationPanel();
                    }
                }
                
                // Message d√©taill√©
                let message = '‚úÖ Import termin√© !\n\n';
                
                // Info sur les zones
                if (zonesProcessed.size > 0) {
                    message += `ÔøΩ Zones trait√©es : ${zonesProcessed.size}\n`;
                    const zoneNames = Array.from(zonesProcessed).map(zoneId => {
                        const zone = zones.find(z => z.id === zoneId);
                        return zone ? zone.name : zoneId;
                    });
                    if (zoneNames.length <= 5) {
                        zoneNames.forEach(name => message += `  ‚Ä¢ ${name}\n`);
                    } else {
                        zoneNames.slice(0, 3).forEach(name => message += `  ‚Ä¢ ${name}\n`);
                        message += `  ... et ${zoneNames.length - 3} autre(s)\n`;
                    }
                    message += '\n';
                }
                
                message += `ÔøΩüì• Ajout√©es : ${added}\n`;
                message += `üîÑ Mises √† jour : ${updated}\n`;
                if (skipped > 0) {
                    message += `‚ö†Ô∏è Ignor√©es : ${skipped}\n`;
                }
                
                if (notFound.length > 0) {
                    message += `\n‚ùå √âl√©ments non trouv√©s :\n`;
                    // Afficher max 10 √©l√©ments non trouv√©s
                    const displayList = notFound.slice(0, 10);
                    displayList.forEach(item => {
                        message += `  ‚Ä¢ ${item}\n`;
                    });
                    if (notFound.length > 10) {
                        message += `  ... et ${notFound.length - 10} autre(s)\n`;
                    }
                    message += `\nüí° Astuce : Assurez-vous que les zones et √©l√©ments existent avant d'importer les notations.`;
                }
                
                alert(message);
                
                // R√©initialiser l'input file
                event.target.value = '';
                
            } catch (error) {
                console.error('Import notations error:', error);
                alert(`‚ùå Erreur lors de l'import des notations :\n\n${error.message}\n\nV√©rifiez que le fichier est au bon format.`);
            }
        };
        reader.readAsText(file);
    }

    // ===== FIN EXPORT / IMPORT NOTATIONS =====
    
    // Rendre les fonctions disponibles globalement (pour compatibilit√© onclick)
    window.exportNotations = exportNotations;
    window.importNotations = importNotations;

    const ELEMENT_COLLECTION_MAP = { extincteur: 'extincteurs', dm: 'dm', sortie: 'sorties' };
    const EXTINGUISHER_TYPES = ['Eau', 'Mousse', 'Poudre', 'CO2', 'Lithium', 'A identifi√©'];

    function generateUniqueElementId(type, elements) {
        const prefix = type === 'extincteur' ? 'EXT' : 'DM';
        let counter = elements.length + 1;
        let candidate;
        do {
            candidate = `${prefix}-${String(counter).padStart(3, '0')}`;
            counter++;
        } while (elements.some(el => el.id === candidate));
        return candidate;
    }

    function addElement(type) {
        if (!currentZone) return;
        const collectionKey = ELEMENT_COLLECTION_MAP[type];
        if (!collectionKey) return;
        if (!currentFloor) return;
        currentFloor.elements = currentFloor.elements || { extincteurs: [], dm: [], sorties: [] };
        currentFloor.elements[collectionKey] = currentFloor.elements[collectionKey] || [];
        const collection = currentFloor.elements[collectionKey];
        const element = { x: 0.5, y: 0.5 };
        // read default size input if present (percentage), otherwise fallback to 2%
        const sizeInput = document.getElementById('defaultElemSize');
        let defaultSize = 0.02;
        if (sizeInput) {
            const parsed = parseFloat(sizeInput.value);
            if (!isNaN(parsed)) defaultSize = Math.max(0.005, Math.min(0.5, parsed / 100));
        }
        element.size = defaultSize;
        
        if (type !== 'sortie') {
            element.id = generateUniqueElementId(type, collection);
            if (type === 'extincteur') element.type = 'Poudre';
        }
        
        collection.push(element);
        saveZones();
        renderAdminElements();
        renderElementsList();
    }

    function removeElement(type, index) {
        if (!currentZone) return;
        const collectionKey = ELEMENT_COLLECTION_MAP[type];
        if (!currentFloor) return;
        const collection = currentFloor.elements?.[collectionKey];
        if (!collection || !collection[index]) return;
        
        if (!confirm('Supprimer cet √©l√©ment ?')) return;
        
    const [removed] = collection.splice(index, 1);
    const elementKey = getElementKey(type, removed);
    inspections = inspections.filter(ins => !(ins.zoneId === currentZone.id && ins.floorId === (currentFloor?.id || null) && ins.elementKey === elementKey));
        
        saveZones();
        saveInspections();
        renderAdminElements();
        renderElementsList();
    }

    function renderElementsList() {
        const container = document.getElementById('elementsList');
        if (!container || !currentZone) return;
        
        const sections = [
            { type: 'extincteur', label: 'Extincteurs', collectionKey: 'extincteurs' },
            { type: 'dm', label: 'D√©clencheurs Manuels', collectionKey: 'dm' },
            { type: 'sortie', label: 'Sorties de secours', collectionKey: 'sorties' }
        ];
        
        container.innerHTML = sections.map(({ type, label, collectionKey }) => {
            const collection = (currentFloor && currentFloor.elements && currentFloor.elements[collectionKey]) || [];
            const content = collection.length
                ? collection.map((el, idx) => `
                    <div class="border border-gray-200 rounded px-2 py-1 text-xs flex justify-between items-center bg-gray-50">
                        <div class="flex-1">
                            <div class="font-medium">${el.id || `Sortie #${idx + 1}`}${el.type ? ` (${el.type})` : ''}</div>
                            <div class="text-gray-500">X: ${Math.round(el.x * 100)}% Y: ${Math.round(el.y * 100)}% Taille: ${Math.round((el.size || 0.02) * 100)}%</div>
                        </div>
                        <div class="flex gap-1">
                            <button type="button" class="px-2 py-1 bg-yellow-500 text-white rounded text-sm hover:bg-yellow-600" onclick="editElementDialog('${type}', ${idx})">√âditer</button>
                            <button type="button" class="px-2 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700" onclick="removeElement('${type}', ${idx})">Suppr.</button>
                        </div>
                    </div>
                `).join('')
                : '<div class="text-xs text-gray-500 italic">Aucun √©l√©ment</div>';
            
            return `
                <div class="space-y-1">
                    <h4 class="text-xs font-semibold text-gray-700">${label}</h4>
                    <div class="space-y-1">${content}</div>
                </div>
            `;
        }).join('');
    }

    function editElementDialog(type, index) {
        const collectionKey = ELEMENT_COLLECTION_MAP[type];
        if (!currentFloor) return;
        const element = currentFloor.elements[collectionKey][index];
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content max-w-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">√âditer √©l√©ment</h2>
                    <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form onsubmit="saveElementEdit(event, '${type}', ${index})">
                    <div class="space-y-4">
                        ${type === 'sortie' ? '' : `

                            <div>
                                <label class="block text-sm font-medium mb-2">ID</label>
                                <input type="text" id="editElemId" value="${element.id || ''}" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                        `}
                        ${type === 'extincteur' ? `

                            <div>
                                <label class="block text-sm font-medium mb-2">Type</label>
                                <select id="editElemType" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    ${EXTINGUISHER_TYPES.map(t => `<option value="${t}" ${element.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">
                                    üî¢ Quantit√©
                                    <span class="text-xs text-gray-500">(regroupement)</span>
                                </label>
                                <input id="editElemQuantity" type="number" min="1" max="99" value="${element.quantity || 1}"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <p class="text-xs text-gray-500 mt-1">Nombre d'extincteurs √† ce m√™me emplacement</p>
                            </div>
                        ` : ''}

                        <div>
                            <label class="block text-sm font-medium mb-2">Position</label>
                            <div class="flex gap-2">
                                <div class="flex-1">
                                    <label class="text-sm font-medium">X (%)</label>
                                    <input type="number" step="0.01" min="0" max="100" value="${(element.x * 100).toFixed(2)}" 
                                        onchange="updateElementPosition(${index}, 'x', this.value)" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="flex-1">
                                    <label class="text-sm font-medium">Y (%)</label>
                                    <input type="number" step="0.01" min="0" max="100" value="${(element.y * 100).toFixed(2)}" 
                                        onchange="updateElementPosition(${index}, 'y', this.value)" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Taille (%)</label>
                            <input id="editElemSize" type="number" step="0.1" min="0.5" max="50" value="${((element.size || 0.02) * 100).toFixed(2)}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md" />
                        </div>
                    </div>
                    
                    <div class="flex justify-between gap-3 mt-6">
                        <button type="button" onclick="if(confirm('√ätes-vous s√ªr de vouloir supprimer cet √©l√©ment ?')) { removeElement('${type}', ${index}); this.closest('.modal').remove(); }" 
                                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                            Supprimer
                        </button>
                        <div class="flex gap-3">
                            <button type="button" onclick="this.closest('.modal').remove()" 
                                    class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                                Annuler
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Enregistrer
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    function saveElementEdit(event, type, index) {
        event.preventDefault();
        const collectionKey = ELEMENT_COLLECTION_MAP[type];
        if (!currentFloor) return;
        const element = currentFloor.elements[collectionKey][index];
        
        if (type !== 'sortie') {
            element.id = document.getElementById('editElemId').value.trim();
        }
        if (type === 'extincteur') {
            element.type = document.getElementById('editElemType').value;
            
            // Sauvegarder la quantit√©
            const quantityInput = document.getElementById('editElemQuantity');
            if (quantityInput) {
                const qty = parseInt(quantityInput.value);
                if (!isNaN(qty) && qty >= 1) {
                    element.quantity = qty;
                }
            }
        }
        // save size if provided
        const sizeInput = document.getElementById('editElemSize');
        if (sizeInput) {
            const val = parseFloat(sizeInput.value);
            if (!isNaN(val)) {
                element.size = Math.max(0.005, Math.min(0.5, val / 100));
            }
        }
        
        saveZones();
        renderElementsList();
        renderAdminElements();
        event.target.closest('.modal').remove();
    }

    function renderElementCriteriaConfig() {
        if (!currentZone) return;
        
        // Configurer les crit√®res pour chaque type d'√©l√©ment
        ['extincteur', 'dm', 'sortie'].forEach(type => {
            const container = document.getElementById(`${type}CriteriaConfig`);
            if (!container) return;
            
            currentZone.enabledCriteria = currentZone.enabledCriteria || {};
            currentZone.enabledCriteria[type] = currentZone.enabledCriteria[type] || Object.keys(CRITERIA[type] || {});
            
            const criteria = CRITERIA[type] || {};
            const enabledCriteria = currentZone.enabledCriteria[type] || [];
            
            // Compter les crit√®res activ√©s
            const enabledCount = Object.keys(criteria).filter(key => enabledCriteria.includes(key)).length;
            const totalCount = Object.keys(criteria).length;
            
            container.innerHTML = `
                <div class="mb-3 pb-2 border-b border-gray-200">
                    <div class="flex items-center justify-between text-xs text-gray-600">
                        <span class="font-medium">${enabledCount} / ${totalCount} crit√®res activ√©s</span>
                        <div class="flex gap-2">
                            <button onclick="selectAllCriteria('${type}', true)" class="text-blue-600 hover:text-blue-800 font-medium">Tout</button>
                            <span class="text-gray-400">|</span>
                            <button onclick="selectAllCriteria('${type}', false)" class="text-blue-600 hover:text-blue-800 font-medium">Aucun</button>
                        </div>
                    </div>
                </div>
                <div class="space-y-1.5">
                    ${Object.entries(criteria).map(([key, label]) => `
                        <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 transition-colors cursor-pointer group">
                            <input type="checkbox" ${enabledCriteria.includes(key) ? 'checked' : ''}
                                onchange="toggleElementCriterion('${type}', '${key}', this.checked)" 
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer">
                            <span class="text-sm text-gray-700 group-hover:text-gray-900 flex-1">${label}</span>
                            <span class="text-xs ${enabledCriteria.includes(key) ? 'text-green-600' : 'text-gray-400'}">
                                ${enabledCriteria.includes(key) ? '‚úì' : '‚óã'}
                            </span>
                        </label>
                    `).join('')}
                </div>
            `;
        });
    }

    function renderZoneCriteriaConfig() {
        const container = document.getElementById('zoneCriteriaConfig');
        if (!container || !currentZone) return;
        
        currentZone.enabledCriteria = currentZone.enabledCriteria || {};
        currentZone.enabledCriteria.zone = currentZone.enabledCriteria.zone || {};
        
        // Ic√¥nes pour chaque section
        const sectionIcons = {
            'eclairage_securite': 'üí°',
            'signalisation': 'üö∏',
            'desenfumage': 'üí®',
            'compartimentage': 'üß±',
            'ssi': 'üîî',
            'registres': 'üìã'
        };
        
        // Titres fran√ßais pour chaque section
        const sectionTitles = {
            'eclairage_securite': '√âclairage de S√©curit√©',
            'signalisation': 'Signalisation',
            'desenfumage': 'D√©senfumage',
            'compartimentage': 'Compartimentage',
            'ssi': 'Syst√®me de S√©curit√© Incendie',
            'registres': 'Registres & Documents'
        };
        
        container.innerHTML = Object.entries(ZONE_CRITERIA).map(([section, criteria]) => {
            const sectionValues = currentZone.enabledCriteria.zone[section] || [];
            const enabledCount = Object.keys(criteria).filter(key => sectionValues.includes(key)).length;
            const totalCount = Object.keys(criteria).length;
            const icon = sectionIcons[section] || 'üìå';
            const title = sectionTitles[section] || section.replace(/_/g, ' ');
            
            return `
                <div class="border border-gray-200 rounded-lg p-3 bg-gradient-to-br from-gray-50 to-white shadow-sm">
                    <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-200">
                        <h5 class="text-sm font-semibold text-gray-800 flex items-center gap-2">
                            <span>${icon}</span>
                            <span>${title}</span>
                        </h5>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500 font-medium">${enabledCount}/${totalCount}</span>
                            <div class="flex gap-1.5">
                                <button onclick="selectAllZoneCriteria('${section}', true)" 
                                    class="text-xs text-blue-600 hover:text-blue-800 font-medium px-1" 
                                    title="Tout s√©lectionner">‚úì</button>
                                <button onclick="selectAllZoneCriteria('${section}', false)" 
                                    class="text-xs text-gray-500 hover:text-gray-700 font-medium px-1" 
                                    title="Tout d√©s√©lectionner">‚úó</button>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        ${Object.entries(criteria).map(([key, label]) => `
                            <label class="flex items-center gap-2 p-1.5 rounded hover:bg-blue-50 transition-colors cursor-pointer group">
                                <input type="checkbox" ${sectionValues.includes(key) ? 'checked' : ''}
                                    onchange="toggleZoneCriterion('${section}', '${key}', this.checked)" 
                                    class="w-3.5 h-3.5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer">
                                <span class="text-xs text-gray-700 group-hover:text-gray-900 flex-1">${label}</span>
                                <span class="text-xs ${sectionValues.includes(key) ? 'text-green-600 font-bold' : 'text-gray-300'}">
                                    ${sectionValues.includes(key) ? '‚úì' : '‚óã'}
                                </span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('');
    }

    function toggleElementCriterion(type, key, enabled) {
        if (!currentZone) return;
        currentZone.enabledCriteria = currentZone.enabledCriteria || {};
        currentZone.enabledCriteria[type] = currentZone.enabledCriteria[type] || [];
        
        if (enabled) {
            if (!currentZone.enabledCriteria[type].includes(key)) {
                currentZone.enabledCriteria[type].push(key);
            }
        } else {
            currentZone.enabledCriteria[type] = currentZone.enabledCriteria[type].filter(item => item !== key);
        }
        saveZones();
        updateKPIs();
        renderElementCriteriaConfig(); // Re-render pour mettre √† jour le compteur
    }

    function selectAllCriteria(type, selectAll) {
        if (!currentZone) return;
        currentZone.enabledCriteria = currentZone.enabledCriteria || {};
        
        if (selectAll) {
            currentZone.enabledCriteria[type] = Object.keys(CRITERIA[type] || {});
        } else {
            currentZone.enabledCriteria[type] = [];
        }
        
        saveZones();
        updateKPIs();
        renderElementCriteriaConfig();
    }

    function toggleZoneCriterion(section, key, enabled) {
        if (!currentZone) return;
        currentZone.enabledCriteria = currentZone.enabledCriteria || {};
        currentZone.enabledCriteria.zone = currentZone.enabledCriteria.zone || {};
        const sectionValues = currentZone.enabledCriteria.zone[section] = currentZone.enabledCriteria.zone[section] || [];
        
        if (enabled) {
            if (!sectionValues.includes(key)) sectionValues.push(key);
        } else {
            currentZone.enabledCriteria.zone[section] = sectionValues.filter(item => item !== key);
        }
        saveZones();
        updateKPIs();
        renderZoneCriteriaConfig(); // Re-render pour mettre √† jour le compteur
    }

    function selectAllZoneCriteria(section, selectAll) {
        if (!currentZone) return;
        currentZone.enabledCriteria = currentZone.enabledCriteria || {};
        currentZone.enabledCriteria.zone = currentZone.enabledCriteria.zone || {};
        
        if (selectAll) {
            currentZone.enabledCriteria.zone[section] = Object.keys(ZONE_CRITERIA[section] || {});
        } else {
            currentZone.enabledCriteria.zone[section] = [];
        }
        
        saveZones();
        updateKPIs();
        renderZoneCriteriaConfig();
    }

    let adminElementEditForm = null;

    function renderAdminElements() {
        const container = document.getElementById('adminElements');
        if (!container || !currentZone || !currentFloor) return;
        container.innerHTML = '';
        
        const planImage = document.getElementById('adminPlanImage');
        const planWrapper = document.getElementById('adminPlanWrapper');
        if (!planImage || !planWrapper) return;
        
        ['extincteurs', 'dm', 'sorties'].forEach(type => {
            const elements = (currentFloor.elements && currentFloor.elements[type]) || [];
            elements.forEach((element, index) => {
                const adminElement = document.createElement('div');
                const typeShort = type === 'sorties' ? 'sortie' : type === 'extincteurs' ? 'extincteur' : 'dm';
                adminElement.className = `admin-element ${typeShort}`;
                adminElement.dataset.x = element.x;
                adminElement.dataset.y = element.y;
                adminElement.dataset.index = index;
                adminElement.dataset.elementKey = getElementKey(typeShort, element);
                adminElement.dataset.type = typeShort;
                adminElement.dataset.size = String(element.size || 0.02);
                
                // Position initiale
                positionElement(adminElement, element.x, element.y, true);

                // Mark completed state at render time
                try {
                    const insp = getElementInspection(typeShort, element);
                    if (insp && isElementCompleted(insp)) {
                        adminElement.classList.add('completed');
                    } else {
                        adminElement.classList.remove('completed');
                    }
                } catch (e) {
                    // ignore
                }
                
                let isDragging = false;
                let currentX = element.x;
                let currentY = element.y;
                
                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                
                    const planImage = document.getElementById('adminPlanImage');
                    if (!planImage || !planImage.complete || planImage.naturalHeight === 0) return;
                    
                    const imageRect = planImage.getBoundingClientRect();
                    const imgWidth = planImage.offsetWidth;
                    const imgHeight = planImage.offsetHeight;
                    
                    if (!imgWidth || !imgHeight) return;
                    
                    // Calculate position relative to image
                    const relativeX = e.clientX - imageRect.left;
                    const relativeY = e.clientY - imageRect.top;
                    
                    // Convert to fraction (0-1) and clamp to image bounds
                    currentX = Math.max(0, Math.min(1, relativeX / imgWidth));
                    currentY = Math.max(0, Math.min(1, relativeY / imgHeight));
                    
                    positionElement(adminElement, currentX, currentY, true);
                };
                
                const handleMouseUp = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    adminElement.style.cursor = 'move';
                    
                    element.x = currentX;
                    element.y = currentY;
                    adminElement.dataset.x = currentX;
                    adminElement.dataset.y = currentY;
                    
                    saveZones();
                    renderElementsList();
                    // Repositionner apr√®s sauvegarde
                    scheduleReposition(50);
                    
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
                
                adminElement.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return;
                    isDragging = true;
                    adminElement.style.cursor = 'grabbing';
                    e.preventDefault();
                    e.stopPropagation();
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });
                
                // Right-click: open the edit dialog for this element (no mouse resize)
                adminElement.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    editElementDialog(typeShort, index);
                });

                container.appendChild(adminElement);
            });
        });
    }

    function editZone(zoneId) {
        const zone = zones.find(z => z.id === zoneId);
        if (!zone) return;

        currentZone = zone;
        // ensure at least one floor
        currentZone.floors = currentZone.floors && currentZone.floors.length ? currentZone.floors : [{ id: 'RDC', name: 'Rez-de-chauss√©e', plan: { imageUrl: '' }, elements: { extincteurs: [], dm: [], sorties: [] } }];
        currentFloor = currentZone.floors[0];

        const adminContent = document.getElementById('adminContent');
        adminContent.innerHTML = `
            <div class="text-left h-full flex flex-col">
                <div class="flex justify-between items-center mb-6 pb-4 border-b flex-shrink-0">
                    <div class="flex items-center gap-3 flex-1">
                        <div class="flex flex-col gap-2 flex-1">
                            <div class="flex items-center gap-3">
                                <h2 class="text-2xl font-bold">√âdition -</h2>
                                <input type="text" id="editZoneName" value="${zone.name}" 
                                    class="text-2xl font-bold px-3 py-1 border border-gray-300 rounded-md flex-1"
                                    onchange="updateZoneName(this.value)">
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium whitespace-nowrap">ID Zone:</label>
                                <input type="text" id="editZoneId" value="${zone.id}" 
                                    class="px-3 py-1 border border-gray-300 rounded-md text-sm"
                                    onchange="updateZoneId(this.value)">
                                <span class="text-xs text-gray-500">Format fichier: ID_NomEtage.png (ex: ${zone.id}_${currentFloor?.name || 'RDC'}.png)</span>
                            </div>
                        </div>
                    </div>
                    <div class="ml-4">
                        <label class="block text-sm font-medium">Cat√©gorie</label>
                        <select id="editZoneCategory" class="px-2 py-1 border border-gray-300 rounded">
                            <option value="">-- Aucune --</option>
                            <option value="MR" ${zone.category === 'MR' ? 'selected' : ''}>MR</option>
                            <option value="PRM" ${zone.category === 'PRM' ? 'selected' : ''}>PRM</option>
                            <option value="SC" ${zone.category === 'SC' ? 'selected' : ''}>SC</option>
                            <option value="Administratif" ${zone.category === 'Administratif' ? 'selected' : ''}>Administratif</option>
                        </select>
                    </div>
                    <div class="ml-4">
                        <label class="block text-sm font-medium mb-2">Actions group√©es</label>
                        <div class="flex gap-2">
                            <button onclick="bulkUpdateExtinguisherType()" 
                                    class="px-3 py-1.5 bg-orange-500 text-white rounded-md hover:bg-orange-600 text-sm font-medium flex items-center gap-2">
                                üßØ Modifier type extincteurs
                            </button>
                            <button onclick="exportCurrentZone()" 
                                    class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium flex items-center gap-2">
                                üì• Exporter cette zone
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-2 flex-shrink-0">
                        <button onclick="saveAndReturn()" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Enregistrer
                        </button>
                        <button onclick="renderAdminContent()" 
                                class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                            Retour
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 flex-1 overflow-hidden">
                    <div class="xl:col-span-2 flex flex-col overflow-hidden">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold">Plan de la Zone</h3>
                            <div class="flex items-center gap-2">
                                <select id="adminFloorSelect" class="px-2 py-1 border border-gray-200 rounded text-sm"></select>
                                <button type="button" onclick="editFloorName()" class="px-2 py-1 bg-blue-500 text-white rounded text-xs" title="Modifier le nom de l'√©tage">‚úèÔ∏è</button>
                                <button type="button" onclick="addFloor()" class="px-2 py-1 bg-gray-200 rounded text-xs">+ Etage</button>
                            </div>
                        </div>
                        <div class="plan-container admin-mode mb-4 flex-1 overflow-auto" id="adminPlanContainer">
                            <div id="adminPlanWrapper" class="plan-wrapper">
                                <img src="${(currentFloor && currentFloor.plan && currentFloor.plan.imageUrl) ? currentFloor.plan.imageUrl : ''}" class="plan-image" id="adminPlanImage">
                                <div id="adminElements"></div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Modifier le plan</label>
                                <input type="file" accept="image/*" onchange="updateZonePlan(event)" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <p class="text-xs text-gray-500 mt-1" id="planFileHint">
                                    Convention de nommage recommand√©e : <strong id="planFileExample"></strong>
                                </p>
                            </div>
                            
                            <div class="flex flex-col gap-2">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm">Taille par d√©faut (%):</label>
                                    <input id="defaultElemSize" type="number" step="0.1" min="0.5" max="50" value="3"
                                        class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" />
                                </div>
                                <button type="button" onclick="addElement('extincteur')" 
                                        class="w-full px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                                    + Ajouter Extincteur
                                </button>
                                <button type="button" onclick="addElement('dm')" 
                                        class="w-full px-3 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm">
                                    + Ajouter DM
                                </button>
                                <button type="button" onclick="addElement('sortie')" 
                                        class="w-full px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                                    + Ajouter Sortie
                                </button>
                            </div>
                            
                            <div class="border-t pt-4">
                                <h4 class="font-semibold mb-3 text-sm">Actions Zone</h4>
                                <div class="flex flex-col gap-2">
                                    <button type="button" onclick="duplicateZone()" 
                                            class="w-full px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm">
                                        üîÑ Dupliquer Zone
                                    </button>
                                    <button type="button" onclick="clearAllElements()" 
                                            class="w-full px-3 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 text-sm">
                                        üóëÔ∏è Vider √âl√©ments
                                    </button>
                                    <button type="button" onclick="deleteZone()" 
                                            class="w-full px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                        ‚ùå Supprimer Zone
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col overflow-hidden">
                        <!-- √âl√©ments du plan -->
                        <div class="mb-4">
                            <h3 class="font-semibold text-base mb-3 flex items-center gap-2">
                                <span>üìç</span> √âl√©ments
                            </h3>
                            <div id="elementsList" class="space-y-2 overflow-y-auto max-h-64 border border-gray-200 rounded-lg p-3 bg-gray-50">
                            </div>
                        </div>
                        
                        <!-- Configuration des Crit√®res -->
                        <div class="flex-1 overflow-hidden flex flex-col">
                            <h3 class="font-semibold text-base mb-3 flex items-center gap-2">
                                <span>‚öôÔ∏è</span> Configuration des Crit√®res
                            </h3>
                            
                            <div class="flex-1 overflow-y-auto space-y-2">
                                <!-- Crit√®res Extincteurs -->
                                <details class="group border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm" open>
                                    <summary class="cursor-pointer bg-gradient-to-r from-red-50 to-red-100 hover:from-red-100 hover:to-red-200 px-4 py-3 font-semibold text-sm flex items-center justify-between transition-colors">
                                        <span class="flex items-center gap-2">
                                            <span class="text-red-600">üßØ</span>
                                            <span class="text-red-800">Extincteurs</span>
                                        </span>
                                        <span class="text-xs text-gray-500 group-open:rotate-180 transition-transform">‚ñº</span>
                                    </summary>
                                    <div class="p-4 bg-white">
                                        <div id="extincteurCriteriaConfig" class="space-y-2"></div>
                                    </div>
                                </details>
                                
                                <!-- Crit√®res DM -->
                                <details class="group border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm" open>
                                    <summary class="cursor-pointer bg-gradient-to-r from-yellow-50 to-yellow-100 hover:from-yellow-100 hover:to-yellow-200 px-4 py-3 font-semibold text-sm flex items-center justify-between transition-colors">
                                        <span class="flex items-center gap-2">
                                            <span class="text-yellow-600">üö®</span>
                                            <span class="text-yellow-800">D√©clencheurs Manuels</span>
                                        </span>
                                        <span class="text-xs text-gray-500 group-open:rotate-180 transition-transform">‚ñº</span>
                                    </summary>
                                    <div class="p-4 bg-white">
                                        <div id="dmCriteriaConfig" class="space-y-2"></div>
                                    </div>
                                </details>
                                
                                <!-- Crit√®res Sorties -->
                                <details class="group border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm" open>
                                    <summary class="cursor-pointer bg-gradient-to-r from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 px-4 py-3 font-semibold text-sm flex items-center justify-between transition-colors">
                                        <span class="flex items-center gap-2">
                                            <span class="text-green-600">üö™</span>
                                            <span class="text-green-800">Sorties de Secours</span>
                                        </span>
                                        <span class="text-xs text-gray-500 group-open:rotate-180 transition-transform">‚ñº</span>
                                    </summary>
                                    <div class="p-4 bg-white">
                                        <div id="sortieCriteriaConfig" class="space-y-2"></div>
                                    </div>
                                </details>
                                
                                <!-- Crit√®res Zone -->
                                <details class="group border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm" open>
                                    <summary class="cursor-pointer bg-gradient-to-r from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 px-4 py-3 font-semibold text-sm flex items-center justify-between transition-colors">
                                        <span class="flex items-center gap-2">
                                            <span class="text-blue-600">üè¢</span>
                                            <span class="text-blue-800">Zone Globale</span>
                                        </span>
                                        <span class="text-xs text-gray-500 group-open:rotate-180 transition-transform">‚ñº</span>
                                    </summary>
                                    <div class="p-4 bg-white">
                                        <div id="zoneCriteriaConfig" class="space-y-3"></div>
                                    </div>
                                </details>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Variable pour stocker l'intervalle de reposition
        let adminEditRepositionInterval = null;

        // Attendre que le DOM soit pr√™t et que l'image soit charg√©e
        setTimeout(() => {
            const adminImg = document.getElementById('adminPlanImage');
            const adminContainer = document.getElementById('adminPlanContainer');
            const adminWrapper = document.getElementById('adminPlanWrapper');
            
            if (adminImg && adminContainer && adminWrapper) {
                // Fonction pour v√©rifier si les dimensions sont valides et stables
                const waitForValidDimensions = (callback, maxAttempts = 50) => {
                    let attempts = 0;
                    let consecutiveValid = 0;
                    let lastWidth = 0;
                    let lastHeight = 0;
                    
                    const check = () => {
                        // V√©rifier √† la fois l'image et le wrapper
                        const imgWidth = adminImg.offsetWidth;
                        const imgHeight = adminImg.offsetHeight;
                        const wrapperWidth = adminWrapper.offsetWidth;
                        const wrapperHeight = adminWrapper.offsetHeight;
                        
                        // Les dimensions doivent √™tre valides (>0)
                        const isValid = imgWidth > 0 && imgHeight > 0 && 
                                       wrapperWidth > 0 && wrapperHeight > 0;
                        
                        // Les dimensions doivent √™tre stables
                        const isStable = imgWidth === lastWidth && imgHeight === lastHeight;
                        
                        if (isValid && isStable) {
                            consecutiveValid++;
                            // Attendre 3 frames cons√©cutifs identiques pour √™tre s√ªr
                            if (consecutiveValid >= 3) {
                                callback();
                                return;
                            }
                        } else {
                            consecutiveValid = 0;
                        }
                        
                        lastWidth = imgWidth;
                        lastHeight = imgHeight;
                        attempts++;
                        
                        if (attempts < maxAttempts) {
                            requestAnimationFrame(check);
                        } else {
                            // Fallback: forcer le repositionnement m√™me si pas stable
                            callback();
                        }
                    };
                    
                    // D√©marrer la v√©rification
                    requestAnimationFrame(check);
                };
                
                // Fonction pour setup apr√®s que les dimensions soient stables
                const setupPositioning = () => {
                    renderAdminFloorSelector();
                    renderAdminElements();
                    renderElementsList();
                    renderElementCriteriaConfig();
                    renderZoneCriteriaConfig();
                    updatePlanFileHint();
                    
                    // Attendre que les dimensions soient stables avant de positionner
                    waitForValidDimensions(() => {
                        // Repositionner tous les √©l√©ments
                        repositionHotspots();
                        
                        // Double-check apr√®s un court d√©lai
                        setTimeout(() => {
                            repositionHotspots();
                        }, 100);
                    });
                };
                
                if (adminImg.complete && adminImg.naturalHeight !== 0) {
                    // Image d√©j√† charg√©e
                    setupPositioning();
                } else {
                    // Attendre le chargement de l'image
                    adminImg.onload = setupPositioning;
                    // Fallback si onload ne se d√©clenche pas
                    setTimeout(setupPositioning, 500);
                }
                
                // Observer de scroll pour repositionner en temps r√©el
                adminContainer.addEventListener('scroll', () => {
                    scheduleReposition(50);
                }, { passive: true });
                
                // Observer de resize du conteneur
                const containerObserver = new ResizeObserver(() => {
                    scheduleReposition(100);
                });
                containerObserver.observe(adminContainer);
                
                // Observer de resize de l'image elle-m√™me
                const imgObserver = new ResizeObserver(() => {
                    scheduleReposition(80);
                });
                imgObserver.observe(adminImg);
            }
        }, 50);
    }

    function renderAdminFloorSelector() {
        const sel = document.getElementById('adminFloorSelect');
        if (!sel || !currentZone) return;
        sel.innerHTML = (currentZone.floors || []).map(f => `<option value="${f.id}" ${currentFloor && currentFloor.id === f.id ? 'selected' : ''}>${f.name || f.id}</option>`).join('');
        sel.onchange = (e) => {
            const id = e.target.value;
            const floor = (currentZone.floors || []).find(fi => fi.id === id);
            if (floor) {
                currentFloor = floor;
                const adminImg = document.getElementById('adminPlanImage');
                if (adminImg) adminImg.src = currentFloor.plan?.imageUrl || '';
                renderAdminElements();
                renderElementsList();
                updatePlanFileHint();
            }
        };
        updatePlanFileHint();
    }
    
    function updatePlanFileHint() {
        if (!currentZone || !currentFloor) return;
        
        const fileName = `${currentZone.id}_${currentFloor.name}.png`;
        
        // Mettre √† jour l'exemple sous le champ de plan
        const exampleEl = document.getElementById('planFileExample');
        if (exampleEl) {
            exampleEl.textContent = fileName;
        }
        
        // Mettre √† jour l'exemple dans l'en-t√™te
        const headerHint = document.querySelector('.text-xs.text-gray-500');
        if (headerHint && headerHint.textContent.includes('Format fichier:')) {
            headerHint.textContent = `Format fichier: ID_NomEtage.png (ex: ${fileName})`;
        }
    }

    function addFloor() {
        if (!currentZone) return;
        const newId = `F${(currentZone.floors||[]).length+1}`;
        const floor = { id: newId, name: `Etage ${ (currentZone.floors||[]).length + 1 }`, plan: { imageUrl: '' }, elements: { extincteurs: [], dm: [], sorties: [] } };
        currentZone.floors = currentZone.floors || [];
        currentZone.floors.push(floor);
        currentFloor = floor;
        saveZones();
        renderAdminFloorSelector();
        renderAdminElements();
        renderElementsList();
        updatePlanFileHint();
    }
    
    function editFloorName() {
        if (!currentZone || !currentFloor) return;
        
        const newName = prompt(`Modifier le nom de l'√©tage "${currentFloor.name}" :\n(Ce nom sera utilis√© dans le nom du fichier image)\nUtilisez des caract√®res compatibles avec les noms de fichiers.`, currentFloor.name);
        
        if (newName && newName.trim() !== '') {
            const oldName = currentFloor.name;
            const cleanedName = newName.trim();
            currentFloor.name = cleanedName;
            saveZones();
            renderAdminFloorSelector();
            updatePlanFileHint();
            
            // Afficher un exemple avec le nom nettoy√©
            const fileExample = `${currentZone.id}_${cleanedName}.png`;
            alert(`Nom de l'√©tage modifi√© de "${oldName}" vers "${cleanedName}".\n\nNom de fichier image recommand√© :\n${fileExample}`);
        }
    }

    function removeFloor(floorId) {
        if (!currentZone) return;
        if (!confirm('Supprimer cet √©tage et ses √©l√©ments ?')) return;
        currentZone.floors = (currentZone.floors || []).filter(f => f.id !== floorId);
        currentFloor = currentZone.floors[0] || null;
        saveZones();
        renderAdminFloorSelector();
        renderAdminElements();
        renderElementsList();
    }

            function saveAndReturn() {
                const newName = document.getElementById('editZoneName')?.value;
                const newId = document.getElementById('editZoneId')?.value;
                const newCategory = document.getElementById('editZoneCategory')?.value;
                
                if (currentZone) {
                    if (newName) updateZoneName(newName);
                    if (newId && newId !== currentZone.id) updateZoneId(newId);
                    if (newCategory !== undefined) currentZone.category = newCategory || '';
                    saveZones();
                }
                renderAdminContent();
                renderAdminZoneList();
            }

            function duplicateZone() {
                if (!currentZone) return;
                
                const newId = `${currentZone.id}_copy_${Date.now()}`;
                const newName = `${currentZone.name} (Copie)`;
                
                const duplicatedZone = {
                    ...JSON.parse(JSON.stringify(currentZone)), // Deep copy
                    id: newId,
                    name: newName
                };
                
                zones.push(duplicatedZone);
                saveZones();
                renderAdminZoneList();
                alert(`Zone "${newName}" cr√©√©e avec succ√®s!`);
            }

            function clearAllElements() {
                if (!currentZone) return;
                
                if (!confirm('√ätes-vous s√ªr de vouloir supprimer tous les √©l√©ments de cette zone ?')) return;
                if (!currentFloor) return;
                currentFloor.elements = { extincteurs: [], dm: [], sorties: [] };
                
                saveZones();
                renderAdminElements();
                renderElementsList();
                alert('Tous les √©l√©ments ont √©t√© supprim√©s.');
            }

            function deleteZone() {
                if (!currentZone) return;
                
                if (!confirm(`√ätes-vous s√ªr de vouloir supprimer d√©finitivement la zone "${currentZone.name}" ?`)) return;
                
                // Supprimer la zone
                zones = zones.filter(z => z.id !== currentZone.id);
                
                // Supprimer toutes les inspections li√©es
                inspections = inspections.filter(i => i.zoneId !== currentZone.id);
                
                saveZones();
                saveInspections();
                renderAdminZoneList();
                renderAdminContent();
                
                alert(`Zone "${currentZone.name}" supprim√©e avec succ√®s.`);
                currentZone = null;
            }

            // Remove photo function
            function removePhoto(index) {
                if (!currentElement) return;
                const inspection = getElementInspection(currentElement.type, currentElement.data);
                if (inspection && inspection.photos) {
                    inspection.photos.splice(index, 1);
                    saveInspections();
                    renderNotationPanel();
                }
            }

            function updateElementPosition(index, axis, value) {
                        // Update element position or size from the edit dialog inputs
                                if (!currentFloor) return;
                                // Try to find which collection the index refers to by searching the three collections
                                const collections = ['extincteurs','dm','sorties'];
                                let found = false;
                                for (const col of collections) {
                                    const arr = currentFloor.elements[col] || [];
                                    if (arr[index]) {
                                        const el = arr[index];
                                        if (axis === 'x') el.x = Math.max(0, Math.min(1, parseFloat(value) / 100 || 0));
                                        if (axis === 'y') el.y = Math.max(0, Math.min(1, parseFloat(value) / 100 || 0));
                                        if (axis === 'size') el.size = Math.max(0.005, Math.min(0.5, parseFloat(value) / 100 || 0.02));
                                        // persist and update UI
                                        saveZones();
                                        renderAdminElements();
                                        renderElementsList();
                                        found = true;
                                        break;
                                    }
                                }
                        if (!found) {
                            // index not found - ignore
                        }
            }

            // (mouse-based resize removed; resizing is done only via the edit dialog)

            // Initialize the application
            init();
        </script>
    </body>
</html>
